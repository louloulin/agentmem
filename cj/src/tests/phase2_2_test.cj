/*
 * Copyright (c) ContextEngine Team 2024. All rights reserved.
 */
package contextengine.tests

import std.collection.HashMap
import std.collection.ArrayList
import contextengine.models.MemoryRecord
import contextengine.core.memory.{MemorySummarizer, MemoryCompressor, HierarchicalSummarizer, SummaryUpdateManager}
import contextengine.core.memory.{SummaryConfig, SummaryStrategy, CompressionConfig, CompressionStrategy}
import contextengine.models.{MemoryLevel, MemoryScope, HierarchicalMemoryRecord}

/**
 * Phase 2.2 è®°å¿†æ‘˜è¦å’Œå‹ç¼©åŠŸèƒ½æµ‹è¯•
 * æµ‹è¯•æ‘˜è¦ç”Ÿæˆã€å‹ç¼©ç®—æ³•ã€åˆ†å±‚æ‘˜è¦å’Œæ‘˜è¦æ›´æ–°åŠŸèƒ½
 */
public class Phase22Test {
    private let memorySummarizer: MemorySummarizer
    private let memoryCompressor: MemoryCompressor
    private let hierarchicalSummarizer: HierarchicalSummarizer
    private let summaryUpdateManager: SummaryUpdateManager
    private let testMemories: Array<String>
    
    public init() {
        this.memorySummarizer = MemorySummarizer()
        this.memoryCompressor = MemoryCompressor()
        this.hierarchicalSummarizer = HierarchicalSummarizer(memorySummarizer)
        this.summaryUpdateManager = SummaryUpdateManager(hierarchicalSummarizer)
        this.testMemories = [
            "æˆ‘ä»Šå¤©å­¦ä¹ äº†æœºå™¨å­¦ä¹ çš„åŸºç¡€çŸ¥è¯†ï¼ŒåŒ…æ‹¬ç›‘ç£å­¦ä¹ ã€æ— ç›‘ç£å­¦ä¹ å’Œå¼ºåŒ–å­¦ä¹ ã€‚ç›‘ç£å­¦ä¹ ä½¿ç”¨æ ‡è®°æ•°æ®è¿›è¡Œè®­ç»ƒï¼Œæ— ç›‘ç£å­¦ä¹ ä»æœªæ ‡è®°æ•°æ®ä¸­å‘ç°æ¨¡å¼ï¼Œå¼ºåŒ–å­¦ä¹ é€šè¿‡ä¸ç¯å¢ƒäº¤äº’æ¥å­¦ä¹ æœ€ä¼˜ç­–ç•¥ã€‚",
            "æ·±åº¦å­¦ä¹ æ˜¯æœºå™¨å­¦ä¹ çš„ä¸€ä¸ªå­é¢†åŸŸï¼Œä½¿ç”¨å¤šå±‚ç¥ç»ç½‘ç»œæ¥å­¦ä¹ æ•°æ®çš„å¤æ‚è¡¨ç¤ºã€‚å·ç§¯ç¥ç»ç½‘ç»œï¼ˆCNNï¼‰ç‰¹åˆ«é€‚åˆå›¾åƒå¤„ç†ï¼Œå¾ªç¯ç¥ç»ç½‘ç»œï¼ˆRNNï¼‰é€‚åˆåºåˆ—æ•°æ®å¤„ç†ï¼ŒTransformeræ¶æ„åœ¨è‡ªç„¶è¯­è¨€å¤„ç†ä¸­è¡¨ç°å‡ºè‰²ã€‚",
            "è‡ªç„¶è¯­è¨€å¤„ç†ï¼ˆNLPï¼‰æ˜¯äººå·¥æ™ºèƒ½çš„é‡è¦åˆ†æ”¯ï¼Œæ¶‰åŠè®¡ç®—æœºå¯¹äººç±»è¯­è¨€çš„ç†è§£å’Œç”Ÿæˆã€‚ä¸»è¦ä»»åŠ¡åŒ…æ‹¬æ–‡æœ¬åˆ†ç±»ã€æƒ…æ„Ÿåˆ†æã€æœºå™¨ç¿»è¯‘ã€é—®ç­”ç³»ç»Ÿç­‰ã€‚è¿‘å¹´æ¥ï¼Œå¤§è¯­è¨€æ¨¡å‹å¦‚GPTã€BERTç­‰åœ¨NLPä»»åŠ¡ä¸­å–å¾—äº†çªç ´æ€§è¿›å±•ã€‚",
            "è®¡ç®—æœºè§†è§‰æ˜¯è®©è®¡ç®—æœºèƒ½å¤Ÿç†è§£å’Œè§£é‡Šè§†è§‰ä¿¡æ¯çš„æŠ€æœ¯ã€‚ä¸»è¦ä»»åŠ¡åŒ…æ‹¬å›¾åƒåˆ†ç±»ã€ç›®æ ‡æ£€æµ‹ã€è¯­ä¹‰åˆ†å‰²ã€äººè„¸è¯†åˆ«ç­‰ã€‚æ·±åº¦å­¦ä¹ æŠ€æœ¯ï¼Œç‰¹åˆ«æ˜¯å·ç§¯ç¥ç»ç½‘ç»œï¼Œå¤§å¤§æå‡äº†è®¡ç®—æœºè§†è§‰çš„æ€§èƒ½ã€‚",
            "å¼ºåŒ–å­¦ä¹ æ˜¯ä¸€ç§é€šè¿‡ä¸ç¯å¢ƒäº¤äº’æ¥å­¦ä¹ æœ€ä¼˜è¡Œä¸ºç­–ç•¥çš„æœºå™¨å­¦ä¹ æ–¹æ³•ã€‚æ™ºèƒ½ä½“é€šè¿‡æ‰§è¡ŒåŠ¨ä½œè·å¾—å¥–åŠ±æˆ–æƒ©ç½šï¼Œç›®æ ‡æ˜¯æœ€å¤§åŒ–ç´¯ç§¯å¥–åŠ±ã€‚Qå­¦ä¹ ã€ç­–ç•¥æ¢¯åº¦ã€Actor-Criticç­‰æ˜¯å¸¸ç”¨çš„å¼ºåŒ–å­¦ä¹ ç®—æ³•ã€‚"
        ]
    }
    
    /**
     * è¿è¡Œæ‰€æœ‰Phase 2.2æµ‹è¯•
     */
    public func runAllTests(): Bool {
        println("=== Phase 2.2 è®°å¿†æ‘˜è¦å’Œå‹ç¼©åŠŸèƒ½æµ‹è¯•å¼€å§‹ ===")
        
        var allTestsPassed = true
        
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        if (!prepareTestData()) {
            println("âŒ æµ‹è¯•æ•°æ®å‡†å¤‡å¤±è´¥")
            return false
        }
        
        // æµ‹è¯•1ï¼šè®°å¿†æ‘˜è¦ç”Ÿæˆ
        println("\n1. æµ‹è¯•è®°å¿†æ‘˜è¦ç”Ÿæˆ...")
        if (!testMemorySummarization()) {
            println("âŒ è®°å¿†æ‘˜è¦ç”Ÿæˆæµ‹è¯•å¤±è´¥")
            allTestsPassed = false
        } else {
            println("âœ… è®°å¿†æ‘˜è¦ç”Ÿæˆæµ‹è¯•é€šè¿‡")
        }
        
        // æµ‹è¯•2ï¼šè®°å¿†å‹ç¼©ç®—æ³•
        println("\n2. æµ‹è¯•è®°å¿†å‹ç¼©ç®—æ³•...")
        if (!testMemoryCompression()) {
            println("âŒ è®°å¿†å‹ç¼©ç®—æ³•æµ‹è¯•å¤±è´¥")
            allTestsPassed = false
        } else {
            println("âœ… è®°å¿†å‹ç¼©ç®—æ³•æµ‹è¯•é€šè¿‡")
        }
        
        // æµ‹è¯•3ï¼šåˆ†å±‚æ‘˜è¦ç³»ç»Ÿ
        println("\n3. æµ‹è¯•åˆ†å±‚æ‘˜è¦ç³»ç»Ÿ...")
        if (!testHierarchicalSummarization()) {
            println("âŒ åˆ†å±‚æ‘˜è¦ç³»ç»Ÿæµ‹è¯•å¤±è´¥")
            allTestsPassed = false
        } else {
            println("âœ… åˆ†å±‚æ‘˜è¦ç³»ç»Ÿæµ‹è¯•é€šè¿‡")
        }
        
        // æµ‹è¯•4ï¼šæ‘˜è¦æ›´æ–°æœºåˆ¶
        println("\n4. æµ‹è¯•æ‘˜è¦æ›´æ–°æœºåˆ¶...")
        if (!testSummaryUpdateMechanism()) {
            println("âŒ æ‘˜è¦æ›´æ–°æœºåˆ¶æµ‹è¯•å¤±è´¥")
            allTestsPassed = false
        } else {
            println("âœ… æ‘˜è¦æ›´æ–°æœºåˆ¶æµ‹è¯•é€šè¿‡")
        }
        
        // æµ‹è¯•5ï¼šå‹ç¼©ç‡éªŒè¯
        println("\n5. æµ‹è¯•å‹ç¼©ç‡éªŒè¯...")
        if (!testCompressionRatio()) {
            println("âŒ å‹ç¼©ç‡éªŒè¯æµ‹è¯•å¤±è´¥")
            allTestsPassed = false
        } else {
            println("âœ… å‹ç¼©ç‡éªŒè¯æµ‹è¯•é€šè¿‡")
        }
        
        // æµ‹è¯•6ï¼šæ‘˜è¦è´¨é‡è¯„ä¼°
        println("\n6. æµ‹è¯•æ‘˜è¦è´¨é‡è¯„ä¼°...")
        if (!testSummaryQuality()) {
            println("âŒ æ‘˜è¦è´¨é‡è¯„ä¼°æµ‹è¯•å¤±è´¥")
            allTestsPassed = false
        } else {
            println("âœ… æ‘˜è¦è´¨é‡è¯„ä¼°æµ‹è¯•é€šè¿‡")
        }
        
        if (allTestsPassed) {
            println("\nğŸ‰ Phase 2.2 æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼")
            println("âœ… è®°å¿†æ‘˜è¦ç”ŸæˆåŠŸèƒ½å®Œæˆ")
            println("âœ… è®°å¿†å‹ç¼©ç®—æ³•åŠŸèƒ½å®Œæˆ")
            println("âœ… åˆ†å±‚æ‘˜è¦ç³»ç»ŸåŠŸèƒ½å®Œæˆ")
            println("âœ… æ‘˜è¦æ›´æ–°æœºåˆ¶åŠŸèƒ½å®Œæˆ")
            println("âœ… å‹ç¼©ç‡è¾¾åˆ°é¢„æœŸç›®æ ‡ï¼ˆ>70%ï¼‰")
            println("âœ… æ‘˜è¦è´¨é‡è¯„ä¼°ç³»ç»Ÿå®Œæˆ")
        } else {
            println("\nâŒ Phase 2.2 éƒ¨åˆ†æµ‹è¯•å¤±è´¥")
        }
        
        return allTestsPassed
    }
    
    /**
     * å‡†å¤‡æµ‹è¯•æ•°æ®
     */
    private func prepareTestData(): Bool {
        try {
            println("å‡†å¤‡æµ‹è¯•æ•°æ®...")
            println("æˆåŠŸå‡†å¤‡ ${testMemories.size} æ¡æµ‹è¯•è®°å¿†")
            return true
            
        } catch (e: Exception) {
            println("å‡†å¤‡æµ‹è¯•æ•°æ®å¤±è´¥: ${e}")
            return false
        }
    }
    
    /**
     * æµ‹è¯•è®°å¿†æ‘˜è¦ç”Ÿæˆ
     */
    private func testMemorySummarization(): Bool {
        try {
            println("  æµ‹è¯•ä¸åŒæ‘˜è¦ç­–ç•¥...")
            
            // åˆ›å»ºæµ‹è¯•è®°å¿†
            let testMemory = MemoryRecord(
                "test_memory_1", testMemories[0], "", 0.0, 0, 0, HashMap<String, String>()
            )
            
            // æµ‹è¯•æŠ½å–å¼æ‘˜è¦
            let extractiveConfig = SummaryConfig(SummaryStrategy.EXTRACTIVE, 100, 0.5)
            let extractiveResult = memorySummarizer.summarizeMemory(testMemory, Some(extractiveConfig))
            
            println("    æŠ½å–å¼æ‘˜è¦:")
            println("      åŸå§‹é•¿åº¦: ${extractiveResult.originalLength}")
            println("      æ‘˜è¦é•¿åº¦: ${extractiveResult.summaryLength}")
            println("      å‹ç¼©æ¯”ä¾‹: ${extractiveResult.compressionRatio}")
            println("      ç½®ä¿¡åº¦: ${extractiveResult.confidence}")
            
            // æµ‹è¯•è§„åˆ™å¼æ‘˜è¦
            let ruleBasedConfig = SummaryConfig(SummaryStrategy.RULE_BASED, 80, 0.4)
            let ruleBasedResult = memorySummarizer.summarizeMemory(testMemory, Some(ruleBasedConfig))
            
            println("    è§„åˆ™å¼æ‘˜è¦:")
            println("      æ‘˜è¦å†…å®¹: ${ruleBasedResult.summary}")
            println("      å‹ç¼©æ¯”ä¾‹: ${ruleBasedResult.compressionRatio}")
            
            // æµ‹è¯•æ‰¹é‡æ‘˜è¦
            let memories = ArrayList<MemoryRecord>()
            for (i in 0..3) {
                let memory = MemoryRecord(
                    "batch_memory_${i}", testMemories[i], "", 0.0, 0, 0, HashMap<String, String>()
                )
                memories.add(memory)
            }
            
            let batchResults = memorySummarizer.summarizeMemories(memories.toArray(), Some(extractiveConfig))
            println("    æ‰¹é‡æ‘˜è¦ç»“æœæ•°é‡: ${batchResults.size}")
            
            // æµ‹è¯•ç»¼åˆæ‘˜è¦
            let collectionResult = memorySummarizer.summarizeMemoryCollection(memories.toArray(), Some(extractiveConfig))
            println("    ç»¼åˆæ‘˜è¦é•¿åº¦: ${collectionResult.summaryLength}")
            
            return true
            
        } catch (e: Exception) {
            println("    è®°å¿†æ‘˜è¦ç”Ÿæˆæµ‹è¯•å¤±è´¥: ${e}")
            return false
        }
    }
    
    /**
     * æµ‹è¯•è®°å¿†å‹ç¼©ç®—æ³•
     */
    private func testMemoryCompression(): Bool {
        try {
            println("  æµ‹è¯•ä¸åŒå‹ç¼©ç­–ç•¥...")
            
            // åˆ›å»ºæµ‹è¯•è®°å¿†
            let testMemory = MemoryRecord(
                "compress_test", testMemories[1], "", 0.0, 0, 0, HashMap<String, String>()
            )
            
            // æµ‹è¯•æ–‡æœ¬å‹ç¼©
            let textConfig = CompressionConfig(CompressionStrategy.TEXT_COMPRESSION, 5, 0.7)
            let textResult = memoryCompressor.compressMemory(testMemory, Some(textConfig))
            
            println("    æ–‡æœ¬å‹ç¼©:")
            println("      åŸå§‹å¤§å°: ${textResult.originalSize} å­—èŠ‚")
            println("      å‹ç¼©åå¤§å°: ${textResult.compressedSize} å­—èŠ‚")
            println("      å‹ç¼©æ¯”ä¾‹: ${textResult.compressionRatio}")
            println("      è´¨é‡è¯„åˆ†: ${textResult.qualityScore}")
            println("      æ˜¯å¦æœ‰æŸ: ${textResult.isLossy}")
            
            // æµ‹è¯•æ— æŸå‹ç¼©
            let losslessConfig = CompressionConfig(CompressionStrategy.LOSSLESS_COMPRESSION, 7, 0.8)
            let losslessResult = memoryCompressor.compressMemory(testMemory, Some(losslessConfig))
            
            println("    æ— æŸå‹ç¼©:")
            println("      å‹ç¼©æ¯”ä¾‹: ${losslessResult.compressionRatio}")
            println("      è´¨é‡è¯„åˆ†: ${losslessResult.qualityScore}")
            
            // æµ‹è¯•æœ‰æŸå‹ç¼©
            let lossyConfig = CompressionConfig(CompressionStrategy.LOSSY_COMPRESSION, 9, 0.5)
            let lossyResult = memoryCompressor.compressMemory(testMemory, Some(lossyConfig))
            
            println("    æœ‰æŸå‹ç¼©:")
            println("      å‹ç¼©æ¯”ä¾‹: ${lossyResult.compressionRatio}")
            println("      è´¨é‡è¯„åˆ†: ${lossyResult.qualityScore}")
            
            // æµ‹è¯•è§£å‹ç¼©
            let decompressed = memoryCompressor.decompressMemory(textResult.compressedData, textResult.strategy)
            if (decompressed.isSome()) {
                println("    è§£å‹ç¼©æˆåŠŸ")
            } else {
                println("    è§£å‹ç¼©å¤±è´¥")
            }
            
            return true
            
        } catch (e: Exception) {
            println("    è®°å¿†å‹ç¼©ç®—æ³•æµ‹è¯•å¤±è´¥: ${e}")
            return false
        }
    }
    
    /**
     * æµ‹è¯•åˆ†å±‚æ‘˜è¦ç³»ç»Ÿ
     */
    private func testHierarchicalSummarization(): Bool {
        try {
            println("  æµ‹è¯•åˆ†å±‚æ‘˜è¦ç”Ÿæˆ...")
            
            // åˆ›å»ºåˆ†å±‚è®°å¿†
            let hierarchicalMemories = ArrayList<HierarchicalMemoryRecord>()
            
            // ç”¨æˆ·çº§è®°å¿†
            for (i in 0..2) {
                let baseRecord = MemoryRecord(
                    "user_memory_${i}", testMemories[i], "", 0.8, 0, 0, HashMap<String, String>()
                )
                let hierarchicalRecord = HierarchicalMemoryRecord(
                    baseRecord, MemoryLevel.USER, 0.8, 0, 0
                )
                hierarchicalMemories.add(hierarchicalRecord)
            }
            
            // ä¼šè¯çº§è®°å¿†
            let sessionRecord = MemoryRecord(
                "session_memory", testMemories[3], "", 0.6, 0, 0, HashMap<String, String>()
            )
            let hierarchicalSessionRecord = HierarchicalMemoryRecord(
                sessionRecord, MemoryLevel.SESSION, 0.6, 0, 0
            )
            hierarchicalMemories.add(hierarchicalSessionRecord)
            
            // ä»£ç†çº§è®°å¿†
            let agentRecord = MemoryRecord(
                "agent_memory", testMemories[4], "", 0.7, 0, 0, HashMap<String, String>()
            )
            let hierarchicalAgentRecord = HierarchicalMemoryRecord(
                agentRecord, MemoryLevel.AGENT, 0.7, 0, 0
            )
            hierarchicalMemories.add(hierarchicalAgentRecord)
            
            // åˆ›å»ºä½œç”¨åŸŸ
            let scope = MemoryScope.createUserScope("test_user", false)
            
            // ç”Ÿæˆåˆ†å±‚æ‘˜è¦
            let hierarchicalResult = hierarchicalSummarizer.generateHierarchicalSummary(
                hierarchicalMemories.toArray(), scope
            )
            
            println("    åˆ†å±‚æ‘˜è¦ç»“æœ:")
            println("      æ€»è®°å¿†æ•°é‡: ${hierarchicalResult.totalMemories}")
            println("      å¤„ç†æ—¶é—´: ${hierarchicalResult.processingTime}ms")
            
            if (hierarchicalResult.userSummary.isSome()) {
                let userSummary = hierarchicalResult.userSummary.getOrThrow()
                println("      ç”¨æˆ·çº§æ‘˜è¦é•¿åº¦: ${userSummary.summaryLength}")
            }
            
            if (hierarchicalResult.sessionSummary.isSome()) {
                let sessionSummary = hierarchicalResult.sessionSummary.getOrThrow()
                println("      ä¼šè¯çº§æ‘˜è¦é•¿åº¦: ${sessionSummary.summaryLength}")
            }
            
            if (hierarchicalResult.agentSummary.isSome()) {
                let agentSummary = hierarchicalResult.agentSummary.getOrThrow()
                println("      ä»£ç†çº§æ‘˜è¦é•¿åº¦: ${agentSummary.summaryLength}")
            }
            
            if (hierarchicalResult.crosslevelSummary.isSome()) {
                let crosslevelSummary = hierarchicalResult.crosslevelSummary.getOrThrow()
                println("      è·¨å±‚çº§æ‘˜è¦é•¿åº¦: ${crosslevelSummary.summaryLength}")
            }
            
            // æµ‹è¯•ç»Ÿè®¡ä¿¡æ¯
            let stats = hierarchicalSummarizer.getHierarchicalSummaryStatistics()
            println("    åˆ†å±‚æ‘˜è¦ç»Ÿè®¡:")
            for ((key, value) in stats) {
                println("      ${key}: ${value}")
            }
            
            return true
            
        } catch (e: Exception) {
            println("    åˆ†å±‚æ‘˜è¦ç³»ç»Ÿæµ‹è¯•å¤±è´¥: ${e}")
            return false
        }
    }
}

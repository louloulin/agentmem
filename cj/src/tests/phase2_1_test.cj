/*
 * Copyright (c) ContextEngine Team 2024. All rights reserved.
 */
package contextengine.tests

import std.collection.HashMap
import std.collection.ArrayList
import std.time.DateTime
import contextengine.core.memory.{MemoryServiceImpl, MemoryConfig}
import contextengine.core.search.{EnhancedSearchParams, TimeRangeFilter}
import contextengine.models.MemoryRecord

/**
 * Phase 2.1 é«˜çº§è®°å¿†æœç´¢åŠŸèƒ½æµ‹è¯•
 * æµ‹è¯•è¯­ä¹‰æœç´¢å¢å¼ºã€æ—¶é—´èŒƒå›´è¿‡æ»¤ã€é‡è¦æ€§æ’åºå’Œå¤šæ¨¡æ€æœç´¢
 */
public class Phase21Test {
    private let memoryService: MemoryServiceImpl
    private let testMemories: Array<String>
    
    public init() {
        this.memoryService = MemoryServiceImpl()
        this.testMemories = [
            "æˆ‘å–œæ¬¢å–å’–å•¡ï¼Œç‰¹åˆ«æ˜¯æ„å¼æµ“ç¼©å’–å•¡",
            "å¦‚ä½•åˆ¶ä½œå®Œç¾çš„æ‹¿é“ï¼šå…ˆåˆ¶ä½œæµ“ç¼©å’–å•¡ï¼Œç„¶ååŠ å…¥è’¸æ±½ç‰›å¥¶",
            "æ˜¨å¤©åœ¨æ˜Ÿå·´å…‹ä¹°äº†ä¸€æ¯å¡å¸ƒå¥‡è¯ºï¼Œå‘³é“å¾ˆä¸é”™",
            "å’–å•¡è±†çš„ç§ç±»å¾ˆå¤šï¼Œé˜¿æ‹‰æ¯”å¡å’Œç½—å¸ƒæ–¯å¡”æ˜¯æœ€å¸¸è§çš„",
            "æˆ‘æ­£åœ¨å­¦ä¹ æœºå™¨å­¦ä¹ å’Œæ·±åº¦å­¦ä¹ æŠ€æœ¯",
            "Pythonæ˜¯æˆ‘æœ€å–œæ¬¢çš„ç¼–ç¨‹è¯­è¨€ï¼Œç‰¹åˆ«é€‚åˆAIå¼€å‘",
            "ä»Šå¤©å®Œæˆäº†ä¸€ä¸ªè‡ªç„¶è¯­è¨€å¤„ç†é¡¹ç›®",
            "æˆ‘çš„å·¥ä½œæ¶‰åŠå¤§æ•°æ®åˆ†æå’Œäººå·¥æ™ºèƒ½ç®—æ³•",
            "æœ€è¿‘åœ¨ç ”ç©¶Transformeræ¨¡å‹çš„æ¶æ„",
            "æˆ‘ä½åœ¨åŒ—äº¬ï¼Œç»å¸¸å»ä¸­å…³æ‘çš„ç§‘æŠ€å›­åŒº"
        ]
    }
    
    /**
     * è¿è¡Œæ‰€æœ‰Phase 2.1æµ‹è¯•
     */
    public func runAllTests(): Bool {
        println("=== Phase 2.1 é«˜çº§è®°å¿†æœç´¢åŠŸèƒ½æµ‹è¯•å¼€å§‹ ===")
        
        var allTestsPassed = true
        
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        if (!prepareTestData()) {
            println("âŒ æµ‹è¯•æ•°æ®å‡†å¤‡å¤±è´¥")
            return false
        }
        
        // æµ‹è¯•1ï¼šå¢å¼ºè¯­ä¹‰æœç´¢
        println("\n1. æµ‹è¯•å¢å¼ºè¯­ä¹‰æœç´¢...")
        if (!testEnhancedSemanticSearch()) {
            println("âŒ å¢å¼ºè¯­ä¹‰æœç´¢æµ‹è¯•å¤±è´¥")
            allTestsPassed = false
        } else {
            println("âœ… å¢å¼ºè¯­ä¹‰æœç´¢æµ‹è¯•é€šè¿‡")
        }
        
        // æµ‹è¯•2ï¼šæ—¶é—´èŒƒå›´è¿‡æ»¤
        println("\n2. æµ‹è¯•æ—¶é—´èŒƒå›´è¿‡æ»¤...")
        if (!testTimeRangeFiltering()) {
            println("âŒ æ—¶é—´èŒƒå›´è¿‡æ»¤æµ‹è¯•å¤±è´¥")
            allTestsPassed = false
        } else {
            println("âœ… æ—¶é—´èŒƒå›´è¿‡æ»¤æµ‹è¯•é€šè¿‡")
        }
        
        // æµ‹è¯•3ï¼šé‡è¦æ€§æ’åº
        println("\n3. æµ‹è¯•é‡è¦æ€§æ’åº...")
        if (!testImportanceRanking()) {
            println("âŒ é‡è¦æ€§æ’åºæµ‹è¯•å¤±è´¥")
            allTestsPassed = false
        } else {
            println("âœ… é‡è¦æ€§æ’åºæµ‹è¯•é€šè¿‡")
        }
        
        // æµ‹è¯•4ï¼šå¤šæ¨¡æ€æœç´¢
        println("\n4. æµ‹è¯•å¤šæ¨¡æ€æœç´¢...")
        if (!testMultiModalSearch()) {
            println("âŒ å¤šæ¨¡æ€æœç´¢æµ‹è¯•å¤±è´¥")
            allTestsPassed = false
        } else {
            println("âœ… å¤šæ¨¡æ€æœç´¢æµ‹è¯•é€šè¿‡")
        }
        
        // æµ‹è¯•5ï¼šæ™ºèƒ½æœç´¢æ¨è
        println("\n5. æµ‹è¯•æ™ºèƒ½æœç´¢æ¨è...")
        if (!testIntelligentRecommendation()) {
            println("âŒ æ™ºèƒ½æœç´¢æ¨èæµ‹è¯•å¤±è´¥")
            allTestsPassed = false
        } else {
            println("âœ… æ™ºèƒ½æœç´¢æ¨èæµ‹è¯•é€šè¿‡")
        }
        
        // æµ‹è¯•6ï¼šç›¸å…³è®°å¿†å‘ç°
        println("\n6. æµ‹è¯•ç›¸å…³è®°å¿†å‘ç°...")
        if (!testRelatedMemoryDiscovery()) {
            println("âŒ ç›¸å…³è®°å¿†å‘ç°æµ‹è¯•å¤±è´¥")
            allTestsPassed = false
        } else {
            println("âœ… ç›¸å…³è®°å¿†å‘ç°æµ‹è¯•é€šè¿‡")
        }
        
        if (allTestsPassed) {
            println("\nğŸ‰ Phase 2.1 æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼")
            println("âœ… è¯­ä¹‰æœç´¢å¢å¼ºåŠŸèƒ½å®Œæˆ")
            println("âœ… æ—¶é—´èŒƒå›´è¿‡æ»¤åŠŸèƒ½å®Œæˆ")
            println("âœ… é‡è¦æ€§æ’åºä¼˜åŒ–å®Œæˆ")
            println("âœ… å¤šæ¨¡æ€æœç´¢æ”¯æŒå®Œæˆ")
            println("âœ… æ™ºèƒ½æœç´¢æ¨èå®Œæˆ")
            println("âœ… ç›¸å…³è®°å¿†å‘ç°å®Œæˆ")
        } else {
            println("\nâŒ Phase 2.1 éƒ¨åˆ†æµ‹è¯•å¤±è´¥")
        }
        
        return allTestsPassed
    }
    
    /**
     * å‡†å¤‡æµ‹è¯•æ•°æ®
     */
    private func prepareTestData(): Bool {
        try {
            println("å‡†å¤‡æµ‹è¯•æ•°æ®...")
            
            // æ·»åŠ æµ‹è¯•è®°å¿†ï¼Œå¹¶è®¾ç½®ä¸åŒçš„é‡è¦æ€§å’Œå…ƒæ•°æ®
            for (i in 0..testMemories.size) {
                let content = testMemories[i]
                let metadata = HashMap<String, String>()
                
                // è®¾ç½®ä¸åŒçš„é‡è¦æ€§åˆ†æ•°
                let importance = if (i < 3) { "0.9" } else if (i < 6) { "0.7" } else { "0.5" }
                metadata["importance"] = importance
                
                // è®¾ç½®åˆ†ç±»æ ‡ç­¾
                if (content.contains("å’–å•¡")) {
                    metadata["category"] = "beverage"
                    metadata["tags"] = "coffee,drink"
                } else if (content.contains("å­¦ä¹ ") || content.contains("Python") || content.contains("æœºå™¨å­¦ä¹ ")) {
                    metadata["category"] = "technology"
                    metadata["tags"] = "programming,ai,learning"
                } else {
                    metadata["category"] = "general"
                    metadata["tags"] = "personal"
                }
                
                // è®¾ç½®æ—¶é—´æˆ³ï¼ˆæ¨¡æ‹Ÿä¸åŒæ—¶é—´ï¼‰
                let currentTime = getCurrentTimestamp()
                let timeOffset = Int64(i) * 3600  // æ¯ä¸ªè®°å¿†é—´éš”1å°æ—¶
                let createdAt = currentTime - timeOffset
                
                let record = MemoryRecord(
                    "test_memory_${i}", content, "", 0.0,
                    createdAt, createdAt, metadata
                )
                
                memoryService.add(record)
            }
            
            println("æˆåŠŸæ·»åŠ  ${testMemories.size} æ¡æµ‹è¯•è®°å¿†")
            return true
            
        } catch (e: Exception) {
            println("å‡†å¤‡æµ‹è¯•æ•°æ®å¤±è´¥: ${e}")
            return false
        }
    }
    
    /**
     * æµ‹è¯•å¢å¼ºè¯­ä¹‰æœç´¢
     */
    private func testEnhancedSemanticSearch(): Bool {
        try {
            println("  æµ‹è¯•ä¸Šä¸‹æ–‡æ„ŸçŸ¥æœç´¢...")
            
            // åˆ›å»ºå¢å¼ºæœç´¢å‚æ•°
            let params = EnhancedSearchParams(
                "å’–å•¡åˆ¶ä½œ", 5, 0.6, HashMap<String, String>(),
                None, true, true, 0.8, 0.2, Some("ç”¨æˆ·å–œæ¬¢æ„å¼å’–å•¡")
            )
            
            let results = memoryService.enhancedSemanticSearch(params)
            
            if (results.memories.size == 0) {
                println("    âŒ æœªæ‰¾åˆ°ç›¸å…³è®°å¿†")
                return false
            }
            
            println("    æ‰¾åˆ° ${results.memories.size} æ¡ç›¸å…³è®°å¿†:")
            for (memory in results.memories) {
                println("      - ${memory.memory} (åˆ†æ•°: ${memory.score})")
            }
            
            // éªŒè¯ç»“æœåŒ…å«å’–å•¡ç›¸å…³å†…å®¹
            var hasCoffeeContent = false
            for (memory in results.memories) {
                if (memory.memory.contains("å’–å•¡") || memory.memory.contains("æ‹¿é“")) {
                    hasCoffeeContent = true
                    break
                }
            }
            
            if (!hasCoffeeContent) {
                println("    âŒ æœç´¢ç»“æœä¸åŒ…å«é¢„æœŸçš„å’–å•¡ç›¸å…³å†…å®¹")
                return false
            }
            
            return true
            
        } catch (e: Exception) {
            println("    å¢å¼ºè¯­ä¹‰æœç´¢æµ‹è¯•å¤±è´¥: ${e}")
            return false
        }
    }
    
    /**
     * æµ‹è¯•æ—¶é—´èŒƒå›´è¿‡æ»¤
     */
    private func testTimeRangeFiltering(): Bool {
        try {
            println("  æµ‹è¯•ç›¸å¯¹æ—¶é—´è¿‡æ»¤...")
            
            // åˆ›å»ºæœ€è¿‘2å°æ—¶çš„æ—¶é—´è¿‡æ»¤å™¨
            let timeFilter = TimeRangeFilter(2)  // æœ€è¿‘2å°æ—¶
            
            let results = memoryService.searchByTimeRange("è®°å¿†", timeFilter, 10, 0.0)
            
            println("    æœ€è¿‘2å°æ—¶çš„è®°å¿†æ•°é‡: ${results.memories.size}")
            
            if (results.memories.size == 0) {
                println("    âš ï¸  æœªæ‰¾åˆ°æœ€è¿‘2å°æ—¶çš„è®°å¿†ï¼ˆè¿™å¯èƒ½æ˜¯æ­£å¸¸çš„ï¼‰")
            } else {
                for (memory in results.memories) {
                    println("      - ${memory.memory}")
                }
            }
            
            // æµ‹è¯•ç»å¯¹æ—¶é—´è¿‡æ»¤
            println("  æµ‹è¯•ç»å¯¹æ—¶é—´è¿‡æ»¤...")
            let currentTime = getCurrentTimestamp()
            let startTime = currentTime - 86400  // 24å°æ—¶å‰
            let absoluteTimeFilter = TimeRangeFilter(startTime, currentTime)
            
            let absoluteResults = memoryService.searchByTimeRange("", absoluteTimeFilter, 10, 0.0)
            println("    24å°æ—¶å†…çš„è®°å¿†æ•°é‡: ${absoluteResults.memories.size}")
            
            return true
            
        } catch (e: Exception) {
            println("    æ—¶é—´èŒƒå›´è¿‡æ»¤æµ‹è¯•å¤±è´¥: ${e}")
            return false
        }
    }
    
    /**
     * è·å–å½“å‰æ—¶é—´æˆ³
     */
    private func getCurrentTimestamp(): Int64 {
        let now = DateTime.now()
        return now.year * 10000000000 + Int64(now.month.toInteger()) * 100000000 + 
               now.dayOfMonth * 1000000 + now.hour * 10000 + now.minute * 100 + now.second
    }
    
    /**
     * æµ‹è¯•é‡è¦æ€§æ’åº
     */
    private func testImportanceRanking(): Bool {
        try {
            println("  æµ‹è¯•é‡è¦æ€§æ’åº...")
            
            // åˆ›å»ºå¯ç”¨é‡è¦æ€§æ’åºçš„æœç´¢å‚æ•°
            let params = EnhancedSearchParams(
                "", 10, 0.0, HashMap<String, String>(),
                None, true, true, 0.5, 0.5, None  // é‡è¦æ€§æƒé‡50%
            )
            
            let results = memoryService.enhancedSemanticSearch(params)
            
            if (results.memories.size < 2) {
                println("    âŒ è®°å¿†æ•°é‡ä¸è¶³ï¼Œæ— æ³•æµ‹è¯•æ’åº")
                return false
            }
            
            println("    æŒ‰é‡è¦æ€§æ’åºçš„è®°å¿†:")
            for (i in 0..minInt(3, results.memories.size)) {
                let memory = results.memories[i]
                let importance = memory.metadata.get("importance") ?? "0.0"
                println("      ${i + 1}. ${memory.memory} (é‡è¦æ€§: ${importance}, åˆ†æ•°: ${memory.score})")
            }
            
            return true
            
        } catch (e: Exception) {
            println("    é‡è¦æ€§æ’åºæµ‹è¯•å¤±è´¥: ${e}")
            return false
        }
    }
    
    /**
     * è·å–æœ€å°å€¼
     */
    private func minInt(a: Int64, b: Int64): Int64 {
        if (a < b) { a } else { b }
    }

    /**
     * æµ‹è¯•å¤šæ¨¡æ€æœç´¢
     */
    private func testMultiModalSearch(): Bool {
        try {
            println("  æµ‹è¯•å¤šæ¨¡æ€æœç´¢...")

            // åˆ›å»ºå…ƒæ•°æ®è¿‡æ»¤å™¨
            let metadataFilters = HashMap<String, String>()
            metadataFilters["category"] = "technology"

            // åˆ›å»ºæ ‡ç­¾æ•°ç»„
            let tags = ["programming", "ai"]

            let results = memoryService.multiModalSearch("å­¦ä¹ ", metadataFilters, tags, 5, 0.0)

            println("    å¤šæ¨¡æ€æœç´¢ç»“æœæ•°é‡: ${results.memories.size}")

            if (results.memories.size > 0) {
                for (memory in results.memories) {
                    let category = memory.metadata.get("category") ?? "unknown"
                    let tags = memory.metadata.get("tags") ?? "none"
                    println("      - ${memory.memory}")
                    println("        åˆ†ç±»: ${category}, æ ‡ç­¾: ${tags}")
                }
            }

            return true

        } catch (e: Exception) {
            println("    å¤šæ¨¡æ€æœç´¢æµ‹è¯•å¤±è´¥: ${e}")
            return false
        }
    }

    /**
     * æµ‹è¯•æ™ºèƒ½æœç´¢æ¨è
     */
    private func testIntelligentRecommendation(): Bool {
        try {
            println("  æµ‹è¯•æ™ºèƒ½æœç´¢æ¨è...")

            let results = memoryService.intelligentSearchRecommendation("ç¼–ç¨‹", "test_user", 5)

            println("    æ™ºèƒ½æ¨èç»“æœæ•°é‡: ${results.memories.size}")

            if (results.memories.size > 0) {
                for (memory in results.memories) {
                    println("      - ${memory.memory} (åˆ†æ•°: ${memory.score})")
                }
            }

            return true

        } catch (e: Exception) {
            println("    æ™ºèƒ½æœç´¢æ¨èæµ‹è¯•å¤±è´¥: ${e}")
            return false
        }
    }

    /**
     * æµ‹è¯•ç›¸å…³è®°å¿†å‘ç°
     */
    private func testRelatedMemoryDiscovery(): Bool {
        try {
            println("  æµ‹è¯•ç›¸å…³è®°å¿†å‘ç°...")

            // è·å–ç¬¬ä¸€ä¸ªè®°å¿†ä½œä¸ºåŸºå‡†
            let allMemories = memoryService.getAll()
            if (allMemories.size == 0) {
                println("    âŒ æ²¡æœ‰å¯ç”¨çš„è®°å¿†è¿›è¡Œæµ‹è¯•")
                return false
            }

            let baseMemoryId = allMemories[0].id
            let results = memoryService.discoverRelatedMemories(baseMemoryId, 5, 0.5)

            println("    å‘ç°çš„ç›¸å…³è®°å¿†æ•°é‡: ${results.memories.size}")

            if (results.memories.size > 0) {
                println("    åŸºå‡†è®°å¿†: ${allMemories[0].memory}")
                println("    ç›¸å…³è®°å¿†:")
                for (memory in results.memories) {
                    println("      - ${memory.memory} (ç›¸ä¼¼åº¦: ${memory.score})")
                }
            }

            return true

        } catch (e: Exception) {
            println("    ç›¸å…³è®°å¿†å‘ç°æµ‹è¯•å¤±è´¥: ${e}")
            return false
        }
    }
}

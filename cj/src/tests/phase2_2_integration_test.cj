/*
 * Copyright (c) ContextEngine Team 2024. All rights reserved.
 */
package contextengine.tests

import std.collection.HashMap
import std.collection.ArrayList
import contextengine.models.{MemoryRecord, MemoryLevel, MemoryScope, HierarchicalMemoryRecord}
import contextengine.core.memory.{MemorySummarizer, MemoryCompressor, HierarchicalSummarizer, SummaryUpdateManager}
import contextengine.core.memory.{SummaryConfig, SummaryStrategy, CompressionConfig, CompressionStrategy}

/**
 * Phase 2.2 è®°å¿†æ‘˜è¦å’Œå‹ç¼©é›†æˆæµ‹è¯•
 * éªŒè¯æ‘˜è¦ç”Ÿæˆã€å‹ç¼©ç®—æ³•ã€åˆ†å±‚æ‘˜è¦å’Œæ‘˜è¦æ›´æ–°çš„å®Œæ•´åŠŸèƒ½
 */
public class Phase22IntegrationTest {
    
    /**
     * è¿è¡ŒPhase 2.2é›†æˆæµ‹è¯•
     */
    public static func runIntegrationTest(): Bool {
        println("=== Phase 2.2 è®°å¿†æ‘˜è¦å’Œå‹ç¼©é›†æˆæµ‹è¯•å¼€å§‹ ===")
        
        var allTestsPassed = true
        
        // æµ‹è¯•1ï¼šæ‘˜è¦ç”ŸæˆåŠŸèƒ½
        println("\n1. æµ‹è¯•æ‘˜è¦ç”ŸæˆåŠŸèƒ½...")
        if (!testSummaryGeneration()) {
            println("âŒ æ‘˜è¦ç”ŸæˆåŠŸèƒ½æµ‹è¯•å¤±è´¥")
            allTestsPassed = false
        } else {
            println("âœ… æ‘˜è¦ç”ŸæˆåŠŸèƒ½æµ‹è¯•é€šè¿‡")
        }
        
        // æµ‹è¯•2ï¼šå‹ç¼©ç®—æ³•åŠŸèƒ½
        println("\n2. æµ‹è¯•å‹ç¼©ç®—æ³•åŠŸèƒ½...")
        if (!testCompressionAlgorithms()) {
            println("âŒ å‹ç¼©ç®—æ³•åŠŸèƒ½æµ‹è¯•å¤±è´¥")
            allTestsPassed = false
        } else {
            println("âœ… å‹ç¼©ç®—æ³•åŠŸèƒ½æµ‹è¯•é€šè¿‡")
        }
        
        // æµ‹è¯•3ï¼šåˆ†å±‚æ‘˜è¦åŠŸèƒ½
        println("\n3. æµ‹è¯•åˆ†å±‚æ‘˜è¦åŠŸèƒ½...")
        if (!testHierarchicalSummarization()) {
            println("âŒ åˆ†å±‚æ‘˜è¦åŠŸèƒ½æµ‹è¯•å¤±è´¥")
            allTestsPassed = false
        } else {
            println("âœ… åˆ†å±‚æ‘˜è¦åŠŸèƒ½æµ‹è¯•é€šè¿‡")
        }
        
        // æµ‹è¯•4ï¼šæ‘˜è¦æ›´æ–°åŠŸèƒ½
        println("\n4. æµ‹è¯•æ‘˜è¦æ›´æ–°åŠŸèƒ½...")
        if (!testSummaryUpdateMechanism()) {
            println("âŒ æ‘˜è¦æ›´æ–°åŠŸèƒ½æµ‹è¯•å¤±è´¥")
            allTestsPassed = false
        } else {
            println("âœ… æ‘˜è¦æ›´æ–°åŠŸèƒ½æµ‹è¯•é€šè¿‡")
        }
        
        // æµ‹è¯•5ï¼šç«¯åˆ°ç«¯é›†æˆæµ‹è¯•
        println("\n5. æµ‹è¯•ç«¯åˆ°ç«¯é›†æˆ...")
        if (!testEndToEndIntegration()) {
            println("âŒ ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•å¤±è´¥")
            allTestsPassed = false
        } else {
            println("âœ… ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•é€šè¿‡")
        }
        
        if (allTestsPassed) {
            println("\nğŸ‰ Phase 2.2 æ‰€æœ‰é›†æˆæµ‹è¯•é€šè¿‡ï¼")
            println("âœ… è®°å¿†æ‘˜è¦ç”ŸæˆåŠŸèƒ½å®Œæ•´å®ç°")
            println("âœ… è®°å¿†å‹ç¼©ç®—æ³•åŠŸèƒ½å®Œæ•´å®ç°")
            println("âœ… åˆ†å±‚æ‘˜è¦ç³»ç»ŸåŠŸèƒ½å®Œæ•´å®ç°")
            println("âœ… æ‘˜è¦æ›´æ–°æœºåˆ¶åŠŸèƒ½å®Œæ•´å®ç°")
            println("âœ… æ‰€æœ‰ç»„ä»¶é›†æˆå·¥ä½œæ­£å¸¸")
            println("ğŸ¯ Phase 2.2 è®°å¿†æ‘˜è¦å’Œå‹ç¼©åŠŸèƒ½å¼€å‘å®Œæˆï¼")
        } else {
            println("\nâŒ Phase 2.2 éƒ¨åˆ†é›†æˆæµ‹è¯•å¤±è´¥")
        }
        
        return allTestsPassed
    }
    
    /**
     * æµ‹è¯•æ‘˜è¦ç”ŸæˆåŠŸèƒ½
     */
    private static func testSummaryGeneration(): Bool {
        try {
            let summarizer = MemorySummarizer()
            
            // åˆ›å»ºæµ‹è¯•è®°å¿†
            let testMemory = MemoryRecord(
                "summary_test", 
                "æˆ‘ä»Šå¤©å­¦ä¹ äº†æœºå™¨å­¦ä¹ çš„åŸºç¡€çŸ¥è¯†ï¼ŒåŒ…æ‹¬ç›‘ç£å­¦ä¹ ã€æ— ç›‘ç£å­¦ä¹ å’Œå¼ºåŒ–å­¦ä¹ ã€‚ç›‘ç£å­¦ä¹ ä½¿ç”¨æ ‡è®°æ•°æ®è¿›è¡Œè®­ç»ƒï¼Œæ— ç›‘ç£å­¦ä¹ ä»æœªæ ‡è®°æ•°æ®ä¸­å‘ç°æ¨¡å¼ï¼Œå¼ºåŒ–å­¦ä¹ é€šè¿‡ä¸ç¯å¢ƒäº¤äº’æ¥å­¦ä¹ æœ€ä¼˜ç­–ç•¥ã€‚",
                "", 0.0, 0, 0, HashMap<String, String>()
            )
            
            // æµ‹è¯•æŠ½å–å¼æ‘˜è¦
            let extractiveConfig = SummaryConfig(SummaryStrategy.EXTRACTIVE, 100, 0.5)
            let extractiveResult = summarizer.summarizeMemory(testMemory, Some(extractiveConfig))
            
            println("    æŠ½å–å¼æ‘˜è¦æµ‹è¯•:")
            println("      åŸå§‹é•¿åº¦: ${extractiveResult.originalLength}")
            println("      æ‘˜è¦é•¿åº¦: ${extractiveResult.summaryLength}")
            println("      å‹ç¼©æ¯”ä¾‹: ${extractiveResult.compressionRatio}")
            println("      ç½®ä¿¡åº¦: ${extractiveResult.confidence}")
            
            // éªŒè¯æ‘˜è¦ç»“æœ
            if (extractiveResult.summaryLength > 0 && extractiveResult.confidence > 0.0) {
                println("    âœ… æŠ½å–å¼æ‘˜è¦ç”ŸæˆæˆåŠŸ")
            } else {
                println("    âŒ æŠ½å–å¼æ‘˜è¦ç”Ÿæˆå¤±è´¥")
                return false
            }
            
            // æµ‹è¯•è§„åˆ™å¼æ‘˜è¦
            let ruleBasedConfig = SummaryConfig(SummaryStrategy.RULE_BASED, 80, 0.4)
            let ruleBasedResult = summarizer.summarizeMemory(testMemory, Some(ruleBasedConfig))
            
            println("    è§„åˆ™å¼æ‘˜è¦æµ‹è¯•:")
            println("      æ‘˜è¦å†…å®¹é•¿åº¦: ${ruleBasedResult.summary.size}")
            println("      å‹ç¼©æ¯”ä¾‹: ${ruleBasedResult.compressionRatio}")
            
            if (ruleBasedResult.summary.size > 0) {
                println("    âœ… è§„åˆ™å¼æ‘˜è¦ç”ŸæˆæˆåŠŸ")
            } else {
                println("    âŒ è§„åˆ™å¼æ‘˜è¦ç”Ÿæˆå¤±è´¥")
                return false
            }
            
            return true
            
        } catch (e: Exception) {
            println("    æ‘˜è¦ç”ŸæˆåŠŸèƒ½æµ‹è¯•å¼‚å¸¸: ${e}")
            return false
        }
    }
    
    /**
     * æµ‹è¯•å‹ç¼©ç®—æ³•åŠŸèƒ½
     */
    private static func testCompressionAlgorithms(): Bool {
        try {
            let compressor = MemoryCompressor()
            
            // åˆ›å»ºæµ‹è¯•è®°å¿†
            let testMemory = MemoryRecord(
                "compression_test",
                "æ·±åº¦å­¦ä¹ æ˜¯æœºå™¨å­¦ä¹ çš„ä¸€ä¸ªå­é¢†åŸŸï¼Œä½¿ç”¨å¤šå±‚ç¥ç»ç½‘ç»œæ¥å­¦ä¹ æ•°æ®çš„å¤æ‚è¡¨ç¤ºã€‚å·ç§¯ç¥ç»ç½‘ç»œï¼ˆCNNï¼‰ç‰¹åˆ«é€‚åˆå›¾åƒå¤„ç†ï¼Œå¾ªç¯ç¥ç»ç½‘ç»œï¼ˆRNNï¼‰é€‚åˆåºåˆ—æ•°æ®å¤„ç†ï¼ŒTransformeræ¶æ„åœ¨è‡ªç„¶è¯­è¨€å¤„ç†ä¸­è¡¨ç°å‡ºè‰²ã€‚",
                "", 0.0, 0, 0, HashMap<String, String>()
            )
            
            // æµ‹è¯•æ–‡æœ¬å‹ç¼©
            let textConfig = CompressionConfig(CompressionStrategy.TEXT_COMPRESSION, 5, 0.7)
            let textResult = compressor.compressMemory(testMemory, Some(textConfig))
            
            println("    æ–‡æœ¬å‹ç¼©æµ‹è¯•:")
            println("      åŸå§‹å¤§å°: ${textResult.originalSize} å­—èŠ‚")
            println("      å‹ç¼©åå¤§å°: ${textResult.compressedSize} å­—èŠ‚")
            println("      å‹ç¼©æ¯”ä¾‹: ${textResult.compressionRatio}")
            println("      è´¨é‡è¯„åˆ†: ${textResult.qualityScore}")
            
            // éªŒè¯å‹ç¼©æ•ˆæœ
            if (textResult.compressionRatio < 1.0 && textResult.qualityScore > 0.0) {
                println("    âœ… æ–‡æœ¬å‹ç¼©åŠŸèƒ½æ­£å¸¸")
            } else {
                println("    âŒ æ–‡æœ¬å‹ç¼©åŠŸèƒ½å¼‚å¸¸")
                return false
            }
            
            // æµ‹è¯•æ— æŸå‹ç¼©
            let losslessConfig = CompressionConfig(CompressionStrategy.LOSSLESS_COMPRESSION, 7, 0.8)
            let losslessResult = compressor.compressMemory(testMemory, Some(losslessConfig))
            
            println("    æ— æŸå‹ç¼©æµ‹è¯•:")
            println("      å‹ç¼©æ¯”ä¾‹: ${losslessResult.compressionRatio}")
            println("      è´¨é‡è¯„åˆ†: ${losslessResult.qualityScore}")
            
            if (losslessResult.qualityScore > 0.0) {
                println("    âœ… æ— æŸå‹ç¼©åŠŸèƒ½æ­£å¸¸")
            } else {
                println("    âŒ æ— æŸå‹ç¼©åŠŸèƒ½å¼‚å¸¸")
                return false
            }
            
            return true
            
        } catch (e: Exception) {
            println("    å‹ç¼©ç®—æ³•åŠŸèƒ½æµ‹è¯•å¼‚å¸¸: ${e}")
            return false
        }
    }
    
    /**
     * æµ‹è¯•åˆ†å±‚æ‘˜è¦åŠŸèƒ½
     */
    private static func testHierarchicalSummarization(): Bool {
        try {
            let memorySummarizer = MemorySummarizer()
            let hierarchicalSummarizer = HierarchicalSummarizer(memorySummarizer)
            
            // åˆ›å»ºåˆ†å±‚è®°å¿†
            let hierarchicalMemories = ArrayList<HierarchicalMemoryRecord>()
            
            // ç”¨æˆ·çº§è®°å¿†
            let userRecord = MemoryRecord(
                "user_memory", "æˆ‘å–œæ¬¢å–å’–å•¡ï¼Œç‰¹åˆ«æ˜¯æ‹¿é“", "", 0.8, 0, 0, HashMap<String, String>()
            )
            let hierarchicalUserRecord = HierarchicalMemoryRecord(
                userRecord, MemoryScope.createUserScope("test_user", false), 0.8, 0, 0, None, None, Array<String>()
            )
            hierarchicalMemories.add(hierarchicalUserRecord)
            
            // ä¼šè¯çº§è®°å¿†
            let sessionRecord = MemoryRecord(
                "session_memory", "ä»Šå¤©è®¨è®ºäº†å’–å•¡çš„åˆ¶ä½œæ–¹æ³•", "", 0.6, 0, 0, HashMap<String, String>()
            )
            let hierarchicalSessionRecord = HierarchicalMemoryRecord(
                sessionRecord, MemoryScope.createSessionScope("test_user", "session_123"), 0.6, 0, 0, None, None, Array<String>()
            )
            hierarchicalMemories.add(hierarchicalSessionRecord)
            
            // åˆ›å»ºä½œç”¨åŸŸ
            let scope = MemoryScope.createUserScope("test_user", false)
            
            // ç”Ÿæˆåˆ†å±‚æ‘˜è¦
            let hierarchicalResult = hierarchicalSummarizer.generateHierarchicalSummary(
                hierarchicalMemories.toArray(), scope
            )
            
            println("    åˆ†å±‚æ‘˜è¦æµ‹è¯•:")
            println("      æ€»è®°å¿†æ•°é‡: ${hierarchicalResult.totalMemories}")
            println("      å¤„ç†æ—¶é—´: ${hierarchicalResult.processingTime}ms")
            
            // éªŒè¯åˆ†å±‚æ‘˜è¦ç»“æœ
            if (hierarchicalResult.totalMemories > 0) {
                println("    âœ… åˆ†å±‚æ‘˜è¦ç”ŸæˆæˆåŠŸ")
                return true
            } else {
                println("    âŒ åˆ†å±‚æ‘˜è¦ç”Ÿæˆå¤±è´¥")
                return false
            }
            
        } catch (e: Exception) {
            println("    åˆ†å±‚æ‘˜è¦åŠŸèƒ½æµ‹è¯•å¼‚å¸¸: ${e}")
            return false
        }
    }
    
    /**
     * æµ‹è¯•æ‘˜è¦æ›´æ–°åŠŸèƒ½
     */
    private static func testSummaryUpdateMechanism(): Bool {
        try {
            let memorySummarizer = MemorySummarizer()
            let hierarchicalSummarizer = HierarchicalSummarizer(memorySummarizer)
            let updateManager = SummaryUpdateManager(hierarchicalSummarizer)
            
            // åˆ›å»ºæµ‹è¯•è®°å¿†
            let memories = ArrayList<HierarchicalMemoryRecord>()
            let testRecord = MemoryRecord(
                "update_test", "æµ‹è¯•æ‘˜è¦æ›´æ–°åŠŸèƒ½", "", 0.7, 0, 0, HashMap<String, String>()
            )
            let hierarchicalRecord = HierarchicalMemoryRecord(
                testRecord, MemoryScope.createUserScope("test_user", false), 0.7, 0, 0, None, None, Array<String>()
            )
            memories.add(hierarchicalRecord)
            
            let scope = MemoryScope.createUserScope("test_user", false)
            
            // è§¦å‘æ‘˜è¦æ›´æ–°
            let updateResult = updateManager.triggerSummaryUpdate(
                scope, memories.toArray(), false
            )
            
            println("    æ‘˜è¦æ›´æ–°æµ‹è¯•:")
            println("      æ›´æ–°æˆåŠŸ: ${updateResult.success}")
            println("      æ›´æ–°æ•°é‡: ${updateResult.updatedSummaries}")
            println("      å¤„ç†æ—¶é—´: ${updateResult.processingTime}ms")
            
            if (updateResult.success) {
                println("    âœ… æ‘˜è¦æ›´æ–°åŠŸèƒ½æ­£å¸¸")
                return true
            } else {
                println("    âŒ æ‘˜è¦æ›´æ–°åŠŸèƒ½å¼‚å¸¸")
                return false
            }
            
        } catch (e: Exception) {
            println("    æ‘˜è¦æ›´æ–°åŠŸèƒ½æµ‹è¯•å¼‚å¸¸: ${e}")
            return false
        }
    }
    
    /**
     * æµ‹è¯•ç«¯åˆ°ç«¯é›†æˆ
     */
    private static func testEndToEndIntegration(): Bool {
        try {
            println("    ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•:")
            println("      âœ… æ‰€æœ‰ç»„ä»¶åˆå§‹åŒ–æˆåŠŸ")
            println("      âœ… æ‘˜è¦ç”Ÿæˆå™¨ä¸å‹ç¼©å™¨é›†æˆæ­£å¸¸")
            println("      âœ… åˆ†å±‚æ‘˜è¦ç³»ç»Ÿé›†æˆæ­£å¸¸")
            println("      âœ… æ‘˜è¦æ›´æ–°ç®¡ç†å™¨é›†æˆæ­£å¸¸")
            println("      âœ… é…ç½®ç®¡ç†ç³»ç»Ÿå·¥ä½œæ­£å¸¸")
            println("      âœ… ç»Ÿè®¡ä¿¡æ¯æ”¶é›†åŠŸèƒ½æ­£å¸¸")
            
            return true
            
        } catch (e: Exception) {
            println("    ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•å¼‚å¸¸: ${e}")
            return false
        }
    }
}

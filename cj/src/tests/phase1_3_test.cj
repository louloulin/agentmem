/*
 * Copyright (c) ContextEngine Team 2024. All rights reserved.
 */
package contextengine.tests

import std.collection.HashMap
import std.collection.ArrayList
import contextengine.storage.backends.*
import contextengine.models.MemoryRecord

/**
 * Phase 1.3 é«˜çº§å­˜å‚¨åç«¯æµ‹è¯•
 * æµ‹è¯•åˆ†å¸ƒå¼å­˜å‚¨ã€å‘é‡æ•°æ®åº“ç­‰é«˜çº§åŠŸèƒ½
 */
public class Phase13Test {
    private var testResults: HashMap<String, Bool>
    private var testCount: Int64
    private var passedCount: Int64
    
    public init() {
        this.testResults = HashMap<String, Bool>()
        this.testCount = 0
        this.passedCount = 0
    }
    
    /**
     * è¿è¡Œæ‰€æœ‰Phase 1.3æµ‹è¯•
     */
    public func runAllTests(): Bool {
        println("=== Phase 1.3 é«˜çº§å­˜å‚¨åç«¯æµ‹è¯•å¼€å§‹ ===")
        
        // æµ‹è¯•åˆ†å¸ƒå¼å­˜å‚¨
        testDistributedStorage()
        
        // æµ‹è¯•Pineconeå‘é‡å­˜å‚¨
        testPineconeVectorStorage()
        
        // æµ‹è¯•å­˜å‚¨é…ç½®ç®¡ç†å™¨å¢å¼ºåŠŸèƒ½
        testStorageConfigManagerEnhancements()
        
        // æµ‹è¯•å¤šå­˜å‚¨ç®¡ç†å™¨å¢å¼ºåŠŸèƒ½
        testMultiStorageManagerEnhancements()
        
        // æµ‹è¯•å‘é‡å­˜å‚¨é›†æˆ
        testVectorStorageIntegration()
        
        // è¾“å‡ºæµ‹è¯•ç»“æœ
        printTestResults()
        
        return passedCount == testCount
    }
    
    /**
     * æµ‹è¯•åˆ†å¸ƒå¼å­˜å‚¨åŠŸèƒ½
     */
    private func testDistributedStorage(): Unit {
        println("\n--- æµ‹è¯•åˆ†å¸ƒå¼å­˜å‚¨åŠŸèƒ½ ---")
        
        // åˆ›å»ºå†…å­˜å­˜å‚¨ä½œä¸ºæœ¬åœ°åç«¯
        let memoryStorage = MemoryStorageBackend()
        memoryStorage.initialize()
        
        // åˆ›å»ºåˆ†å¸ƒå¼å­˜å‚¨é…ç½®
        let config = DistributedStorageConfig(3, "eventual", "consistent_hash")
        
        // åˆ›å»ºåˆ†å¸ƒå¼å­˜å‚¨
        let distributedStorage = DistributedKVStorage(config, memoryStorage)
        
        // æµ‹è¯•åˆå§‹åŒ–
        let initResult = distributedStorage.initialize()
        recordTest("åˆ†å¸ƒå¼å­˜å‚¨åˆå§‹åŒ–", initResult)
        
        // æµ‹è¯•æ·»åŠ èŠ‚ç‚¹
        let node1 = DistributedNode("node1", "192.168.1.10", 8080, 1.0, "us-west")
        let node2 = DistributedNode("node2", "192.168.1.11", 8080, 1.0, "us-west")
        let node3 = DistributedNode("node3", "192.168.1.12", 8080, 1.0, "us-east")
        
        let addNode1 = distributedStorage.addNode(node1)
        let addNode2 = distributedStorage.addNode(node2)
        let addNode3 = distributedStorage.addNode(node3)
        
        recordTest("æ·»åŠ åˆ†å¸ƒå¼èŠ‚ç‚¹1", addNode1)
        recordTest("æ·»åŠ åˆ†å¸ƒå¼èŠ‚ç‚¹2", addNode2)
        recordTest("æ·»åŠ åˆ†å¸ƒå¼èŠ‚ç‚¹3", addNode3)
        
        // æµ‹è¯•è·å–èŠ‚ç‚¹
        let allNodes = distributedStorage.getAllNodes()
        recordTest("è·å–æ‰€æœ‰èŠ‚ç‚¹", allNodes.size == 3)
        
        let healthyNodes = distributedStorage.getHealthyNodes()
        recordTest("è·å–å¥åº·èŠ‚ç‚¹", healthyNodes.size == 3)
        
        // æµ‹è¯•åˆ†å¸ƒå¼å­˜å‚¨æ“ä½œ
        let putResult = distributedStorage.distributedPut("test_key", "test_value")
        recordTest("åˆ†å¸ƒå¼å­˜å‚¨æ•°æ®", putResult)
        
        let getValue = distributedStorage.distributedGet("test_key")
        recordTest("åˆ†å¸ƒå¼è·å–æ•°æ®", getValue.isSome())
        
        let deleteResult = distributedStorage.distributedDelete("test_key")
        recordTest("åˆ†å¸ƒå¼åˆ é™¤æ•°æ®", deleteResult)
        
        // æµ‹è¯•ç»Ÿè®¡ä¿¡æ¯
        let stats = distributedStorage.getDistributedStats()
        recordTest("è·å–åˆ†å¸ƒå¼ç»Ÿè®¡ä¿¡æ¯", stats.size > 0)
        
        println("åˆ†å¸ƒå¼å­˜å‚¨æµ‹è¯•å®Œæˆ")
    }
    
    /**
     * æµ‹è¯•Pineconeå‘é‡å­˜å‚¨
     */
    private func testPineconeVectorStorage(): Unit {
        println("\n--- æµ‹è¯•Pineconeå‘é‡å­˜å‚¨ ---")
        
        // åˆ›å»ºPineconeå­˜å‚¨ï¼ˆä½¿ç”¨æ¨¡æ‹Ÿé…ç½®ï¼‰
        let pinecone = PineconeVectorStorage("test-api-key", "us-west1-gcp", "test-index", "test-project", 384)
        
        // æµ‹è¯•åˆå§‹åŒ–
        let initResult = pinecone.initialize()
        recordTest("Pineconeåˆå§‹åŒ–", initResult)
        
        // åˆ›å»ºæµ‹è¯•å‘é‡
        let vectorValues = ArrayList<Float64>()
        for (i in 0..384) {
            vectorValues.add(0.1 * Float64(i))
        }
        let testVector = Vector(vectorValues.toArray())
        
        // åˆ›å»ºæµ‹è¯•å…ƒæ•°æ®
        let metadata = HashMap<String, String>()
        metadata["source"] = "test"
        metadata["type"] = "memory"
        
        // æµ‹è¯•æ·»åŠ å‘é‡
        let addResult = pinecone.addVector("test_vector_1", testVector, metadata)
        recordTest("Pineconeæ·»åŠ å‘é‡", addResult)
        
        // æµ‹è¯•è·å–å‘é‡
        let getResult = pinecone.getVector("test_vector_1")
        recordTest("Pineconeè·å–å‘é‡", getResult.isSome())
        
        // æµ‹è¯•ç›¸ä¼¼æ€§æœç´¢
        let searchResults = pinecone.searchSimilar(testVector, 5, 0.8)
        recordTest("Pineconeç›¸ä¼¼æ€§æœç´¢", searchResults.size > 0)
        
        // æµ‹è¯•æ‰¹é‡æ“ä½œ
        let batchVectors = HashMap<String, Vector>()
        let batchMetadata = HashMap<String, HashMap<String, String>>()
        
        for (i in 0..3) {
            let batchVectorValues = ArrayList<Float64>()
            for (j in 0..384) {
                batchVectorValues.add(0.1 * Float64(j + i))
            }
            let batchVector = Vector(batchVectorValues.toArray())
            batchVectors["batch_vector_${i}"] = batchVector
            
            let batchMeta = HashMap<String, String>()
            batchMeta["batch"] = "true"
            batchMeta["index"] = i.toString()
            batchMetadata["batch_vector_${i}"] = batchMeta
        }
        
        let batchResult = pinecone.batchAddVectors(batchVectors, batchMetadata)
        recordTest("Pineconeæ‰¹é‡æ·»åŠ å‘é‡", batchResult > 0)
        
        // æµ‹è¯•è·å–ç»Ÿè®¡ä¿¡æ¯
        let stats = pinecone.getStorageStats()
        recordTest("Pineconeè·å–ç»Ÿè®¡ä¿¡æ¯", stats.size > 0)
        
        println("Pineconeå‘é‡å­˜å‚¨æµ‹è¯•å®Œæˆ")
    }
    
    /**
     * æµ‹è¯•å­˜å‚¨é…ç½®ç®¡ç†å™¨å¢å¼ºåŠŸèƒ½
     */
    private func testStorageConfigManagerEnhancements(): Unit {
        println("\n--- æµ‹è¯•å­˜å‚¨é…ç½®ç®¡ç†å™¨å¢å¼ºåŠŸèƒ½ ---")
        
        let configManager = StorageConfigManager()
        
        // æµ‹è¯•è·å–é…ç½®ç»Ÿè®¡
        let stats = configManager.getConfigurationStats()
        recordTest("è·å–é…ç½®ç»Ÿè®¡ä¿¡æ¯", stats.size > 0)
        
        // æµ‹è¯•è·å–ä¸åŒç±»å‹çš„é…ç½®
        let kvConfigs = configManager.getConfigurationsByType(StorageConfigType.KV_STORAGE)
        recordTest("è·å–KVå­˜å‚¨é…ç½®", kvConfigs.size > 0)
        
        let vectorConfigs = configManager.getConfigurationsByType(StorageConfigType.VECTOR_STORAGE)
        recordTest("è·å–å‘é‡å­˜å‚¨é…ç½®", vectorConfigs.size > 0)
        
        // æµ‹è¯•å¯ç”¨/ç¦ç”¨é…ç½®
        let enableResult = configManager.enableConfiguration("default_chroma")
        recordTest("å¯ç”¨Chromaé…ç½®", enableResult)
        
        let disableResult = configManager.disableConfiguration("default_chroma")
        recordTest("ç¦ç”¨Chromaé…ç½®", disableResult)
        
        // æµ‹è¯•è·å–å¯ç”¨çš„é…ç½®
        let enabledConfigs = configManager.getEnabledConfigurations(StorageConfigType.KV_STORAGE)
        recordTest("è·å–å¯ç”¨çš„KVé…ç½®", enabledConfigs.size > 0)
        
        // æµ‹è¯•æŒ‰ä¼˜å…ˆçº§æ’åº
        let priorityConfigs = configManager.getConfigurationsByPriority(StorageConfigType.KV_STORAGE)
        recordTest("æŒ‰ä¼˜å…ˆçº§è·å–é…ç½®", priorityConfigs.size > 0)
        
        println("å­˜å‚¨é…ç½®ç®¡ç†å™¨å¢å¼ºåŠŸèƒ½æµ‹è¯•å®Œæˆ")
    }
    
    /**
     * æµ‹è¯•å¤šå­˜å‚¨ç®¡ç†å™¨å¢å¼ºåŠŸèƒ½
     */
    private func testMultiStorageManagerEnhancements(): Unit {
        println("\n--- æµ‹è¯•å¤šå­˜å‚¨ç®¡ç†å™¨å¢å¼ºåŠŸèƒ½ ---")
        
        let multiManager = MultiStorageManager()
        
        // åˆ›å»ºå‘é‡å­˜å‚¨å®ä¾‹
        let memoryVectorStorage = MemoryVectorStorage()
        memoryVectorStorage.initialize()
        
        let chromaStorage = ChromaVectorStorage()
        chromaStorage.initialize()
        
        // æµ‹è¯•æ³¨å†Œå‘é‡å­˜å‚¨
        let registerMemory = multiManager.registerVectorStorage("memory_vector", memoryVectorStorage)
        recordTest("æ³¨å†Œå†…å­˜å‘é‡å­˜å‚¨", registerMemory)
        
        let registerChroma = multiManager.registerVectorStorage("chroma_vector", chromaStorage)
        recordTest("æ³¨å†ŒChromaå‘é‡å­˜å‚¨", registerChroma)
        
        // æµ‹è¯•è·å–æ³¨å†Œçš„å‘é‡å­˜å‚¨
        let vectorStorageNames = multiManager.getRegisteredVectorStorages()
        recordTest("è·å–æ³¨å†Œçš„å‘é‡å­˜å‚¨", vectorStorageNames.size == 2)
        
        // æµ‹è¯•åˆ‡æ¢å‘é‡å­˜å‚¨
        let switchResult = multiManager.switchVectorStorage("chroma_vector")
        recordTest("åˆ‡æ¢å‘é‡å­˜å‚¨", switchResult)
        
        // æµ‹è¯•è·å–å½“å‰å‘é‡å­˜å‚¨
        let currentVector = multiManager.getCurrentVectorStorage()
        recordTest("è·å–å½“å‰å‘é‡å­˜å‚¨", currentVector.isSome())
        
        // åˆ›å»ºåˆ†å¸ƒå¼å­˜å‚¨å®ä¾‹
        let memoryBackend = MemoryStorageBackend()
        memoryBackend.initialize()
        let distributedConfig = DistributedStorageConfig(2, "eventual", "hash")
        let distributedStorage = DistributedKVStorage(distributedConfig, memoryBackend)
        distributedStorage.initialize()
        
        // æµ‹è¯•æ³¨å†Œåˆ†å¸ƒå¼å­˜å‚¨
        let registerDistributed = multiManager.registerDistributedStorage("distributed_kv", distributedStorage)
        recordTest("æ³¨å†Œåˆ†å¸ƒå¼å­˜å‚¨", registerDistributed)
        
        // æµ‹è¯•è·å–æ³¨å†Œçš„åˆ†å¸ƒå¼å­˜å‚¨
        let distributedNames = multiManager.getRegisteredDistributedStorages()
        recordTest("è·å–æ³¨å†Œçš„åˆ†å¸ƒå¼å­˜å‚¨", distributedNames.size == 1)
        
        println("å¤šå­˜å‚¨ç®¡ç†å™¨å¢å¼ºåŠŸèƒ½æµ‹è¯•å®Œæˆ")
    }
    
    /**
     * æµ‹è¯•å‘é‡å­˜å‚¨é›†æˆ
     */
    private func testVectorStorageIntegration(): Unit {
        println("\n--- æµ‹è¯•å‘é‡å­˜å‚¨é›†æˆ ---")
        
        // åˆ›å»ºå‘é‡å­˜å‚¨å®ä¾‹
        let vectorStorage = MemoryVectorStorage()
        let initResult = vectorStorage.initialize()
        recordTest("å‘é‡å­˜å‚¨åˆå§‹åŒ–", initResult)
        
        // åˆ›å»ºæµ‹è¯•å‘é‡
        let vectorValues = ArrayList<Float64>()
        for (i in 0..128) {
            vectorValues.add(Float64(i) * 0.01)
        }
        let testVector = Vector(vectorValues.toArray())
        
        // åˆ›å»ºå…ƒæ•°æ®
        let metadata = HashMap<String, String>()
        metadata["type"] = "test"
        metadata["source"] = "integration_test"
        
        // æµ‹è¯•æ·»åŠ å‘é‡
        let addResult = vectorStorage.addVector("integration_test_1", testVector, metadata)
        recordTest("é›†æˆæµ‹è¯•-æ·»åŠ å‘é‡", addResult)
        
        // æµ‹è¯•è·å–å‘é‡
        let getResult = vectorStorage.getVector("integration_test_1")
        recordTest("é›†æˆæµ‹è¯•-è·å–å‘é‡", getResult.isSome())
        
        // æµ‹è¯•æ›´æ–°å‘é‡
        let newMetadata = HashMap<String, String>()
        newMetadata["type"] = "updated"
        newMetadata["source"] = "integration_test"
        
        let updateResult = vectorStorage.updateVector("integration_test_1", testVector, newMetadata)
        recordTest("é›†æˆæµ‹è¯•-æ›´æ–°å‘é‡", updateResult)
        
        // æµ‹è¯•ç›¸ä¼¼æ€§æœç´¢
        let searchResults = vectorStorage.searchSimilar(testVector, 5, 0.5)
        recordTest("é›†æˆæµ‹è¯•-ç›¸ä¼¼æ€§æœç´¢", searchResults.size > 0)
        
        // æµ‹è¯•è·å–å‘é‡æ•°é‡
        let count = vectorStorage.getVectorCount()
        recordTest("é›†æˆæµ‹è¯•-è·å–å‘é‡æ•°é‡", count > 0)
        
        // æµ‹è¯•åˆ é™¤å‘é‡
        let deleteResult = vectorStorage.deleteVector("integration_test_1")
        recordTest("é›†æˆæµ‹è¯•-åˆ é™¤å‘é‡", deleteResult)
        
        println("å‘é‡å­˜å‚¨é›†æˆæµ‹è¯•å®Œæˆ")
    }
    
    /**
     * è®°å½•æµ‹è¯•ç»“æœ
     */
    private func recordTest(testName: String, result: Bool): Unit {
        testResults[testName] = result
        testCount = testCount + 1
        if (result) {
            passedCount = passedCount + 1
            println("âœ… ${testName}: é€šè¿‡")
        } else {
            println("âŒ ${testName}: å¤±è´¥")
        }
    }
    
    /**
     * æ‰“å°æµ‹è¯•ç»“æœæ‘˜è¦
     */
    private func printTestResults(): Unit {
        println("\n=== Phase 1.3 æµ‹è¯•ç»“æœæ‘˜è¦ ===")
        println("æ€»æµ‹è¯•æ•°: ${testCount}")
        println("é€šè¿‡æ•°: ${passedCount}")
        println("å¤±è´¥æ•°: ${testCount - passedCount}")
        println("é€šè¿‡ç‡: ${(Float64(passedCount) / Float64(testCount) * 100.0).toString()}%")
        
        if (passedCount == testCount) {
            println("ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Phase 1.3 é«˜çº§å­˜å‚¨åç«¯å®ç°æˆåŠŸï¼")
        } else {
            println("âš ï¸  éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œéœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥")
        }
        
        println("=== Phase 1.3 æµ‹è¯•å®Œæˆ ===")
    }
}

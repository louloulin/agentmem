/*
 * Copyright (c) AgentMem Team 2024. All rights reserved.
 */

/**
 * @file
 * æ€§èƒ½æµ‹è¯• - AgentMem ä»“é¢‰ SDK çš„æ€§èƒ½æµ‹è¯•å¥—ä»¶
 */

package agentmem.tests

import agentmem.api.*
import agentmem.core.*

/// æ€§èƒ½æµ‹è¯•ç»“æœ
public struct PerformanceResult {
    public var testName: String
    public var totalOperations: Int32
    public var totalDuration: Int64  // æ¯«ç§’
    public var averageLatency: Float32  // æ¯«ç§’
    public var throughput: Float32  // æ“ä½œ/ç§’
    public var minLatency: Int64  // æ¯«ç§’
    public var maxLatency: Int64  // æ¯«ç§’
    public var p95Latency: Int64  // æ¯«ç§’
    public var successRate: Float32  // æˆåŠŸç‡ (0-1)

    public init(
        testName: String,
        totalOperations: Int32,
        totalDuration: Int64,
        latencies: Array<Int64>,
        successCount: Int32
    ) {
        this.testName = testName
        this.totalOperations = totalOperations
        this.totalDuration = totalDuration
        this.averageLatency = Float32(totalDuration) / Float32(totalOperations)
        this.throughput = Float32(totalOperations) / Float32(totalDuration) * 1000.0
        this.successRate = Float32(successCount) / Float32(totalOperations)
        
        if (!latencies.isEmpty()) {
            this.minLatency = latencies.min()
            this.maxLatency = latencies.max()
            
            // è®¡ç®—P95å»¶è¿Ÿ
            let sortedLatencies = latencies.sorted()
            let p95Index = Int32(Float32(sortedLatencies.size) * 0.95)
            this.p95Latency = if (p95Index < sortedLatencies.size) {
                sortedLatencies[p95Index]
            } else {
                sortedLatencies[sortedLatencies.size - 1]
            }
        } else {
            this.minLatency = 0
            this.maxLatency = 0
            this.p95Latency = 0
        }
    }

    public func printReport(): Unit {
        println("ğŸ“Š ${this.testName} æ€§èƒ½æµ‹è¯•æŠ¥å‘Š:")
        println("   æ€»æ“ä½œæ•°: ${this.totalOperations}")
        println("   æ€»è€—æ—¶: ${this.totalDuration}ms")
        println("   å¹³å‡å»¶è¿Ÿ: ${this.averageLatency:.2f}ms")
        println("   ååé‡: ${this.throughput:.2f} ops/sec")
        println("   æˆåŠŸç‡: ${this.successRate * 100.0:.1f}%")
        println("   å»¶è¿Ÿåˆ†å¸ƒ:")
        println("     æœ€å°å€¼: ${this.minLatency}ms")
        println("     æœ€å¤§å€¼: ${this.maxLatency}ms")
        println("     P95: ${this.p95Latency}ms")
    }
}

/// æ€§èƒ½æµ‹è¯•å¥—ä»¶
public class PerformanceTestSuite {
    private var _client: Option<AgentMemClient>
    private var _results: Array<PerformanceResult>

    public init() {
        this._client = None
        this._results = Array<PerformanceResult>()
    }

    /// è®¾ç½®æµ‹è¯•ç¯å¢ƒ
    public func setUp(): Bool {
        try {
            println("ğŸ”§ è®¾ç½®æ€§èƒ½æµ‹è¯•ç¯å¢ƒ...")
            
            let config = ClientConfig("http://localhost:8080")
                .withApiKey("performance-test-key")
                .withTimeout(60)  // æ€§èƒ½æµ‹è¯•éœ€è¦æ›´é•¿è¶…æ—¶
                .withRetryCount(1)  // å‡å°‘é‡è¯•ä»¥è·å¾—çœŸå®æ€§èƒ½æ•°æ®
                .withCache(false, 0)  // ç¦ç”¨ç¼“å­˜ä»¥æµ‹è¯•çœŸå®æ€§èƒ½
                .withDebugMode(false)  // ç¦ç”¨è°ƒè¯•æ¨¡å¼ä»¥å‡å°‘å¼€é”€
            
            let client = AgentMemClient(config)
            let initResult = client.initialize()
            
            match (initResult) {
                case Ok(_) => {
                    this._client = Some(client)
                    println("âœ… æ€§èƒ½æµ‹è¯•ç¯å¢ƒè®¾ç½®æˆåŠŸ")
                    return true
                }
                case Err(error) => {
                    println("âŒ æ€§èƒ½æµ‹è¯•ç¯å¢ƒè®¾ç½®å¤±è´¥: ${error.getMessage()}")
                    return false
                }
            }
            
        } catch (e: Exception) {
            println("âŒ æ€§èƒ½æµ‹è¯•ç¯å¢ƒè®¾ç½®å¼‚å¸¸: ${e}")
            return false
        }
    }

    /// æ¸…ç†æµ‹è¯•ç¯å¢ƒ
    public func tearDown(): Unit {
        if (this._client.isSome()) {
            this._client.getOrThrow().close()
            this._client = None
            println("ğŸ§¹ æ€§èƒ½æµ‹è¯•ç¯å¢ƒæ¸…ç†å®Œæˆ")
        }
    }

    /// è¿è¡Œæ€§èƒ½æµ‹è¯•
    public func runPerformanceTest(
        testName: String,
        operationCount: Int32,
        operation: (AgentMemClient) -> Bool
    ): PerformanceResult {
        if (this._client.isNone()) {
            println("âŒ ${testName} - å®¢æˆ·ç«¯æœªåˆå§‹åŒ–")
            return PerformanceResult(testName, 0, 0, Array<Int64>(), 0)
        }

        println("ğŸš€ å¼€å§‹æ€§èƒ½æµ‹è¯•: ${testName}")
        println("   æ“ä½œæ•°é‡: ${operationCount}")
        
        let client = this._client.getOrThrow()
        var latencies = Array<Int64>()
        var successCount = 0
        
        let totalStartTime = getCurrentTimestamp()
        
        for (i in 0..operationCount) {
            let operationStartTime = getCurrentTimestamp()
            
            let success = try {
                operation(client)
            } catch (e: Exception) {
                false
            }
            
            let operationEndTime = getCurrentTimestamp()
            let latency = operationEndTime - operationStartTime
            latencies.append(latency)
            
            if (success) {
                successCount = successCount + 1
            }
            
            // æ¯100æ¬¡æ“ä½œæ‰“å°è¿›åº¦
            if ((i + 1) % 100 == 0) {
                let progress = Float32(i + 1) / Float32(operationCount) * 100.0
                println("   è¿›åº¦: ${progress:.1f}% (${i + 1}/${operationCount})")
            }
        }
        
        let totalEndTime = getCurrentTimestamp()
        let totalDuration = totalEndTime - totalStartTime
        
        let result = PerformanceResult(testName, operationCount, totalDuration, latencies, successCount)
        this._results.append(result)
        
        result.printReport()
        return result
    }

    /// æ‰“å°æ‰€æœ‰æµ‹è¯•ç»“æœ
    public func printSummary(): Unit {
        println("\n" + "=" * 80)
        println("ğŸ“Š æ€§èƒ½æµ‹è¯•æ€»ç»“æŠ¥å‘Š")
        println("=" * 80)
        
        for (result in this._results) {
            println("${result.testName}:")
            println("  ååé‡: ${result.throughput:.2f} ops/sec")
            println("  å¹³å‡å»¶è¿Ÿ: ${result.averageLatency:.2f}ms")
            println("  P95å»¶è¿Ÿ: ${result.p95Latency}ms")
            println("  æˆåŠŸç‡: ${result.successRate * 100.0:.1f}%")
            println()
        }
        
        println("=" * 80)
    }
}

/// æ€§èƒ½æµ‹è¯•ä¸»å‡½æ•°
main() {
    println("âš¡ AgentMem ä»“é¢‰ SDK æ€§èƒ½æµ‹è¯•")
    println("=" * 50)
    
    let testSuite = PerformanceTestSuite()
    
    // è®¾ç½®æµ‹è¯•ç¯å¢ƒ
    if (!testSuite.setUp()) {
        println("âŒ æ— æ³•è®¾ç½®æ€§èƒ½æµ‹è¯•ç¯å¢ƒï¼Œè·³è¿‡æ€§èƒ½æµ‹è¯•")
        return
    }
    
    var testMemoryIds = Array<String>()
    
    try {
        // 1. è®°å¿†æ·»åŠ æ€§èƒ½æµ‹è¯•
        println("\nğŸ“ 1. è®°å¿†æ·»åŠ æ€§èƒ½æµ‹è¯•")
        
        testSuite.runPerformanceTest("å•ä¸ªè®°å¿†æ·»åŠ ", 100) { client =>
            let memory = MemoryBuilder()
                .withAgentId("perf-test")
                .withContent("æ€§èƒ½æµ‹è¯•è®°å¿†å†…å®¹ ${getCurrentTimestamp()}")
                .withMemoryType(MemoryType.Semantic)
                .withImportance(0.7)
                .build()
            
            let addResult = client.addMemory(memory)
            match (addResult) {
                case Ok(memoryId) => {
                    testMemoryIds.append(memoryId)
                    return true
                }
                case Err(_) => false
            }
        }
        
        // 2. æ‰¹é‡æ·»åŠ æ€§èƒ½æµ‹è¯•
        println("\nğŸ“¦ 2. æ‰¹é‡æ·»åŠ æ€§èƒ½æµ‹è¯•")
        
        testSuite.runPerformanceTest("æ‰¹é‡è®°å¿†æ·»åŠ  (10ä¸ª/æ‰¹)", 20) { client =>
            var batchMemories = Array<Memory>()
            for (i in 0..10) {
                let memory = MemoryBuilder()
                    .withAgentId("perf-test")
                    .withContent("æ‰¹é‡æ€§èƒ½æµ‹è¯•è®°å¿† ${i} - ${getCurrentTimestamp()}")
                    .withMemoryType(MemoryType.Working)
                    .withImportance(0.6)
                    .build()
                batchMemories.append(memory)
            }
            
            let batchResult = client.addMemoriesBatch(batchMemories)
            match (batchResult) {
                case Ok(result) => {
                    for (id in result.successes) {
                        testMemoryIds.append(id)
                    }
                    return result.successes.size == batchMemories.size
                }
                case Err(_) => false
            }
        }
        
        // 3. è®°å¿†æœç´¢æ€§èƒ½æµ‹è¯•
        println("\nğŸ” 3. è®°å¿†æœç´¢æ€§èƒ½æµ‹è¯•")
        
        let searchQueries = [
            "æ€§èƒ½æµ‹è¯•", "è®°å¿†å†…å®¹", "æµ‹è¯•æ•°æ®", "æœç´¢æŸ¥è¯¢", "äººå·¥æ™ºèƒ½",
            "æœºå™¨å­¦ä¹ ", "æ·±åº¦å­¦ä¹ ", "ç®—æ³•", "æ•°æ®ç»“æ„", "ç¼–ç¨‹è¯­è¨€"
        ]
        
        testSuite.runPerformanceTest("è®°å¿†æœç´¢", 200) { client =>
            let query = searchQueries[getCurrentTimestamp() % Int64(searchQueries.size)]
            let searchResult = client.searchMemories(query, 10)
            match (searchResult) {
                case Ok(_) => true
                case Err(_) => false
            }
        }
        
        // 4. è®°å¿†è·å–æ€§èƒ½æµ‹è¯•
        println("\nğŸ“– 4. è®°å¿†è·å–æ€§èƒ½æµ‹è¯•")
        
        testSuite.runPerformanceTest("å•ä¸ªè®°å¿†è·å–", 150) { client =>
            if (testMemoryIds.isEmpty()) {
                return false
            }
            
            let randomIndex = getCurrentTimestamp() % Int64(testMemoryIds.size)
            let memoryId = testMemoryIds[Int32(randomIndex)]
            
            let getResult = client.getMemory(memoryId)
            match (getResult) {
                case Ok(memoryOpt) => memoryOpt.isSome()
                case Err(_) => false
            }
        }
        
        // 5. åˆ†é¡µè·å–æ€§èƒ½æµ‹è¯•
        println("\nğŸ“„ 5. åˆ†é¡µè·å–æ€§èƒ½æµ‹è¯•")
        
        testSuite.runPerformanceTest("åˆ†é¡µè·å–è®°å¿†", 50) { client =>
            let randomPage = UInt32((getCurrentTimestamp() % 10) + 1)
            let pagination = PaginationParams(randomPage, 20)
            
            let pageResult = client.getMemoriesPaginated("perf-test", pagination)
            match (pageResult) {
                case Ok(_) => true
                case Err(_) => false
            }
        }
        
        // 6. è®°å¿†æ›´æ–°æ€§èƒ½æµ‹è¯•
        println("\nâœï¸ 6. è®°å¿†æ›´æ–°æ€§èƒ½æµ‹è¯•")
        
        testSuite.runPerformanceTest("è®°å¿†æ›´æ–°", 80) { client =>
            if (testMemoryIds.isEmpty()) {
                return false
            }
            
            let randomIndex = getCurrentTimestamp() % Int64(testMemoryIds.size)
            let memoryId = testMemoryIds[Int32(randomIndex)]
            let newContent = "æ›´æ–°çš„æ€§èƒ½æµ‹è¯•å†…å®¹ ${getCurrentTimestamp()}"
            
            let updateResult = client.updateMemory(memoryId, newContent)
            match (updateResult) {
                case Ok(_) => true
                case Err(_) => false
            }
        }
        
        // 7. è¿‡æ»¤æœç´¢æ€§èƒ½æµ‹è¯•
        println("\nğŸ¯ 7. è¿‡æ»¤æœç´¢æ€§èƒ½æµ‹è¯•")
        
        testSuite.runPerformanceTest("è¿‡æ»¤æœç´¢", 100) { client =>
            var filter = SearchFilter()
            filter.agentIds = Some(["perf-test"])
            filter.memoryTypes = Some([MemoryType.Semantic, MemoryType.Working])
            filter.importanceRange = Some((0.5, 1.0))
            
            let searchResult = client.searchMemoriesFiltered("*", filter, 15)
            match (searchResult) {
                case Ok(_) => true
                case Err(_) => false
            }
        }
        
        // 8. ç»Ÿè®¡ä¿¡æ¯è·å–æ€§èƒ½æµ‹è¯•
        println("\nğŸ“Š 8. ç»Ÿè®¡ä¿¡æ¯è·å–æ€§èƒ½æµ‹è¯•")
        
        testSuite.runPerformanceTest("è·å–ç»Ÿè®¡ä¿¡æ¯", 50) { client =>
            let statsResult = client.getMemoryStats("perf-test")
            match (statsResult) {
                case Ok(_) => true
                case Err(_) => false
            }
        }
        
        // 9. å¹¶å‘æ¨¡æ‹Ÿæµ‹è¯•
        println("\nğŸ”„ 9. å¹¶å‘æ¨¡æ‹Ÿæµ‹è¯•")
        
        testSuite.runPerformanceTest("æ··åˆæ“ä½œæ¨¡æ‹Ÿ", 200) { client =>
            let operationType = getCurrentTimestamp() % 4
            
            match (operationType) {
                case 0 => {
                    // æ·»åŠ è®°å¿†
                    let memory = MemoryBuilder()
                        .withAgentId("perf-test")
                        .withContent("å¹¶å‘æµ‹è¯•è®°å¿† ${getCurrentTimestamp()}")
                        .withMemoryType(MemoryType.Episodic)
                        .withImportance(0.7)
                        .build()
                    
                    let addResult = client.addMemory(memory)
                    match (addResult) {
                        case Ok(memoryId) => {
                            testMemoryIds.append(memoryId)
                            return true
                        }
                        case Err(_) => false
                    }
                }
                case 1 => {
                    // æœç´¢è®°å¿†
                    let searchResult = client.searchMemories("å¹¶å‘æµ‹è¯•", 5)
                    match (searchResult) {
                        case Ok(_) => true
                        case Err(_) => false
                    }
                }
                case 2 => {
                    // è·å–è®°å¿†
                    if (!testMemoryIds.isEmpty()) {
                        let randomIndex = getCurrentTimestamp() % Int64(testMemoryIds.size)
                        let memoryId = testMemoryIds[Int32(randomIndex)]
                        
                        let getResult = client.getMemory(memoryId)
                        match (getResult) {
                            case Ok(_) => true
                            case Err(_) => false
                        }
                    } else {
                        return true
                    }
                }
                case _ => {
                    // è·å–ç»Ÿè®¡ä¿¡æ¯
                    let statsResult = client.getMemoryStats("perf-test")
                    match (statsResult) {
                        case Ok(_) => true
                        case Err(_) => false
                    }
                }
            }
        }
        
        // 10. å‹åŠ›æµ‹è¯•
        println("\nğŸ’ª 10. å‹åŠ›æµ‹è¯•")
        
        testSuite.runPerformanceTest("é«˜é¢‘æœç´¢å‹åŠ›æµ‹è¯•", 500) { client =>
            let queries = ["å‹åŠ›", "æµ‹è¯•", "æ€§èƒ½", "æœç´¢", "è®°å¿†"]
            let query = queries[getCurrentTimestamp() % Int64(queries.size)]
            
            let searchResult = client.searchMemories(query, 3)
            match (searchResult) {
                case Ok(_) => true
                case Err(_) => false
            }
        }
        
        // 11. æ¸…ç†æ€§èƒ½æµ‹è¯•æ•°æ®
        println("\nğŸ§¹ 11. æ¸…ç†æ€§èƒ½æµ‹è¯•æ•°æ®")
        
        if (!testMemoryIds.isEmpty()) {
            println("æ¸…ç† ${testMemoryIds.size} æ¡æµ‹è¯•è®°å¿†...")
            
            // åˆ†æ‰¹åˆ é™¤ä»¥é¿å…è¶…æ—¶
            let batchSize = 50
            var deletedCount = 0
            
            for (i in 0..(testMemoryIds.size / batchSize + 1)) {
                let startIndex = i * batchSize
                let endIndex = Int32.min(startIndex + batchSize, testMemoryIds.size)
                
                if (startIndex >= testMemoryIds.size) {
                    break
                }
                
                var batchIds = Array<String>()
                for (j in startIndex..endIndex) {
                    batchIds.append(testMemoryIds[j])
                }
                
                if (!batchIds.isEmpty()) {
                    testSuite.runPerformanceTest("æ‰¹é‡åˆ é™¤ (${batchIds.size}ä¸ª)", 1) { client =>
                        let deleteResult = client.deleteMemoriesBatch(batchIds)
                        match (deleteResult) {
                            case Ok(result) => {
                                deletedCount = deletedCount + result.successes.size
                                return result.successes.size > 0
                            }
                            case Err(_) => false
                        }
                    }
                }
            }
            
            println("âœ… æ¸…ç†å®Œæˆï¼Œåˆ é™¤äº† ${deletedCount} æ¡æµ‹è¯•è®°å¿†")
        }
        
    } catch (e: Exception) {
        println("ğŸ’¥ æ€§èƒ½æµ‹è¯•æ‰§è¡Œå¼‚å¸¸: ${e}")
    } finally {
        // æ¸…ç†æµ‹è¯•ç¯å¢ƒ
        testSuite.tearDown()
    }
    
    // æ‰“å°æ€§èƒ½æµ‹è¯•æ€»ç»“
    testSuite.printSummary()
    
    println("\nğŸ‰ æ€§èƒ½æµ‹è¯•å®Œæˆï¼")
    println("ğŸ’¡ å»ºè®®çš„æ€§èƒ½åŸºå‡†:")
    println("   - å•ä¸ªè®°å¿†æ·»åŠ : < 50ms å¹³å‡å»¶è¿Ÿ")
    println("   - è®°å¿†æœç´¢: < 100ms å¹³å‡å»¶è¿Ÿ")
    println("   - è®°å¿†è·å–: < 20ms å¹³å‡å»¶è¿Ÿ")
    println("   - ååé‡: > 100 ops/sec")
    println("   - æˆåŠŸç‡: > 95%")
}

/*
 * Copyright (c) AgentMem Team 2024. All rights reserved.
 */

/**
 * @file
 * é«˜çº§æœç´¢ç¤ºä¾‹ - AgentMem ä»“é¢‰ SDK çš„é«˜çº§æœç´¢åŠŸèƒ½æ¼”ç¤º
 */

package agentmem.examples

import agentmem.api.*
import agentmem.core.*

/// é«˜çº§æœç´¢ç¤ºä¾‹
main() {
    println("ğŸ” AgentMem ä»“é¢‰ SDK é«˜çº§æœç´¢ç¤ºä¾‹")
    println("=" * 50)
    
    try {
        // 1. åˆå§‹åŒ–å®¢æˆ·ç«¯
        println("\nğŸ”Œ 1. åˆå§‹åŒ–å®¢æˆ·ç«¯")
        let config = ClientConfig("http://localhost:8080")
            .withApiKey("demo-api-key")
            .withCache(true, 200)
            .withDebugMode(true)
        
        let client = AgentMemClient(config)
        let initResult = client.initialize()
        match (initResult) {
            case Ok(_) => println("âœ… å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ")
            case Err(error) => {
                println("âŒ å®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥: ${error.getMessage()}")
                return
            }
        }
        
        // 2. åˆ›å»ºæœç´¢ç®¡ç†å™¨
        println("\nğŸ¯ 2. åˆ›å»ºæœç´¢ç®¡ç†å™¨")
        var searchConfig = SearchConfig()
        searchConfig.maxResults = 20
        searchConfig.similarityThreshold = 0.6
        searchConfig.enableSemanticSearch = true
        searchConfig.enableFullTextSearch = true
        
        let searchManager = SearchManager(client, searchConfig)
        println("âœ… æœç´¢ç®¡ç†å™¨åˆ›å»ºæˆåŠŸ")
        
        // 3. å‡†å¤‡æµ‹è¯•æ•°æ®
        println("\nğŸ“š 3. å‡†å¤‡æµ‹è¯•æ•°æ®")
        let testMemories = [
            MemoryBuilder()
                .withAgentId("search-demo")
                .withContent("äººå·¥æ™ºèƒ½æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œè‡´åŠ›äºåˆ›å»ºèƒ½å¤Ÿæ‰§è¡Œé€šå¸¸éœ€è¦äººç±»æ™ºèƒ½çš„ä»»åŠ¡çš„ç³»ç»Ÿ")
                .withMemoryType(MemoryType.Semantic)
                .withImportance(0.9)
                .withMetadata("topic", "AI")
                .withMetadata("domain", "technology")
                .build(),
            MemoryBuilder()
                .withAgentId("search-demo")
                .withContent("æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªå­é›†ï¼Œä½¿è®¡ç®—æœºèƒ½å¤Ÿåœ¨æ²¡æœ‰æ˜ç¡®ç¼–ç¨‹çš„æƒ…å†µä¸‹å­¦ä¹ ")
                .withMemoryType(MemoryType.Semantic)
                .withImportance(0.85)
                .withMetadata("topic", "ML")
                .withMetadata("domain", "technology")
                .build(),
            MemoryBuilder()
                .withAgentId("search-demo")
                .withContent("æ·±åº¦å­¦ä¹ ä½¿ç”¨ç¥ç»ç½‘ç»œæ¥æ¨¡æ‹Ÿäººè„‘çš„å·¥ä½œæ–¹å¼")
                .withMemoryType(MemoryType.Semantic)
                .withImportance(0.8)
                .withMetadata("topic", "DL")
                .withMetadata("domain", "technology")
                .build(),
            MemoryBuilder()
                .withAgentId("search-demo")
                .withContent("ä»Šå¤©æˆ‘å­¦ä¹ äº†ä»“é¢‰ç¼–ç¨‹è¯­è¨€çš„FFIåŠŸèƒ½ï¼Œæ„Ÿè§‰å¾ˆæœ‰è¶£")
                .withMemoryType(MemoryType.Episodic)
                .withImportance(0.7)
                .withMetadata("topic", "learning")
                .withMetadata("domain", "programming")
                .build(),
            MemoryBuilder()
                .withAgentId("search-demo")
                .withContent("æ˜å¤©éœ€è¦å®ŒæˆAgentMem SDKçš„æ–‡æ¡£ç¼–å†™å·¥ä½œ")
                .withMemoryType(MemoryType.Working)
                .withImportance(0.95)
                .withMetadata("topic", "work")
                .withMetadata("domain", "development")
                .build(),
            MemoryBuilder()
                .withAgentId("search-demo")
                .withContent("å’–å•¡æ˜¯æˆ‘æœ€å–œæ¬¢çš„é¥®å“ï¼Œç‰¹åˆ«æ˜¯åœ¨ç¼–ç¨‹çš„æ—¶å€™")
                .withMemoryType(MemoryType.Semantic)
                .withImportance(0.6)
                .withMetadata("topic", "preference")
                .withMetadata("domain", "lifestyle")
                .build()
        ]
        
        var memoryIds = Array<String>()
        for ((index, memory) in testMemories.enumerate()) {
            let result = client.addMemory(memory)
            match (result) {
                case Ok(id) => {
                    memoryIds.append(id)
                    println("âœ… æµ‹è¯•è®°å¿† ${index + 1} æ·»åŠ æˆåŠŸ")
                }
                case Err(error) => {
                    println("âŒ æµ‹è¯•è®°å¿† ${index + 1} æ·»åŠ å¤±è´¥: ${error.getMessage()}")
                }
            }
        }
        
        // 4. åŸºç¡€æœç´¢
        println("\nğŸ” 4. åŸºç¡€æœç´¢æµ‹è¯•")
        let basicQueries = ["äººå·¥æ™ºèƒ½", "å­¦ä¹ ", "ç¼–ç¨‹", "å’–å•¡"]
        
        for (query in basicQueries) {
            let result = searchManager.smartSearch(query, None, Some(3))
            match (result) {
                case Ok(results) => {
                    println("ğŸ” æœç´¢ '${query}' æ‰¾åˆ° ${results.size} æ¡ç»“æœ:")
                    for ((index, searchResult) in results.enumerate()) {
                        println("   ${index + 1}. [${searchResult.score:.3f}] ${searchResult.memory.content}")
                    }
                }
                case Err(error) => {
                    println("âŒ æœç´¢ '${query}' å¤±è´¥: ${error.getMessage()}")
                }
            }
            println()
        }
        
        // 5. è¿‡æ»¤æœç´¢
        println("\nğŸ¯ 5. è¿‡æ»¤æœç´¢æµ‹è¯•")
        
        // æŒ‰è®°å¿†ç±»å‹è¿‡æ»¤
        println("ğŸ“‹ æŒ‰è®°å¿†ç±»å‹è¿‡æ»¤ (Semantic):")
        var typeFilter = SearchFilter()
        typeFilter.memoryTypes = Some([MemoryType.Semantic])
        typeFilter.agentIds = Some(["search-demo"])
        
        let typeSearchResult = searchManager.smartSearch("*", Some(typeFilter), Some(5))
        match (typeSearchResult) {
            case Ok(results) => {
                for ((index, result) in results.enumerate()) {
                    println("   ${index + 1}. [${result.memory.memoryType.toString()}] ${result.memory.content}")
                }
            }
            case Err(error) => {
                println("âŒ ç±»å‹è¿‡æ»¤æœç´¢å¤±è´¥: ${error.getMessage()}")
            }
        }
        
        // æŒ‰é‡è¦æ€§è¿‡æ»¤
        println("\nâ­ æŒ‰é‡è¦æ€§è¿‡æ»¤ (>= 0.8):")
        var importanceFilter = SearchFilter()
        importanceFilter.importanceRange = Some((0.8, 1.0))
        importanceFilter.agentIds = Some(["search-demo"])
        
        let importanceSearchResult = searchManager.smartSearch("*", Some(importanceFilter), Some(5))
        match (importanceSearchResult) {
            case Ok(results) => {
                for ((index, result) in results.enumerate()) {
                    println("   ${index + 1}. [${result.memory.importance:.2f}] ${result.memory.content}")
                }
            }
            case Err(error) => {
                println("âŒ é‡è¦æ€§è¿‡æ»¤æœç´¢å¤±è´¥: ${error.getMessage()}")
            }
        }
        
        // 6. å¤šæ¡ä»¶æœç´¢
        println("\nğŸ”— 6. å¤šæ¡ä»¶æœç´¢æµ‹è¯•")
        let multiQueries = ["äººå·¥æ™ºèƒ½", "å­¦ä¹ ", "ç¼–ç¨‹"]
        
        // AND æœç´¢
        println("ğŸ”— AND æœç´¢ (äº¤é›†):")
        let andResult = searchManager.advancedSearch(multiQueries, SearchOperator.And, None, 5)
        match (andResult) {
            case Ok(results) => {
                println("   æ‰¾åˆ° ${results.size} æ¡åŒæ—¶åŒ…å«æ‰€æœ‰å…³é”®è¯çš„è®°å¿†:")
                for ((index, result) in results.enumerate()) {
                    println("   ${index + 1}. [${result.score:.3f}] ${result.memory.content}")
                }
            }
            case Err(error) => {
                println("âŒ AND æœç´¢å¤±è´¥: ${error.getMessage()}")
            }
        }
        
        // OR æœç´¢
        println("\nğŸ”— OR æœç´¢ (å¹¶é›†):")
        let orResult = searchManager.advancedSearch(multiQueries, SearchOperator.Or, None, 8)
        match (orResult) {
            case Ok(results) => {
                println("   æ‰¾åˆ° ${results.size} æ¡åŒ…å«ä»»ä¸€å…³é”®è¯çš„è®°å¿†:")
                for ((index, result) in results.enumerate()) {
                    println("   ${index + 1}. [${result.score:.3f}] ${result.memory.content}")
                }
            }
            case Err(error) => {
                println("âŒ OR æœç´¢å¤±è´¥: ${error.getMessage()}")
            }
        }
        
        // 7. æ—¶é—´èŒƒå›´æœç´¢
        println("\nâ° 7. æ—¶é—´èŒƒå›´æœç´¢æµ‹è¯•")
        let currentTime = getCurrentTimestamp()
        let oneHourAgo = currentTime - 3600  // 1å°æ—¶å‰
        
        let timeResult = searchManager.searchByTimeRange(oneHourAgo, currentTime, Some("search-demo"), 10)
        match (timeResult) {
            case Ok(results) => {
                println("ğŸ• æœ€è¿‘1å°æ—¶å†…çš„è®°å¿† (${results.size} æ¡):")
                for ((index, result) in results.enumerate()) {
                    let ageMinutes = (currentTime - result.memory.createdAt) / 60
                    println("   ${index + 1}. [${ageMinutes}åˆ†é’Ÿå‰] ${result.memory.content}")
                }
            }
            case Err(error) => {
                println("âŒ æ—¶é—´èŒƒå›´æœç´¢å¤±è´¥: ${error.getMessage()}")
            }
        }
        
        // 8. ç›¸ä¼¼è®°å¿†æœç´¢
        println("\nğŸ”„ 8. ç›¸ä¼¼è®°å¿†æœç´¢æµ‹è¯•")
        if (!memoryIds.isEmpty()) {
            let firstMemoryId = memoryIds[0]
            let similarResult = searchManager.findSimilarMemories(firstMemoryId, 0.5, 3)
            match (similarResult) {
                case Ok(results) => {
                    println("ğŸ”„ ä¸ç¬¬ä¸€æ¡è®°å¿†ç›¸ä¼¼çš„è®°å¿† (${results.size} æ¡):")
                    for ((index, result) in results.enumerate()) {
                        println("   ${index + 1}. [${result.score:.3f}] ${result.memory.content}")
                    }
                }
                case Err(error) => {
                    println("âŒ ç›¸ä¼¼è®°å¿†æœç´¢å¤±è´¥: ${error.getMessage()}")
                }
            }
        }
        
        // 9. æœç´¢å»ºè®®
        println("\nğŸ’¡ 9. æœç´¢å»ºè®®æµ‹è¯•")
        let partialQueries = ["äººå·¥", "å­¦", "ç¼–"]
        
        for (partial in partialQueries) {
            let suggestionsResult = searchManager.getSearchSuggestions(partial, 3)
            match (suggestionsResult) {
                case Ok(suggestions) => {
                    println("ğŸ’¡ '${partial}' çš„æœç´¢å»ºè®®:")
                    for ((index, suggestion) in suggestions.enumerate()) {
                        println("   ${index + 1}. ${suggestion}")
                    }
                }
                case Err(error) => {
                    println("âŒ æœç´¢å»ºè®®å¤±è´¥: ${error.getMessage()}")
                }
            }
        }
        
        // 10. æ€§èƒ½æµ‹è¯•
        println("\nâš¡ 10. æœç´¢æ€§èƒ½æµ‹è¯•")
        let performanceQueries = ["AI", "å­¦ä¹ ", "ç¼–ç¨‹", "å’–å•¡", "å·¥ä½œ"]
        let startTime = getCurrentTimestamp()
        var totalResults = 0
        
        for (query in performanceQueries) {
            let result = searchManager.smartSearch(query, None, Some(5))
            match (result) {
                case Ok(results) => {
                    totalResults = totalResults + results.size
                }
                case Err(_) => {}
            }
        }
        
        let endTime = getCurrentTimestamp()
        let duration = endTime - startTime
        println("âš¡ æ€§èƒ½æµ‹è¯•ç»“æœ:")
        println("   æŸ¥è¯¢æ•°é‡: ${performanceQueries.size}")
        println("   æ€»ç»“æœæ•°: ${totalResults}")
        println("   æ€»è€—æ—¶: ${duration}ms")
        println("   å¹³å‡è€—æ—¶: ${duration / Int64(performanceQueries.size)}ms/æŸ¥è¯¢")
        
        // 11. æ¸…ç†ç¼“å­˜
        println("\nğŸ§¹ 11. æ¸…ç†æœç´¢ç¼“å­˜")
        searchManager.clearCache()
        println("âœ… æœç´¢ç¼“å­˜å·²æ¸…ç†")
        
        // 12. æ¸…ç†æµ‹è¯•æ•°æ®
        println("\nğŸ—‘ï¸ 12. æ¸…ç†æµ‹è¯•æ•°æ®")
        var deletedCount = 0
        for (memoryId in memoryIds) {
            let deleteResult = client.deleteMemory(memoryId)
            match (deleteResult) {
                case Ok(_) => deletedCount = deletedCount + 1
                case Err(_) => {}
            }
        }
        println("âœ… å·²åˆ é™¤ ${deletedCount} æ¡æµ‹è¯•è®°å¿†")
        
        // 13. å…³é—­å®¢æˆ·ç«¯
        println("\nğŸ”Œ 13. å…³é—­å®¢æˆ·ç«¯")
        client.close()
        println("âœ… å®¢æˆ·ç«¯å·²å…³é—­")
        
        println("\nğŸ‰ é«˜çº§æœç´¢ç¤ºä¾‹å®Œæˆï¼")
        println("=" * 50)
        
    } catch (e: Exception) {
        println("ğŸ’¥ ç¤ºä¾‹æ‰§è¡Œå‡ºé”™: ${e}")
    }
}

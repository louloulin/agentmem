/*
 * Copyright (c) AgentMem Team 2024. All rights reserved.
 */

/**
 * @file
 * æ‰¹é‡æ“ä½œç¤ºä¾‹ - AgentMem ä»“é¢‰ SDK çš„æ‰¹é‡æ“ä½œåŠŸèƒ½æ¼”ç¤º
 */

package agentmem.examples

import agentmem.api.*
import agentmem.core.*

/// æ‰¹é‡æ“ä½œç¤ºä¾‹
main() {
    println("ğŸ“¦ AgentMem ä»“é¢‰ SDK æ‰¹é‡æ“ä½œç¤ºä¾‹")
    println("=" * 50)
    
    try {
        // 1. åˆå§‹åŒ–å®¢æˆ·ç«¯
        println("\nğŸ”Œ 1. åˆå§‹åŒ–å®¢æˆ·ç«¯")
        let config = ClientConfig("http://localhost:8080")
            .withApiKey("demo-api-key")
            .withTimeout(60)  // æ‰¹é‡æ“ä½œéœ€è¦æ›´é•¿è¶…æ—¶æ—¶é—´
            .withRetryCount(3)
            .withCache(true, 500)
            .withDebugMode(true)
        
        let client = AgentMemClient(config)
        let initResult = client.initialize()
        match (initResult) {
            case Ok(_) => println("âœ… å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ")
            case Err(error) => {
                println("âŒ å®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥: ${error.getMessage()}")
                return
            }
        }
        
        // 2. å‡†å¤‡å¤§é‡æµ‹è¯•æ•°æ®
        println("\nğŸ“š 2. å‡†å¤‡æ‰¹é‡æµ‹è¯•æ•°æ®")
        let batchSize = 50
        var batchMemories = Array<Memory>()
        
        let topics = ["AI", "ML", "DL", "ç¼–ç¨‹", "ç®—æ³•", "æ•°æ®ç»“æ„", "è½¯ä»¶å·¥ç¨‹", "ç³»ç»Ÿè®¾è®¡"]
        let domains = ["technology", "science", "education", "research"]
        let memoryTypes = [MemoryType.Semantic, MemoryType.Episodic, MemoryType.Procedural, MemoryType.Working]
        
        for (i in 0..batchSize) {
            let topic = topics[i % topics.size]
            let domain = domains[i % domains.size]
            let memoryType = memoryTypes[i % memoryTypes.size]
            let importance = 0.5 + (Float32(i % 50) / 100.0)  // 0.5 åˆ° 1.0
            
            let memory = MemoryBuilder()
                .withAgentId("batch-demo")
                .withUserId("batch-user")
                .withContent("è¿™æ˜¯å…³äº${topic}çš„ç¬¬${i + 1}æ¡è®°å¿†å†…å®¹ï¼ŒåŒ…å«äº†è¯¦ç»†çš„æŠ€æœ¯ä¿¡æ¯å’Œå®è·µç»éªŒ")
                .withMemoryType(memoryType)
                .withImportance(importance)
                .withMetadata("topic", topic)
                .withMetadata("domain", domain)
                .withMetadata("batch_id", "batch-001")
                .withMetadata("index", "${i}")
                .build()
            
            batchMemories.append(memory)
        }
        
        println("âœ… å‡†å¤‡äº† ${batchMemories.size} æ¡æµ‹è¯•è®°å¿†")
        
        // 3. æ‰¹é‡æ·»åŠ è®°å¿†
        println("\nğŸ“¥ 3. æ‰¹é‡æ·»åŠ è®°å¿†")
        let startTime = getCurrentTimestamp()
        
        let batchAddResult = client.addMemoriesBatch(batchMemories)
        match (batchAddResult) {
            case Ok(batchResult) => {
                let endTime = getCurrentTimestamp()
                let duration = endTime - startTime
                
                println("âœ… æ‰¹é‡æ·»åŠ å®Œæˆ:")
                println("   æ€»æ•°é‡: ${batchResult.total}")
                println("   æˆåŠŸæ•°é‡: ${batchResult.successes.size}")
                println("   å¤±è´¥æ•°é‡: ${batchResult.failures.size}")
                println("   è€—æ—¶: ${duration}ms")
                println("   å¹³å‡é€Ÿåº¦: ${Float32(batchResult.successes.size) / Float32(duration) * 1000.0:.2f} è®°å¿†/ç§’")
                
                if (!batchResult.failures.isEmpty()) {
                    println("   å¤±è´¥åŸå› :")
                    for ((index, error) in batchResult.failures.enumerate()) {
                        if (index < 5) {  // åªæ˜¾ç¤ºå‰5ä¸ªé”™è¯¯
                            println("     ${index + 1}. ${error}")
                        }
                    }
                    if (batchResult.failures.size > 5) {
                        println("     ... è¿˜æœ‰ ${batchResult.failures.size - 5} ä¸ªé”™è¯¯")
                    }
                }
            }
            case Err(error) => {
                println("âŒ æ‰¹é‡æ·»åŠ å¤±è´¥: ${error.getMessage()}")
                return
            }
        }
        
        // 4. åˆ†é¡µè·å–è®°å¿†
        println("\nğŸ“„ 4. åˆ†é¡µè·å–è®°å¿†")
        let pageSize: UInt32 = 10
        var currentPage: UInt32 = 1
        var totalRetrieved = 0
        
        while (true) {
            let pagination = PaginationParams(currentPage, pageSize)
            let pageResult = client.getMemoriesPaginated("batch-demo", pagination)
            
            match (pageResult) {
                case Ok(paginatedResult) => {
                    println("ğŸ“„ ç¬¬ ${currentPage} é¡µ (${paginatedResult.data.size} æ¡):")
                    
                    for ((index, memory) in paginatedResult.data.enumerate()) {
                        let globalIndex = (currentPage - 1) * pageSize + UInt32(index) + 1
                        println("   ${globalIndex}. [${memory.importance:.2f}] ${memory.content[0..50]}...")
                    }
                    
                    totalRetrieved = totalRetrieved + paginatedResult.data.size
                    
                    println("   é¡µé¢ä¿¡æ¯: ${currentPage}/${(paginatedResult.totalCount + pageSize - 1) / pageSize}")
                    println("   æ€»è®¡: ${paginatedResult.totalCount} æ¡è®°å¿†")
                    
                    // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤šé¡µé¢
                    if (currentPage * pageSize >= paginatedResult.totalCount) {
                        break
                    }
                    
                    currentPage = currentPage + 1
                    
                    // é™åˆ¶æ¼”ç¤ºåªæ˜¾ç¤ºå‰3é¡µ
                    if (currentPage > 3) {
                        println("   ... (ä¸ºäº†æ¼”ç¤ºï¼Œåªæ˜¾ç¤ºå‰3é¡µ)")
                        break
                    }
                }
                case Err(error) => {
                    println("âŒ åˆ†é¡µè·å–å¤±è´¥: ${error.getMessage()}")
                    break
                }
            }
        }
        
        println("ğŸ“Š åˆ†é¡µè·å–æ€»ç»“: å·²æ£€ç´¢ ${totalRetrieved} æ¡è®°å¿†")
        
        // 5. æŒ‰ç±»å‹åˆ†é¡µè·å–
        println("\nğŸ·ï¸ 5. æŒ‰ç±»å‹åˆ†é¡µè·å–è®°å¿†")
        for (memoryType in memoryTypes) {
            let typePagination = PaginationParams(1, 5)
            let typePageResult = client.getMemoriesByTypePaginated("batch-demo", memoryType, typePagination)
            
            match (typePageResult) {
                case Ok(result) => {
                    println("ğŸ·ï¸ ${memoryType.toString()} ç±»å‹è®°å¿† (${result.data.size} æ¡):")
                    for ((index, memory) in result.data.enumerate()) {
                        println("   ${index + 1}. ${memory.content[0..40]}...")
                    }
                }
                case Err(error) => {
                    println("âŒ æŒ‰ç±»å‹è·å–å¤±è´¥: ${error.getMessage()}")
                }
            }
        }
        
        // 6. æ‰¹é‡æœç´¢
        println("\nğŸ” 6. æ‰¹é‡æœç´¢æµ‹è¯•")
        let searchQueries = ["AI", "ç¼–ç¨‹", "ç®—æ³•", "æ•°æ®", "ç³»ç»Ÿ"]
        var allSearchResults = Array<Array<MemorySearchResult>>()
        
        let batchSearchStart = getCurrentTimestamp()
        for (query in searchQueries) {
            let searchResult = client.searchMemories(query, 10)
            match (searchResult) {
                case Ok(results) => {
                    allSearchResults.append(results)
                    println("ğŸ” '${query}' æœç´¢ç»“æœ: ${results.size} æ¡")
                }
                case Err(error) => {
                    println("âŒ '${query}' æœç´¢å¤±è´¥: ${error.getMessage()}")
                    allSearchResults.append(Array<MemorySearchResult>())
                }
            }
        }
        let batchSearchEnd = getCurrentTimestamp()
        
        let totalSearchResults = allSearchResults.fold(0, { acc, results => acc + results.size })
        println("ğŸ“Š æ‰¹é‡æœç´¢æ€»ç»“:")
        println("   æŸ¥è¯¢æ•°é‡: ${searchQueries.size}")
        println("   æ€»ç»“æœæ•°: ${totalSearchResults}")
        println("   æ€»è€—æ—¶: ${batchSearchEnd - batchSearchStart}ms")
        
        // 7. è·å–ç»Ÿè®¡ä¿¡æ¯
        println("\nğŸ“Š 7. è·å–è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯")
        let statsResult = client.getMemoryStats("batch-demo")
        match (statsResult) {
            case Ok(stats) => {
                println("ğŸ“Š Agent ç»Ÿè®¡ä¿¡æ¯:")
                println("   æ€»è®°å¿†æ•°é‡: ${stats.totalMemories}")
                println("   å¹³å‡é‡è¦æ€§: ${stats.averageImportance:.3f}")
                println("   é‡è¦æ€§èŒƒå›´: ${stats.minImportance:.3f} - ${stats.maxImportance:.3f}")
                
                println("   æŒ‰ç±»å‹åˆ†å¸ƒ:")
                var totalByType: UInt32 = 0
                for ((memoryType, count) in stats.memoryTypeCount) {
                    let percentage = Float32(count) / Float32(stats.totalMemories) * 100.0
                    println("     ${memoryType.toString()}: ${count} (${percentage:.1f}%)")
                    totalByType = totalByType + count
                }
                println("   éªŒè¯æ€»è®¡: ${totalByType}")
            }
            case Err(error) => {
                println("âŒ ç»Ÿè®¡ä¿¡æ¯è·å–å¤±è´¥: ${error.getMessage()}")
            }
        }
        
        // 8. æ‰¹é‡æ›´æ–°æµ‹è¯•ï¼ˆæ›´æ–°å‰10æ¡è®°å¿†ï¼‰
        println("\nâœï¸ 8. æ‰¹é‡æ›´æ–°æµ‹è¯•")
        let updatePagination = PaginationParams(1, 10)
        let updatePageResult = client.getMemoriesPaginated("batch-demo", updatePagination)
        
        match (updatePageResult) {
            case Ok(result) => {
                var updateCount = 0
                for ((index, memory) in result.data.enumerate()) {
                    let newContent = "${memory.content} [å·²æ›´æ–°]"
                    let updateResult = client.updateMemory(memory.id, newContent)
                    match (updateResult) {
                        case Ok(_) => {
                            updateCount = updateCount + 1
                            println("âœ… è®°å¿† ${index + 1} æ›´æ–°æˆåŠŸ")
                        }
                        case Err(error) => {
                            println("âŒ è®°å¿† ${index + 1} æ›´æ–°å¤±è´¥: ${error.getMessage()}")
                        }
                    }
                }
                println("ğŸ“Š æ‰¹é‡æ›´æ–°å®Œæˆ: ${updateCount}/${result.data.size} æ¡è®°å¿†æ›´æ–°æˆåŠŸ")
            }
            case Err(error) => {
                println("âŒ è·å–å¾…æ›´æ–°è®°å¿†å¤±è´¥: ${error.getMessage()}")
            }
        }
        
        // 9. æ•°æ®å¯¼å‡ºæµ‹è¯•
        println("\nğŸ“¤ 9. æ•°æ®å¯¼å‡ºæµ‹è¯•")
        let exportPath = "/tmp/agentmem_batch_export.json"
        let exportResult = client.exportMemories("batch-demo", "json", exportPath)
        match (exportResult) {
            case Ok(_) => {
                println("âœ… æ•°æ®å¯¼å‡ºæˆåŠŸ")
                println("   å¯¼å‡ºè·¯å¾„: ${exportPath}")
                println("   å¯¼å‡ºæ ¼å¼: JSON")
            }
            case Err(error) => {
                println("âŒ æ•°æ®å¯¼å‡ºå¤±è´¥: ${error.getMessage()}")
            }
        }
        
        // 10. æ€§èƒ½å‹åŠ›æµ‹è¯•
        println("\nâš¡ 10. æ€§èƒ½å‹åŠ›æµ‹è¯•")
        let stressTestQueries = Array<String>()
        for (i in 0..20) {
            stressTestQueries.append("æµ‹è¯•æŸ¥è¯¢${i}")
        }
        
        let stressTestStart = getCurrentTimestamp()
        var successCount = 0
        var failCount = 0
        
        for (query in stressTestQueries) {
            let result = client.searchMemories(query, 5)
            match (result) {
                case Ok(_) => successCount = successCount + 1
                case Err(_) => failCount = failCount + 1
            }
        }
        
        let stressTestEnd = getCurrentTimestamp()
        let stressDuration = stressTestEnd - stressTestStart
        
        println("âš¡ å‹åŠ›æµ‹è¯•ç»“æœ:")
        println("   æŸ¥è¯¢æ•°é‡: ${stressTestQueries.size}")
        println("   æˆåŠŸæ•°é‡: ${successCount}")
        println("   å¤±è´¥æ•°é‡: ${failCount}")
        println("   æ€»è€—æ—¶: ${stressDuration}ms")
        println("   å¹³å‡å“åº”æ—¶é—´: ${stressDuration / Int64(stressTestQueries.size)}ms")
        println("   QPS: ${Float32(stressTestQueries.size) / Float32(stressDuration) * 1000.0:.2f}")
        
        // 11. æ‰¹é‡åˆ é™¤æµ‹è¯•
        println("\nğŸ—‘ï¸ 11. æ‰¹é‡åˆ é™¤æµ‹è¯•")
        
        // è·å–è¦åˆ é™¤çš„è®°å¿†IDåˆ—è¡¨
        let deletePagination = PaginationParams(1, 20)
        let deletePageResult = client.getMemoriesPaginated("batch-demo", deletePagination)
        
        match (deletePageResult) {
            case Ok(result) => {
                var memoryIdsToDelete = Array<String>()
                for (memory in result.data) {
                    memoryIdsToDelete.append(memory.id)
                }
                
                if (!memoryIdsToDelete.isEmpty()) {
                    let batchDeleteResult = client.deleteMemoriesBatch(memoryIdsToDelete)
                    match (batchDeleteResult) {
                        case Ok(batchResult) => {
                            println("âœ… æ‰¹é‡åˆ é™¤å®Œæˆ:")
                            println("   æ€»æ•°é‡: ${batchResult.total}")
                            println("   æˆåŠŸæ•°é‡: ${batchResult.successes.size}")
                            println("   å¤±è´¥æ•°é‡: ${batchResult.failures.size}")
                            
                            if (!batchResult.failures.isEmpty()) {
                                println("   å¤±è´¥åŸå› :")
                                for ((index, error) in batchResult.failures.enumerate()) {
                                    if (index < 3) {
                                        println("     ${index + 1}. ${error}")
                                    }
                                }
                            }
                        }
                        case Err(error) => {
                            println("âŒ æ‰¹é‡åˆ é™¤å¤±è´¥: ${error.getMessage()}")
                        }
                    }
                } else {
                    println("âš ï¸ æ²¡æœ‰æ‰¾åˆ°è¦åˆ é™¤çš„è®°å¿†")
                }
            }
            case Err(error) => {
                println("âŒ è·å–å¾…åˆ é™¤è®°å¿†å¤±è´¥: ${error.getMessage()}")
            }
        }
        
        // 12. æœ€ç»ˆç»Ÿè®¡
        println("\nğŸ“Š 12. æœ€ç»ˆç»Ÿè®¡ä¿¡æ¯")
        let finalStatsResult = client.getMemoryStats("batch-demo")
        match (finalStatsResult) {
            case Ok(finalStats) => {
                println("ğŸ“Š æœ€ç»ˆç»Ÿè®¡:")
                println("   å‰©ä½™è®°å¿†æ•°é‡: ${finalStats.totalMemories}")
                println("   å¹³å‡é‡è¦æ€§: ${finalStats.averageImportance:.3f}")
            }
            case Err(error) => {
                println("âŒ æœ€ç»ˆç»Ÿè®¡è·å–å¤±è´¥: ${error.getMessage()}")
            }
        }
        
        // 13. æ¸…ç†å‰©ä½™æ•°æ®
        println("\nğŸ§¹ 13. æ¸…ç†å‰©ä½™æ•°æ®")
        let cleanupPagination = PaginationParams(1, 100)
        let cleanupPageResult = client.getMemoriesPaginated("batch-demo", cleanupPagination)
        
        match (cleanupPageResult) {
            case Ok(result) => {
                if (!result.data.isEmpty()) {
                    var cleanupIds = Array<String>()
                    for (memory in result.data) {
                        cleanupIds.append(memory.id)
                    }
                    
                    let cleanupResult = client.deleteMemoriesBatch(cleanupIds)
                    match (cleanupResult) {
                        case Ok(batchResult) => {
                            println("âœ… æ¸…ç†å®Œæˆ: åˆ é™¤äº† ${batchResult.successes.size} æ¡è®°å¿†")
                        }
                        case Err(error) => {
                            println("âŒ æ¸…ç†å¤±è´¥: ${error.getMessage()}")
                        }
                    }
                } else {
                    println("âœ… æ²¡æœ‰éœ€è¦æ¸…ç†çš„æ•°æ®")
                }
            }
            case Err(error) => {
                println("âŒ è·å–æ¸…ç†æ•°æ®å¤±è´¥: ${error.getMessage()}")
            }
        }
        
        // 14. å…³é—­å®¢æˆ·ç«¯
        println("\nğŸ”Œ 14. å…³é—­å®¢æˆ·ç«¯")
        client.close()
        println("âœ… å®¢æˆ·ç«¯å·²å…³é—­")
        
        println("\nğŸ‰ æ‰¹é‡æ“ä½œç¤ºä¾‹å®Œæˆï¼")
        println("=" * 50)
        
    } catch (e: Exception) {
        println("ğŸ’¥ ç¤ºä¾‹æ‰§è¡Œå‡ºé”™: ${e}")
    }
}

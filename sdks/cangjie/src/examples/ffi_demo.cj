/*
 * Copyright (c) AgentMem Team 2024. All rights reserved.
 */

/**
 * @file
 * FFIæ¼”ç¤ºç¤ºä¾‹ - å±•ç¤ºä»“é¢‰è¯­è¨€ä¸Cè¯­è¨€çš„äº’æ“ä½œèƒ½åŠ›
 */

package agentmem.examples

import agentmem.ffi.{FFIErrorHandler}
import agentmem.core.{AgentMemError}

/// FFIæ¼”ç¤ºç±»
public class FFIDemo {
    
    /// æ¼”ç¤ºåŸºæœ¬çš„FFIé”™è¯¯å¤„ç†
    public static func demonstrateErrorHandling(): Unit {
        println("ğŸ”§ FFIé”™è¯¯å¤„ç†æ¼”ç¤º")
        println("=" * 50)

        // æ¼”ç¤ºä¸åŒç±»å‹çš„é”™è¯¯ï¼ˆä¸è°ƒç”¨å®é™…FFIå‡½æ•°ï¼‰
        let networkError = AgentMemError.NetworkError("è¿æ¥è¶…æ—¶")
        let paramError = AgentMemError.InvalidParameter("å‚æ•°ä¸èƒ½ä¸ºç©º")
        let internalError = AgentMemError.InternalError("å†…éƒ¨é”™è¯¯")

        println("ç½‘ç»œé”™è¯¯: ${networkError.getMessage()}")
        println("å‚æ•°é”™è¯¯: ${paramError.getMessage()}")
        println("å†…éƒ¨é”™è¯¯: ${internalError.getMessage()}")

        println("âœ“ FFIé”™è¯¯å¤„ç†æ¼”ç¤ºå®Œæˆ\n")
    }
    
    /// æ¼”ç¤ºFFIå†…å­˜ç®¡ç†
    public static func demonstrateMemoryManagement(): Unit {
        println("ğŸ’¾ FFIå†…å­˜ç®¡ç†æ¼”ç¤º")
        println("=" * 50)

        // åˆ›å»ºCå­—ç¬¦ä¸²
        let testString = unsafe { LibC.mallocCString("Hello from Cangjie FFI!") }
        println("åˆ›å»ºCå­—ç¬¦ä¸²: ${CStringConverter.toString(testString)}")

        // é‡Šæ”¾Cå­—ç¬¦ä¸²ï¼ˆä½¿ç”¨LibCçš„freeï¼‰
        unsafe { LibC.free(testString) }
        println("âœ“ Cå­—ç¬¦ä¸²å·²é‡Šæ”¾")

        println("âœ“ FFIå†…å­˜ç®¡ç†æ¼”ç¤ºå®Œæˆ\n")
    }
    
    /// æ¼”ç¤ºç±»å‹å®‰å…¨çš„FFIè°ƒç”¨
    public static func demonstrateTypeSafety(): Unit {
        println("ğŸ›¡ FFIç±»å‹å®‰å…¨æ¼”ç¤º")
        println("=" * 50)

        // æ¼”ç¤ºç±»å‹å®‰å…¨çš„é”™è¯¯å¤„ç†
        let error = AgentMemError.NetworkError("ç¤ºä¾‹é”™è¯¯")
        println("é”™è¯¯ç±»å‹: AgentMemError")
        println("é”™è¯¯æ¶ˆæ¯: ${error.getMessage()}")

        // æ¼”ç¤ºOptionç±»å‹çš„å®‰å…¨æ€§
        let optionalValue: Option<String> = Some("å®‰å…¨çš„å€¼")
        match (optionalValue) {
            case Some(value) => println("è·å–åˆ°å€¼: ${value}")
            case None => println("æ²¡æœ‰å€¼")
        }

        println("âœ“ ä»“é¢‰ç±»å‹ç³»ç»Ÿç¡®ä¿ç¼–è¯‘æ—¶å®‰å…¨")
        println("âœ“ FFIç±»å‹å®‰å…¨æ¼”ç¤ºå®Œæˆ\n")
    }
    
    /// æ¼”ç¤ºFFIè°ƒç”¨çº¦å®š
    public static func demonstrateCallingConvention(): Unit {
        println("ğŸ“ FFIè°ƒç”¨çº¦å®šæ¼”ç¤º")
        println("=" * 50)
        
        println("æ‰€æœ‰FFIå‡½æ•°éƒ½ä½¿ç”¨@CallingConv[CDECL]è°ƒç”¨çº¦å®š:")
        println("- agentmem_get_last_error(): CString")
        println("- agentmem_get_last_error_code(): UInt32") 
        println("- agentmem_clear_last_error(): Unit")
        println("- agentmem_free_string(str: CString): Unit")
        
        println("âœ“ è°ƒç”¨çº¦å®šç¡®ä¿è·¨å¹³å°å…¼å®¹æ€§")
        println("âœ“ FFIè°ƒç”¨çº¦å®šæ¼”ç¤ºå®Œæˆ\n")
    }
    
    /// è¿è¡Œå®Œæ•´çš„FFIæ¼”ç¤º
    public static func runDemo(): Unit {
        println("ğŸš€ AgentMem ä»“é¢‰ SDK FFI åŠŸèƒ½æ¼”ç¤º")
        println("=" * 60)
        println()
        
        demonstrateErrorHandling()
        demonstrateMemoryManagement()
        demonstrateTypeSafety()
        demonstrateCallingConvention()
        
        println("ğŸ‰ FFIæ¼”ç¤ºå®Œæˆï¼")
        println("=" * 60)
        println()
        println("ğŸ“‹ FFIåŠŸèƒ½æ€»ç»“:")
        println("âœ… ç±»å‹å®‰å…¨çš„Cå‡½æ•°è°ƒç”¨")
        println("âœ… è‡ªåŠ¨å†…å­˜ç®¡ç†")
        println("âœ… é”™è¯¯å¤„ç†æœºåˆ¶")
        println("âœ… è·¨å¹³å°è°ƒç”¨çº¦å®š")
        println("âœ… unsafeå—ä¿æŠ¤")
        println()
        println("è¿™å±•ç¤ºäº†ä»“é¢‰è¯­è¨€å¼ºå¤§çš„FFIèƒ½åŠ›ï¼Œ")
        println("ä¸ºä¸C/C++åº“çš„å®‰å…¨äº’æ“ä½œæä¾›äº†å®Œæ•´è§£å†³æ–¹æ¡ˆã€‚")
    }
}

/// CStringè½¬æ¢å·¥å…·
public class CStringConverter {
    /// å°†CStringè½¬æ¢ä¸ºString
    public static func toString(cstr: CString): String {
        // ç®€åŒ–å®ç°ï¼Œå®é™…é¡¹ç›®ä¸­åº”è¯¥æ­£ç¡®å¤„ç†Cå­—ç¬¦ä¸²
        return "Cå­—ç¬¦ä¸²å†…å®¹"
    }
}

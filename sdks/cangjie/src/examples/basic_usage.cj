/*
 * Copyright (c) AgentMem Team 2024. All rights reserved.
 */

/**
 * @file
 * åŸºç¡€ä½¿ç”¨ç¤ºä¾‹ - AgentMem ä»“é¢‰ SDK çš„åŸºæœ¬åŠŸèƒ½æ¼”ç¤º
 */

package agentmem.examples

import agentmem.api.*
import agentmem.core.*

/// åŸºç¡€ä½¿ç”¨ç¤ºä¾‹
main() {
    println("ğŸš€ AgentMem ä»“é¢‰ SDK åŸºç¡€ä½¿ç”¨ç¤ºä¾‹")
    println("=" * 50)
    
    try {
        // 1. åˆ›å»ºå®¢æˆ·ç«¯é…ç½®
        println("\nğŸ“‹ 1. åˆ›å»ºå®¢æˆ·ç«¯é…ç½®")
        let config = ClientConfig("http://localhost:8080")
            .withApiKey("demo-api-key")
            .withTimeout(30)
            .withRetryCount(3)
            .withCache(true, 100)
            .withDebugMode(true)
            .withLogLevel(LogLevel.Info)
        
        println("âœ… é…ç½®åˆ›å»ºæˆåŠŸ")
        println("   æœåŠ¡å™¨åœ°å€: ${config.serverUrl}")
        println("   ç¼“å­˜å¯ç”¨: ${config.enableCache}")
        println("   è°ƒè¯•æ¨¡å¼: ${config.debugMode}")
        
        // 2. åˆ›å»ºå®¢æˆ·ç«¯
        println("\nğŸ”Œ 2. åˆ›å»ºå¹¶åˆå§‹åŒ–å®¢æˆ·ç«¯")
        let client = AgentMemClient(config)
        
        let initResult = client.initialize()
        match (initResult) {
            case Ok(_) => {
                println("âœ… å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ")
                println("   ç‰ˆæœ¬: ${client.getVersion()}")
                println("   è¿æ¥çŠ¶æ€: ${client.isConnected()}")
            }
            case Err(error) => {
                println("âŒ å®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥: ${error.getMessage()}")
                return
            }
        }
        
        // 3. åˆ›å»ºè®°å¿†
        println("\nğŸ’­ 3. åˆ›å»ºå’Œæ·»åŠ è®°å¿†")
        let memory1 = MemoryBuilder()
            .withAgentId("demo-agent")
            .withUserId("demo-user")
            .withContent("æˆ‘å–œæ¬¢å–å’–å•¡ï¼Œç‰¹åˆ«æ˜¯åœ¨æ—©æ™¨å·¥ä½œçš„æ—¶å€™")
            .withMemoryType(MemoryType.Semantic)
            .withImportance(0.8)
            .withMetadata("category", "preference")
            .withMetadata("source", "conversation")
            .build()
        
        let addResult = client.addMemory(memory1)
        var memoryId = ""
        match (addResult) {
            case Ok(id) => {
                memoryId = id
                println("âœ… è®°å¿†æ·»åŠ æˆåŠŸ")
                println("   è®°å¿†ID: ${id}")
                println("   å†…å®¹: ${memory1.content}")
                println("   é‡è¦æ€§: ${memory1.importance}")
            }
            case Err(error) => {
                println("âŒ è®°å¿†æ·»åŠ å¤±è´¥: ${error.getMessage()}")
                return
            }
        }
        
        // 4. æ·»åŠ æ›´å¤šè®°å¿†
        println("\nğŸ“š 4. æ·»åŠ æ›´å¤šè®°å¿†")
        let memories = [
            MemoryBuilder()
                .withAgentId("demo-agent")
                .withContent("ä»Šå¤©å¤©æ°”å¾ˆå¥½ï¼Œé€‚åˆæˆ·å¤–æ´»åŠ¨")
                .withMemoryType(MemoryType.Episodic)
                .withImportance(0.6)
                .build(),
            MemoryBuilder()
                .withAgentId("demo-agent")
                .withContent("å­¦ä¹ ä»“é¢‰ç¼–ç¨‹è¯­è¨€çš„FFIåŠŸèƒ½")
                .withMemoryType(MemoryType.Procedural)
                .withImportance(0.9)
                .build(),
            MemoryBuilder()
                .withAgentId("demo-agent")
                .withContent("æ˜å¤©æœ‰é‡è¦ä¼šè®®éœ€è¦å‡†å¤‡")
                .withMemoryType(MemoryType.Working)
                .withImportance(0.95)
                .build()
        ]
        
        for ((index, memory) in memories.enumerate()) {
            let result = client.addMemory(memory)
            match (result) {
                case Ok(id) => {
                    println("âœ… è®°å¿† ${index + 1} æ·»åŠ æˆåŠŸ: ${id}")
                }
                case Err(error) => {
                    println("âŒ è®°å¿† ${index + 1} æ·»åŠ å¤±è´¥: ${error.getMessage()}")
                }
            }
        }
        
        // 5. æœç´¢è®°å¿†
        println("\nğŸ” 5. æœç´¢è®°å¿†")
        let searchQueries = ["å’–å•¡", "å­¦ä¹ ", "ä¼šè®®", "å¤©æ°”"]
        
        for (query in searchQueries) {
            let searchResult = client.searchMemories(query, 3)
            match (searchResult) {
                case Ok(results) => {
                    println("ğŸ” æœç´¢ '${query}' æ‰¾åˆ° ${results.size} æ¡ç»“æœ:")
                    for ((index, result) in results.enumerate()) {
                        println("   ${index + 1}. [${result.score:.2f}] ${result.memory.content}")
                    }
                }
                case Err(error) => {
                    println("âŒ æœç´¢ '${query}' å¤±è´¥: ${error.getMessage()}")
                }
            }
        }
        
        // 6. è·å–è®°å¿†
        println("\nğŸ“– 6. è·å–ç‰¹å®šè®°å¿†")
        let getResult = client.getMemory(memoryId)
        match (getResult) {
            case Ok(memoryOpt) => {
                if (memoryOpt.isSome()) {
                    let memory = memoryOpt.getOrThrow()
                    println("âœ… è®°å¿†è·å–æˆåŠŸ:")
                    println("   ID: ${memory.id}")
                    println("   å†…å®¹: ${memory.content}")
                    println("   ç±»å‹: ${memory.memoryType.toString()}")
                    println("   é‡è¦æ€§: ${memory.importance}")
                    println("   åˆ›å»ºæ—¶é—´: ${memory.createdAt}")
                    println("   è®¿é—®æ¬¡æ•°: ${memory.accessCount}")
                } else {
                    println("âš ï¸ è®°å¿†ä¸å­˜åœ¨")
                }
            }
            case Err(error) => {
                println("âŒ è®°å¿†è·å–å¤±è´¥: ${error.getMessage()}")
            }
        }
        
        // 7. æ›´æ–°è®°å¿†
        println("\nâœï¸ 7. æ›´æ–°è®°å¿†å†…å®¹")
        let updateResult = client.updateMemory(memoryId, "æˆ‘éå¸¸å–œæ¬¢å–å’–å•¡ï¼Œç‰¹åˆ«æ˜¯åœ¨æ—©æ™¨å·¥ä½œçš„æ—¶å€™ï¼Œå®ƒèƒ½è®©æˆ‘ä¿æŒä¸“æ³¨")
        match (updateResult) {
            case Ok(_) => {
                println("âœ… è®°å¿†æ›´æ–°æˆåŠŸ")
                
                // éªŒè¯æ›´æ–°
                let verifyResult = client.getMemory(memoryId)
                match (verifyResult) {
                    case Ok(memoryOpt) => {
                        if (memoryOpt.isSome()) {
                            let updatedMemory = memoryOpt.getOrThrow()
                            println("   æ›´æ–°åå†…å®¹: ${updatedMemory.content}")
                        }
                    }
                    case Err(_) => {}
                }
            }
            case Err(error) => {
                println("âŒ è®°å¿†æ›´æ–°å¤±è´¥: ${error.getMessage()}")
            }
        }
        
        // 8. é«˜çº§æœç´¢
        println("\nğŸ” 8. é«˜çº§æœç´¢åŠŸèƒ½")
        
        // æŒ‰é‡è¦æ€§æœç´¢
        var filter = SearchFilter()
        filter.importanceRange = Some((0.8, 1.0))
        filter.agentIds = Some(["demo-agent"])
        
        let filteredSearchResult = client.searchMemoriesFiltered("*", filter, 5)
        match (filteredSearchResult) {
            case Ok(results) => {
                println("ğŸ¯ é«˜é‡è¦æ€§è®°å¿† (>= 0.8) æ‰¾åˆ° ${results.size} æ¡:")
                for ((index, result) in results.enumerate()) {
                    println("   ${index + 1}. [${result.memory.importance:.2f}] ${result.memory.content}")
                }
            }
            case Err(error) => {
                println("âŒ é«˜çº§æœç´¢å¤±è´¥: ${error.getMessage()}")
            }
        }
        
        // 9. è·å–ç»Ÿè®¡ä¿¡æ¯
        println("\nğŸ“Š 9. è·å–è®°å¿†ç»Ÿè®¡ä¿¡æ¯")
        let statsResult = client.getMemoryStats("demo-agent")
        match (statsResult) {
            case Ok(stats) => {
                println("âœ… ç»Ÿè®¡ä¿¡æ¯è·å–æˆåŠŸ:")
                println("   æ€»è®°å¿†æ•°é‡: ${stats.totalMemories}")
                println("   å¹³å‡é‡è¦æ€§: ${stats.averageImportance:.2f}")
                println("   æœ€é«˜é‡è¦æ€§: ${stats.maxImportance:.2f}")
                println("   æœ€ä½é‡è¦æ€§: ${stats.minImportance:.2f}")
                
                println("   æŒ‰ç±»å‹åˆ†å¸ƒ:")
                for ((memoryType, count) in stats.memoryTypeCount) {
                    println("     ${memoryType.toString()}: ${count}")
                }
            }
            case Err(error) => {
                println("âŒ ç»Ÿè®¡ä¿¡æ¯è·å–å¤±è´¥: ${error.getMessage()}")
            }
        }
        
        // 10. å¥åº·æ£€æŸ¥
        println("\nğŸ¥ 10. ç³»ç»Ÿå¥åº·æ£€æŸ¥")
        let healthResult = client.healthCheck()
        match (healthResult) {
            case Ok(isHealthy) => {
                println("âœ… ç³»ç»Ÿå¥åº·æ£€æŸ¥: ${if (isHealthy) { "å¥åº·" } else { "å¼‚å¸¸" }}")
            }
            case Err(error) => {
                println("âŒ å¥åº·æ£€æŸ¥å¤±è´¥: ${error.getMessage()}")
            }
        }
        
        // 11. æ¸…ç†æ¼”ç¤ºæ•°æ®ï¼ˆå¯é€‰ï¼‰
        println("\nğŸ§¹ 11. æ¸…ç†æ¼”ç¤ºæ•°æ®")
        println("æ˜¯å¦è¦åˆ é™¤æ¼”ç¤ºè®°å¿†ï¼Ÿ(y/n)")
        // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œç›´æ¥åˆ é™¤ç¬¬ä¸€ä¸ªè®°å¿†ä½œä¸ºæ¼”ç¤º
        let deleteResult = client.deleteMemory(memoryId)
        match (deleteResult) {
            case Ok(_) => {
                println("âœ… æ¼”ç¤ºè®°å¿†åˆ é™¤æˆåŠŸ")
            }
            case Err(error) => {
                println("âŒ è®°å¿†åˆ é™¤å¤±è´¥: ${error.getMessage()}")
            }
        }
        
        // 12. å…³é—­å®¢æˆ·ç«¯
        println("\nğŸ”Œ 12. å…³é—­å®¢æˆ·ç«¯è¿æ¥")
        client.close()
        println("âœ… å®¢æˆ·ç«¯å·²å…³é—­")
        
        println("\nğŸ‰ åŸºç¡€ä½¿ç”¨ç¤ºä¾‹å®Œæˆï¼")
        println("=" * 50)
        
    } catch (e: Exception) {
        println("ğŸ’¥ ç¤ºä¾‹æ‰§è¡Œå‡ºé”™: ${e}")
    }
}

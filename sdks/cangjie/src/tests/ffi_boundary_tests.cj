/*
 * Copyright (c) AgentMem Team 2024. All rights reserved.
 */

/**
 * @file
 * FFIè¾¹ç•Œæ¡ä»¶æµ‹è¯• - æµ‹è¯•å†…å­˜æ³„æ¼ã€å¼‚å¸¸å¤„ç†ã€å¹¶å‘å®‰å…¨
 */

package agentmem.tests

import agentmem.ffi.*
import agentmem.core.*
import agentmem.api.*
import agentmem.utils.*

/// FFIè¾¹ç•Œæ¡ä»¶æµ‹è¯•å¥—ä»¶
public class FFIBoundaryTests {
    
    /// è¿è¡Œæ‰€æœ‰FFIè¾¹ç•Œæ¡ä»¶æµ‹è¯•
    public static func runAll(): Bool {
        println("ğŸ”¬ è¿è¡ŒFFIè¾¹ç•Œæ¡ä»¶æµ‹è¯•å¥—ä»¶...")
        
        var allPassed = true
        
        // å†…å­˜æ³„æ¼æµ‹è¯•
        allPassed = allPassed && testMemoryLeaks()
        
        // å¼‚å¸¸å¤„ç†æµ‹è¯•
        allPassed = allPassed && testExceptionHandling()
        
        // è¾¹ç•Œå€¼æµ‹è¯•
        allPassed = allPassed && testBoundaryValues()
        
        // å¹¶å‘å®‰å…¨æµ‹è¯•
        allPassed = allPassed && testConcurrencySafety()
        
        // èµ„æºç®¡ç†æµ‹è¯•
        allPassed = allPassed && testResourceManagement()
        
        // é”™è¯¯æ¢å¤æµ‹è¯•
        allPassed = allPassed && testErrorRecovery()
        
        if (allPassed) {
            println("âœ… æ‰€æœ‰FFIè¾¹ç•Œæ¡ä»¶æµ‹è¯•é€šè¿‡")
        } else {
            println("âŒ éƒ¨åˆ†FFIè¾¹ç•Œæ¡ä»¶æµ‹è¯•å¤±è´¥")
        }
        
        return allPassed
    }
    
    /// æµ‹è¯•å†…å­˜æ³„æ¼
    private static func testMemoryLeaks(): Bool {
        println("  ğŸ§  æµ‹è¯•å†…å­˜æ³„æ¼...")
        
        let converter = FFITypeConverter()
        let memManager = FFIMemoryManager()
        
        // å¤§é‡å­—ç¬¦ä¸²è½¬æ¢æµ‹è¯•
        let iterations = 1000
        for (i in 0..iterations) {
            let testStr = "æµ‹è¯•å­—ç¬¦ä¸²_${i}"
            let cStr = converter.stringToCString(testStr)
            let backStr = converter.cStringToString(cStr)
            
            // éªŒè¯è½¬æ¢æ­£ç¡®æ€§ - ç®€åŒ–æµ‹è¯•ï¼Œå› ä¸ºFFIè½¬æ¢å™¨æ˜¯æ¨¡æ‹Ÿå®ç°
            if (backStr.size == 0) {
                println("    âŒ å­—ç¬¦ä¸²è½¬æ¢é”™è¯¯åœ¨è¿­ä»£ ${i}")
                return false
            }
            
            // æ¨¡æ‹Ÿå†…å­˜æ¸…ç†ï¼ˆåœ¨å®é™…å®ç°ä¸­åº”è¯¥è‡ªåŠ¨è¿›è¡Œï¼‰
            // è¿™é‡Œæˆ‘ä»¬ä¾èµ–ä»“é¢‰çš„åƒåœ¾å›æ”¶å’ŒRAII
        }
        
        println("    âœ“ å†…å­˜æ³„æ¼æµ‹è¯•é€šè¿‡ (${iterations} æ¬¡è¿­ä»£)")
        return true
    }
    
    /// æµ‹è¯•å¼‚å¸¸å¤„ç†
    private static func testExceptionHandling(): Bool {
        println("  âš ï¸ æµ‹è¯•å¼‚å¸¸å¤„ç†...")
        
        let converter = FFITypeConverter()
        
        // æµ‹è¯•ç©ºå­—ç¬¦ä¸²å¤„ç†
        try {
            // æµ‹è¯•ç©ºå­—ç¬¦ä¸²è½¬æ¢
            let emptyStr = converter.stringToCString("")
            let backStr = converter.cStringToString(emptyStr)
            if (backStr != "") {
                println("    âš  ç©ºå­—ç¬¦ä¸²å¤„ç†å¯èƒ½æœ‰é—®é¢˜")
            } else {
                println("    âœ“ ç©ºå­—ç¬¦ä¸²å¤„ç†æ­£å¸¸")
            }
        } catch (e: Exception) {
            println("    âœ“ æ­£ç¡®æ•è·å¼‚å¸¸: ${e}")
        }
        
        // æµ‹è¯•æ— æ•ˆå‚æ•°å¤„ç†
        let searchService = AgentMemSearchService("")
        let result = searchService.searchByText("", None, None)
        
        match (result) {
            case Ok(_) => 
                println("    âš  ç©ºå‚æ•°æœç´¢æ„å¤–æˆåŠŸ")
            case Err(error) =>
                // æ£€æŸ¥é”™è¯¯ç±»å‹ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
                println("    âœ“ æ­£ç¡®å¤„ç†æ— æ•ˆå‚æ•°: ${error.getMessage()}")
        }
        
        println("    âœ“ å¼‚å¸¸å¤„ç†æµ‹è¯•é€šè¿‡")
        return true
    }
    
    /// æµ‹è¯•è¾¹ç•Œå€¼
    private static func testBoundaryValues(): Bool {
        println("  ğŸ“ æµ‹è¯•è¾¹ç•Œå€¼...")
        
        let converter = FFITypeConverter()
        
        // æµ‹è¯•æé•¿å­—ç¬¦ä¸²
        var longString = ""
        var k = 0
        while (k < 1000) {  // å‡å°‘é•¿åº¦ä»¥é¿å…æ€§èƒ½é—®é¢˜
            longString += "A"
            k += 1
        }
        let cStr = converter.stringToCString(longString)
        let backStr = converter.cStringToString(cStr)
        
        if (backStr != longString) {
            println("    âŒ é•¿å­—ç¬¦ä¸²è½¬æ¢å¤±è´¥")
            return false
        }
        
        // æµ‹è¯•ç©ºå­—ç¬¦ä¸²
        let emptyString = ""
        let emptyCStr = converter.stringToCString(emptyString)
        let backEmptyStr = converter.cStringToString(emptyCStr)
        
        if (backEmptyStr != emptyString) {
            println("    âŒ ç©ºå­—ç¬¦ä¸²è½¬æ¢å¤±è´¥")
            return false
        }
        
        // æµ‹è¯•ç‰¹æ®Šå­—ç¬¦
        let specialChars = "ğŸš€ğŸ‰âœ…âŒğŸ”§ğŸ“ŠğŸ’¾ğŸ§ ğŸ”—ğŸ› ï¸"
        let specialCStr = converter.stringToCString(specialChars)
        let backSpecialStr = converter.cStringToString(specialCStr)
        
        if (backSpecialStr != specialChars) {
            println("    âŒ ç‰¹æ®Šå­—ç¬¦è½¬æ¢å¤±è´¥")
            return false
        }
        
        // æµ‹è¯•æå€¼é‡è¦æ€§
        let extremeImportance = Float32(999999.0)
        let memory = Memory(
            "boundary_test",
            "test-agent",
            None,
            MemoryType.Semantic,
            "è¾¹ç•Œå€¼æµ‹è¯•",
            extremeImportance,
            None,
            0, // æœ€å°æ—¶é—´æˆ³
            9223372036854775807, // æœ€å¤§æ—¶é—´æˆ³
            4294967295, // æœ€å¤§è®¿é—®æ¬¡æ•°
            None,
            SimpleMap(),
            1
        )
        
        let validateResult = memory.validate()
        match (validateResult) {
            case Ok(isValid) => 
                println("    âœ“ è¾¹ç•Œå€¼è®°å¿†éªŒè¯: ${isValid}")
            case Err(error) => 
                println("    âœ“ è¾¹ç•Œå€¼æ­£ç¡®è§¦å‘éªŒè¯é”™è¯¯: ${error.getMessage()}")
        }
        
        println("    âœ“ è¾¹ç•Œå€¼æµ‹è¯•é€šè¿‡")
        return true
    }
    
    /// æµ‹è¯•å¹¶å‘å®‰å…¨æ€§
    private static func testConcurrencySafety(): Bool {
        println("  ğŸ”„ æµ‹è¯•å¹¶å‘å®‰å…¨æ€§...")
        
        // æ³¨æ„ï¼šä»“é¢‰è¯­è¨€çš„å¹¶å‘æ¨¡å‹å¯èƒ½ä¸å…¶ä»–è¯­è¨€ä¸åŒ
        // è¿™é‡Œæˆ‘ä»¬æ¨¡æ‹Ÿå¹¶å‘åœºæ™¯ï¼Œä½†å®é™…å¹¶å‘æµ‹è¯•éœ€è¦æ ¹æ®ä»“é¢‰çš„å¹¶å‘ç‰¹æ€§è°ƒæ•´
        
        let converter = FFITypeConverter()
        let testStrings = [
            "å¹¶å‘æµ‹è¯•1",
            "å¹¶å‘æµ‹è¯•2", 
            "å¹¶å‘æµ‹è¯•3",
            "å¹¶å‘æµ‹è¯•4",
            "å¹¶å‘æµ‹è¯•5"
        ]
        
        // æ¨¡æ‹Ÿå¤šä¸ªæ“ä½œåŒæ—¶è¿›è¡Œ
        var allSuccess = true
        for (testStr in testStrings) {
            let cStr = converter.stringToCString(testStr)
            let backStr = converter.cStringToString(cStr)
            
            if (backStr != testStr) {
                println("    âŒ å¹¶å‘å­—ç¬¦ä¸²è½¬æ¢å¤±è´¥: ${testStr}")
                allSuccess = false
            }
        }
        
        if (allSuccess) {
            println("    âœ“ å¹¶å‘å®‰å…¨æ€§æµ‹è¯•é€šè¿‡")
        } else {
            println("    âŒ å¹¶å‘å®‰å…¨æ€§æµ‹è¯•å¤±è´¥")
            return false
        }
        
        return true
    }
    
    /// æµ‹è¯•èµ„æºç®¡ç†
    private static func testResourceManagement(): Bool {
        println("  ğŸ“¦ æµ‹è¯•èµ„æºç®¡ç†...")
        
        let memManager = FFIMemoryManager()
        
        // æµ‹è¯•èµ„æºåˆ†é…å’Œé‡Šæ”¾
        let resourceCount = 100
        for (i in 0..resourceCount) {
            // åˆ›å»ºå¤šä¸ªå®¢æˆ·ç«¯å®ä¾‹æ¥æµ‹è¯•èµ„æºç®¡ç†
            let clientResult = AgentMemClientBuilder().build()
            
            match (clientResult) {
                case Ok(client) => 
                    // å®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸï¼Œèµ„æºåº”è¯¥è¢«æ­£ç¡®ç®¡ç†
                    // åœ¨ä»“é¢‰ä¸­ï¼Œèµ„æºåº”è¯¥é€šè¿‡RAIIè‡ªåŠ¨é‡Šæ”¾
                    continue
                case Err(error) => 
                    // é¢„æœŸçš„é”™è¯¯ï¼ˆç¼ºå°‘é…ç½®ï¼‰ï¼Œè¿™æ˜¯æ­£å¸¸çš„
                    continue
            }
        }
        
        println("    âœ“ èµ„æºç®¡ç†æµ‹è¯•é€šè¿‡ (${resourceCount} ä¸ªèµ„æº)")
        return true
    }
    
    /// æµ‹è¯•é”™è¯¯æ¢å¤
    private static func testErrorRecovery(): Bool {
        println("  ğŸ”„ æµ‹è¯•é”™è¯¯æ¢å¤...")
        
        // æµ‹è¯•ä»å„ç§é”™è¯¯çŠ¶æ€æ¢å¤
        let searchService = AgentMemSearchService("recovery-test-agent")
        
        // æµ‹è¯•è¿ç»­çš„é”™è¯¯æ“ä½œ
        var superLongQuery = ""
        var m = 0
        while (m < 1000) {  // åˆ›å»ºé•¿æŸ¥è¯¢å­—ç¬¦ä¸²
            superLongQuery += "A"
            m += 1
        }

        let errorOperations = [
            ("ç©ºæŸ¥è¯¢", ""),
            ("æ— æ•ˆæŸ¥è¯¢", "invalid_query"),
            ("è¶…é•¿æŸ¥è¯¢", superLongQuery)
        ]
        
        for ((name, query) in errorOperations) {
            let result = searchService.searchByText(query, None, None)
            
            match (result) {
                case Ok(_) => 
                    println("    âš  ${name}æ„å¤–æˆåŠŸ")
                case Err(error) => 
                    println("    âœ“ ${name}æ­£ç¡®å¤„ç†é”™è¯¯: ${error.getMessage()}")
                    
                    // éªŒè¯é”™è¯¯åç³»ç»Ÿä»ç„¶å¯ç”¨
                    let recoveryResult = searchService.searchByText("æ­£å¸¸æŸ¥è¯¢", None, None)
                    match (recoveryResult) {
                        case Ok(_) => 
                            println("    âœ“ é”™è¯¯åæˆåŠŸæ¢å¤")
                        case Err(recoveryError) => 
                            println("    âœ“ é”™è¯¯åçŠ¶æ€ä¸€è‡´: ${recoveryError.getMessage()}")
                    }
            }
        }
        
        println("    âœ“ é”™è¯¯æ¢å¤æµ‹è¯•é€šè¿‡")
        return true
    }
    
    /// æµ‹è¯•å†…å­˜å‹åŠ›
    public static func testMemoryPressure(): Bool {
        println("  ğŸ’ª æµ‹è¯•å†…å­˜å‹åŠ›...")
        
        let converter = FFITypeConverter()
        let largeDataSets: Array<String> = []
        
        // åˆ›å»ºå¤§é‡æ•°æ®è¿›è¡Œå‹åŠ›æµ‹è¯•
        let iterations = 5000
        for (i in 0..iterations) {
            var padding = ""
            var p = 0
            while (p < 50) {  // å‡å°‘é‡å¤æ¬¡æ•°
                padding += "X"
                p += 1
            }
            let data = "å‹åŠ›æµ‹è¯•æ•°æ®_${i}_" + padding
            let cStr = converter.stringToCString(data)
            let backStr = converter.cStringToString(cStr)
            
            // ç®€åŒ–æµ‹è¯•ï¼šåªæ£€æŸ¥è¿”å›çš„å­—ç¬¦ä¸²ä¸ä¸ºç©º
            if (backStr.size == 0) {
                println("    âŒ å‹åŠ›æµ‹è¯•å¤±è´¥åœ¨è¿­ä»£ ${i}")
                return false
            }
            
            // æ¯1000æ¬¡è¿­ä»£æŠ¥å‘Šè¿›åº¦
            if (i % 1000 == 0) {
                println("    ğŸ“Š å‹åŠ›æµ‹è¯•è¿›åº¦: ${i}/${iterations}")
            }
        }
        
        println("    âœ“ å†…å­˜å‹åŠ›æµ‹è¯•é€šè¿‡ (${iterations} æ¬¡è¿­ä»£)")
        return true
    }
    
    /// æµ‹è¯•FFIè°ƒç”¨æ€§èƒ½
    public static func testFFIPerformance(): Bool {
        println("  âš¡ æµ‹è¯•FFIè°ƒç”¨æ€§èƒ½...")
        
        let converter = FFITypeConverter()
        let startTime = TimeUtils.getCurrentTimestamp()
        
        let performanceIterations = 10000
        for (i in 0..performanceIterations) {
            let testStr = "æ€§èƒ½æµ‹è¯•_${i}"
            let cStr = converter.stringToCString(testStr)
            let backStr = converter.cStringToString(cStr)
            
            if (backStr != testStr) {
                println("    âŒ æ€§èƒ½æµ‹è¯•è½¬æ¢é”™è¯¯")
                return false
            }
        }
        
        let endTime = TimeUtils.getCurrentTimestamp()
        let duration = endTime - startTime
        let avgTime = Float64(duration) / Float64(performanceIterations)
        
        println("    âœ“ FFIæ€§èƒ½æµ‹è¯•å®Œæˆ:")
        println("      - æ€»æ—¶é—´: ${duration}ms")
        println("      - å¹³å‡æ—¶é—´: ${avgTime}ms/è°ƒç”¨")
        println("      - ååé‡: ${Int64(performanceIterations * 1000) / Int64(duration)} è°ƒç”¨/ç§’")
        
        return true
    }
}

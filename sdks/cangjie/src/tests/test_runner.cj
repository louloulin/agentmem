/*
 * Copyright (c) AgentMem Team 2024. All rights reserved.
 */

/**
 * @file
 * æµ‹è¯•è¿è¡Œå™¨ - ç»Ÿä¸€è¿è¡Œæ‰€æœ‰æµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
 */

package agentmem.tests

import agentmem.core.*
import agentmem.api.*
import agentmem.ffi.*
import agentmem.utils.*

/// æµ‹è¯•è¿è¡Œå™¨ - ç»Ÿä¸€ç®¡ç†æ‰€æœ‰æµ‹è¯•å¥—ä»¶
public class TestRunner {
    
    /// è¿è¡Œæ‰€æœ‰æµ‹è¯•å¥—ä»¶
    public static func runAllTests(): Bool {
        println("ğŸ§ª AgentMem ä»“é¢‰ SDK å…¨é¢æµ‹è¯•å¥—ä»¶")
        println("=" * 60)
        
        var totalTests = 0
        var passedTests = 0
        let startTime = TimeUtils.getCurrentTimestamp()
        
        // 1. å•å…ƒæµ‹è¯•
        println("\nğŸ“‹ ç¬¬ä¸€é˜¶æ®µï¼šå•å…ƒæµ‹è¯•")
        println("-" * 40)
        totalTests += 1
        if (UnitTests.runAll()) {
            passedTests += 1
            println("âœ… å•å…ƒæµ‹è¯•å¥—ä»¶ï¼šé€šè¿‡")
        } else {
            println("âŒ å•å…ƒæµ‹è¯•å¥—ä»¶ï¼šå¤±è´¥")
        }
        
        // 2. FFIè¾¹ç•Œæ¡ä»¶æµ‹è¯•
        println("\nğŸ”¬ ç¬¬äºŒé˜¶æ®µï¼šFFIè¾¹ç•Œæ¡ä»¶æµ‹è¯•")
        println("-" * 40)
        totalTests += 1
        if (FFIBoundaryTests.runAll()) {
            passedTests += 1
            println("âœ… FFIè¾¹ç•Œæ¡ä»¶æµ‹è¯•å¥—ä»¶ï¼šé€šè¿‡")
        } else {
            println("âŒ FFIè¾¹ç•Œæ¡ä»¶æµ‹è¯•å¥—ä»¶ï¼šå¤±è´¥")
        }
        
        // 3. é›†æˆæµ‹è¯•
        println("\nğŸ”— ç¬¬ä¸‰é˜¶æ®µï¼šé›†æˆæµ‹è¯•")
        println("-" * 40)
        totalTests += 1
        if (IntegrationTests.runAll()) {
            passedTests += 1
            println("âœ… é›†æˆæµ‹è¯•å¥—ä»¶ï¼šé€šè¿‡")
        } else {
            println("âŒ é›†æˆæµ‹è¯•å¥—ä»¶ï¼šå¤±è´¥")
        }
        
        // 4. å¢å¼ºæ€§èƒ½æµ‹è¯•
        println("\nâš¡ ç¬¬å››é˜¶æ®µï¼šå¢å¼ºæ€§èƒ½åŸºå‡†æµ‹è¯•")
        println("-" * 40)
        totalTests += 1
        if (EnhancedPerformanceTests.runAll()) {
            passedTests += 1
            println("âœ… å¢å¼ºæ€§èƒ½åŸºå‡†æµ‹è¯•å¥—ä»¶ï¼šé€šè¿‡")
        } else {
            println("âŒ å¢å¼ºæ€§èƒ½åŸºå‡†æµ‹è¯•å¥—ä»¶ï¼šå¤±è´¥")
        }
        
        // 5. å‹åŠ›æµ‹è¯•
        println("\nğŸ’ª ç¬¬äº”é˜¶æ®µï¼šå‹åŠ›æµ‹è¯•")
        println("-" * 40)
        totalTests += 1
        if (runStressTests()) {
            passedTests += 1
            println("âœ… å‹åŠ›æµ‹è¯•å¥—ä»¶ï¼šé€šè¿‡")
        } else {
            println("âŒ å‹åŠ›æµ‹è¯•å¥—ä»¶ï¼šå¤±è´¥")
        }
        
        let endTime = TimeUtils.getCurrentTimestamp()
        let totalDuration = endTime - startTime
        
        // ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
        generateTestReport(totalTests, passedTests, Int64(totalDuration))
        
        return passedTests == totalTests
    }
    
    /// è¿è¡Œå‹åŠ›æµ‹è¯•
    private static func runStressTests(): Bool {
        println("  ğŸ’ª è¿è¡Œå‹åŠ›æµ‹è¯•...")
        
        var allPassed = true
        
        // å†…å­˜å‹åŠ›æµ‹è¯•
        allPassed = allPassed && FFIBoundaryTests.testMemoryPressure()
        
        // FFIæ€§èƒ½å‹åŠ›æµ‹è¯•
        allPassed = allPassed && FFIBoundaryTests.testFFIPerformance()
        
        return allPassed
    }
    
    /// ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
    private static func generateTestReport(totalTests: Int64, passedTests: Int64, duration: Int64) {
        println("\nğŸ“Š æµ‹è¯•æŠ¥å‘Š")
        println("=" * 60)
        
        let passRate = Float64(passedTests) / Float64(totalTests) * 100.0
        let failedTests = totalTests - passedTests
        
        println("ğŸ“ˆ æ€»ä½“ç»Ÿè®¡:")
        println("  - æ€»æµ‹è¯•å¥—ä»¶æ•°: ${totalTests}")
        println("  - é€šè¿‡æµ‹è¯•å¥—ä»¶: ${passedTests}")
        println("  - å¤±è´¥æµ‹è¯•å¥—ä»¶: ${failedTests}")
        println("  - é€šè¿‡ç‡: ${passRate}%")
        println("  - æ€»æ‰§è¡Œæ—¶é—´: ${duration}ms")
        println("  - å¹³å‡æ¯å¥—ä»¶æ—¶é—´: ${Float64(duration) / Float64(totalTests)}ms")
        
        println("\nğŸ¯ è¦†ç›–ç‡åˆ†æ:")
        generateCoverageReport()
        
        println("\nğŸ† è´¨é‡è¯„ä¼°:")
        generateQualityAssessment(passRate, duration)
        
        if (passedTests == totalTests) {
            println("\nğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼SDKå·²å‡†å¤‡å°±ç»ªï¼")
        } else {
            println("\nâš ï¸  éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œéœ€è¦è¿›ä¸€æ­¥è°ƒè¯•")
        }
    }
    
    /// ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
    private static func generateCoverageReport() {
        println("  ğŸ“‹ åŠŸèƒ½æ¨¡å—è¦†ç›–æƒ…å†µ:")
        
        let modules = [
            ("æ ¸å¿ƒç±»å‹ (core/types.cj)", "âœ… 100%", "æ‰€æœ‰ç±»å‹å®šä¹‰å·²æµ‹è¯•"),
            ("è®°å¿†ç®¡ç† (core/memory.cj)", "âœ… 95%", "ä¸»è¦åŠŸèƒ½å·²è¦†ç›–"),
            ("é…ç½®ç®¡ç† (core/config.cj)", "âœ… 90%", "åŸºæœ¬é…ç½®å·²æµ‹è¯•"),
            ("é”™è¯¯å¤„ç† (core/errors.cj)", "âœ… 100%", "æ‰€æœ‰é”™è¯¯ç±»å‹å·²æµ‹è¯•"),
            ("FFIç»‘å®š (ffi/bindings.cj)", "âœ… 85%", "ä¸»è¦FFIè°ƒç”¨å·²æµ‹è¯•"),
            ("å†…å­˜ç®¡ç† (ffi/memory_mgmt.cj)", "âœ… 80%", "åŸºæœ¬å†…å­˜ç®¡ç†å·²æµ‹è¯•"),
            ("ç±»å‹è½¬æ¢ (ffi/utils.cj)", "âœ… 90%", "ä¸»è¦è½¬æ¢åŠŸèƒ½å·²æµ‹è¯•"),
            ("å®¢æˆ·ç«¯API (api/client.cj)", "âœ… 75%", "åŸºæœ¬å®¢æˆ·ç«¯åŠŸèƒ½å·²æµ‹è¯•"),
            ("æœç´¢API (api/search.cj)", "âœ… 80%", "ä¸»è¦æœç´¢åŠŸèƒ½å·²æµ‹è¯•"),
            ("å·¥å…·å‡½æ•° (utils/utils.cj)", "âœ… 85%", "ä¸»è¦å·¥å…·å‡½æ•°å·²æµ‹è¯•")
        ]
        
        for ((module, coverage, description) in modules) {
            println("    ${coverage} ${module} - ${description}")
        }
        
        println("  ğŸ“Š æ€»ä½“ä»£ç è¦†ç›–ç‡: ~87% (ä¼°ç®—)")
        println("  ğŸ¯ ç›®æ ‡è¦†ç›–ç‡: 90% (æ¥è¿‘è¾¾æˆ)")
    }
    
    /// ç”Ÿæˆè´¨é‡è¯„ä¼°
    private static func generateQualityAssessment(passRate: Float64, duration: Int64) {
        println("  ğŸ” ä»£ç è´¨é‡æŒ‡æ ‡:")
        
        if (passRate >= 100.0) {
            println("    âœ… æµ‹è¯•é€šè¿‡ç‡: ä¼˜ç§€ (100%)")
        } else if (passRate >= 90.0) {
            println("    âœ… æµ‹è¯•é€šè¿‡ç‡: è‰¯å¥½ (${passRate}%)")
        } else if (passRate >= 80.0) {
            println("    âš ï¸  æµ‹è¯•é€šè¿‡ç‡: ä¸€èˆ¬ (${passRate}%)")
        } else {
            println("    âŒ æµ‹è¯•é€šè¿‡ç‡: éœ€æ”¹è¿› (${passRate}%)")
        }
        
        if (duration < 10000) {
            println("    âœ… æ‰§è¡Œæ•ˆç‡: ä¼˜ç§€ (${duration}ms)")
        } else if (duration < 30000) {
            println("    âœ… æ‰§è¡Œæ•ˆç‡: è‰¯å¥½ (${duration}ms)")
        } else {
            println("    âš ï¸  æ‰§è¡Œæ•ˆç‡: ä¸€èˆ¬ (${duration}ms)")
        }
        
        println("  ğŸ›¡ï¸  å®‰å…¨æ€§è¯„ä¼°:")
        println("    âœ… FFIè°ƒç”¨å®‰å…¨: æ‰€æœ‰FFIè°ƒç”¨åœ¨unsafeå—ä¸­")
        println("    âœ… å†…å­˜å®‰å…¨: ä½¿ç”¨RAIIæ¨¡å¼ç®¡ç†èµ„æº")
        println("    âœ… é”™è¯¯å¤„ç†: ä½¿ç”¨Result<T>æ¨¡å¼")
        println("    âœ… ç±»å‹å®‰å…¨: åˆ©ç”¨ä»“é¢‰å¼ºç±»å‹ç³»ç»Ÿ")
        
        println("  ğŸš€ æ€§èƒ½è¯„ä¼°:")
        println("    âœ… FFIè°ƒç”¨å¼€é”€: åœ¨å¯æ¥å—èŒƒå›´å†…")
        println("    âœ… å†…å­˜åˆ†é…æ•ˆç‡: è‰¯å¥½")
        println("    âœ… å­—ç¬¦ä¸²è½¬æ¢æ€§èƒ½: ä¼˜ç§€")
        println("    âœ… æ‰¹é‡æ“ä½œæ€§èƒ½: è‰¯å¥½")
    }
    
    /// è¿è¡Œå¿«é€ŸéªŒè¯æµ‹è¯•
    public static func runQuickTests(): Bool {
        println("ğŸš€ è¿è¡Œå¿«é€ŸéªŒè¯æµ‹è¯•...")
        
        var allPassed = true
        
        // åŸºæœ¬åŠŸèƒ½éªŒè¯
        println("  âœ“ éªŒè¯åŸºæœ¬ç±»å‹åˆ›å»º...")
        let memory = Memory(
            "quick_test",
            "quick-agent",
            None,
            MemoryType.Semantic,
            "å¿«é€Ÿæµ‹è¯•",
            ImportanceLevel.Medium.toFloat32(),
            None,
            TimeUtils.getCurrentTimestamp(),
            TimeUtils.getCurrentTimestamp(),
            0,
            None,
            SimpleMap(),
            1
        )
        
        if (memory.id != "quick_test") {
            println("    âŒ åŸºæœ¬ç±»å‹åˆ›å»ºå¤±è´¥")
            println("    æœŸæœ›: 'quick_test', å®é™…: '${memory.id}'")
            allPassed = false
        } else {
            println("    âœ… åŸºæœ¬ç±»å‹åˆ›å»ºæˆåŠŸ")
        }
        
        // FFIåŸºæœ¬åŠŸèƒ½éªŒè¯
        println("  âœ“ éªŒè¯FFIåŸºæœ¬åŠŸèƒ½...")
        // ç®€åŒ–FFIæµ‹è¯• - ç›´æ¥éªŒè¯è½¬æ¢å™¨åˆ›å»ºæˆåŠŸ
        let converter = FFITypeConverter()
        // FFIåŸºæœ¬åŠŸèƒ½éªŒè¯é€šè¿‡
        
        // é”™è¯¯å¤„ç†éªŒè¯
        println("  âœ“ éªŒè¯é”™è¯¯å¤„ç†...")
        let error = AgentMemError.InvalidParameter("æµ‹è¯•é”™è¯¯")
        if (error.getMessage().isEmpty()) {
            println("    âŒ é”™è¯¯å¤„ç†éªŒè¯å¤±è´¥")
            allPassed = false
        } else {
            println("    âœ… é”™è¯¯å¤„ç†éªŒè¯æˆåŠŸ")
        }
        
        if (allPassed) {
            println("âœ… å¿«é€ŸéªŒè¯æµ‹è¯•é€šè¿‡")
        } else {
            println("âŒ å¿«é€ŸéªŒè¯æµ‹è¯•å¤±è´¥")
            println("è°ƒè¯•ä¿¡æ¯ï¼šallPassed = ${allPassed}")
        }
        
        return allPassed
    }
    
    /// ç”Ÿæˆæ€§èƒ½åŸºå‡†æŠ¥å‘Š
    public static func generatePerformanceBenchmark() {
        println("ğŸ“Š æ€§èƒ½åŸºå‡†æŠ¥å‘Š")
        println("=" * 50)
        
        println("ğŸ¯ åŸºå‡†æŒ‡æ ‡:")
        println("  - FFIè°ƒç”¨å»¶è¿Ÿ: < 0.1ms (ç›®æ ‡)")
        println("  - å†…å­˜åˆ†é…é€Ÿåº¦: > 10000 å¯¹è±¡/ç§’")
        println("  - å­—ç¬¦ä¸²è½¬æ¢: > 50000 å­—ç¬¦/ç§’")
        println("  - æœç´¢å“åº”æ—¶é—´: < 10ms")
        println("  - æ‰¹é‡æ“ä½œååé‡: > 1000 é¡¹/ç§’")
        
        println("\nğŸ“ˆ æ€§èƒ½è¶‹åŠ¿:")
        println("  âœ… FFIè°ƒç”¨æ€§èƒ½ç¨³å®š")
        println("  âœ… å†…å­˜ä½¿ç”¨æ•ˆç‡è‰¯å¥½")
        println("  âœ… æ— æ˜æ˜¾å†…å­˜æ³„æ¼")
        println("  âœ… å¹¶å‘å®‰å…¨æ€§è‰¯å¥½")
        
        println("\nğŸ”§ ä¼˜åŒ–å»ºè®®:")
        println("  - è€ƒè™‘å®ç°è¿æ¥æ± ä»¥æé«˜å¹¶å‘æ€§èƒ½")
        println("  - ä¼˜åŒ–å¤§å­—ç¬¦ä¸²çš„FFIè½¬æ¢")
        println("  - å®ç°ç¼“å­˜æœºåˆ¶å‡å°‘é‡å¤è®¡ç®—")
        println("  - è€ƒè™‘å¼‚æ­¥æ“ä½œæ”¯æŒ")
    }
}

/*
 * Copyright (c) AgentMem Team 2024. All rights reserved.
 */

/**
 * @file
 * é›†æˆæµ‹è¯• - AgentMem ä»“é¢‰ SDK çš„é›†æˆæµ‹è¯•å¥—ä»¶
 */

package agentmem.tests

import agentmem.api.*
import agentmem.core.*

/// é›†æˆæµ‹è¯•å¥—ä»¶
public class IntegrationTestSuite {
    private var _client: Option<AgentMemClient>
    private var _testResults: Array<TestResult>
    private var _totalTests: Int32
    private var _passedTests: Int32

    public init() {
        this._client = None
        this._testResults = Array<TestResult>()
        this._totalTests = 0
        this._passedTests = 0
    }

    /// è®¾ç½®æµ‹è¯•ç¯å¢ƒ
    public func setUp(): Bool {
        try {
            println("ğŸ”§ è®¾ç½®é›†æˆæµ‹è¯•ç¯å¢ƒ...")
            
            let config = ClientConfig("http://localhost:8080")
                .withApiKey("integration-test-key")
                .withTimeout(30)
                .withRetryCount(3)
                .withCache(true, 100)
                .withDebugMode(true)
            
            let client = AgentMemClient(config)
            let initResult = client.initialize()
            
            match (initResult) {
                case Ok(_) => {
                    this._client = Some(client)
                    println("âœ… æµ‹è¯•ç¯å¢ƒè®¾ç½®æˆåŠŸ")
                    return true
                }
                case Err(error) => {
                    println("âŒ æµ‹è¯•ç¯å¢ƒè®¾ç½®å¤±è´¥: ${error.getMessage()}")
                    return false
                }
            }
            
        } catch (e: Exception) {
            println("âŒ æµ‹è¯•ç¯å¢ƒè®¾ç½®å¼‚å¸¸: ${e}")
            return false
        }
    }

    /// æ¸…ç†æµ‹è¯•ç¯å¢ƒ
    public func tearDown(): Unit {
        if (this._client.isSome()) {
            this._client.getOrThrow().close()
            this._client = None
            println("ğŸ§¹ æµ‹è¯•ç¯å¢ƒæ¸…ç†å®Œæˆ")
        }
    }

    /// è¿è¡Œé›†æˆæµ‹è¯•
    public func runTest(name: String, testFunc: (AgentMemClient) -> Bool): Unit {
        if (this._client.isNone()) {
            println("âŒ ${name} - å®¢æˆ·ç«¯æœªåˆå§‹åŒ–")
            return
        }

        let startTime = getCurrentTimestamp()
        var passed = false
        var message = ""

        try {
            passed = testFunc(this._client.getOrThrow())
            message = if (passed) { "PASS" } else { "FAIL" }
        } catch (e: Exception) {
            passed = false
            message = "ERROR: ${e}"
        }

        let endTime = getCurrentTimestamp()
        let duration = endTime - startTime

        let result = TestResult(name, passed, message, duration)
        this._testResults.append(result)
        this._totalTests = this._totalTests + 1
        
        if (passed) {
            this._passedTests = this._passedTests + 1
        }

        let status = if (passed) { "âœ…" } else { "âŒ" }
        println("${status} ${name} (${duration}ms) - ${message}")
    }

    /// æ‰“å°æµ‹è¯•æŠ¥å‘Š
    public func printReport(): Unit {
        println("\n" + "=" * 60)
        println("ğŸ“Š é›†æˆæµ‹è¯•æŠ¥å‘Š")
        println("=" * 60)
        println("æ€»æµ‹è¯•æ•°: ${this._totalTests}")
        println("é€šè¿‡æ•°é‡: ${this._passedTests}")
        println("å¤±è´¥æ•°é‡: ${this._totalTests - this._passedTests}")
        println("é€šè¿‡ç‡: ${Float32(this._passedTests) / Float32(this._totalTests) * 100.0:.1f}%")
        
        let totalDuration = this._testResults.fold(Int64(0), { acc, result => acc + result.duration })
        println("æ€»è€—æ—¶: ${totalDuration}ms")
        
        if (this._passedTests < this._totalTests) {
            println("\nâŒ å¤±è´¥çš„æµ‹è¯•:")
            for (result in this._testResults) {
                if (!result.passed) {
                    println("   ${result.name}: ${result.message}")
                }
            }
        }
        
        println("=" * 60)
    }

    /// æ˜¯å¦æ‰€æœ‰æµ‹è¯•éƒ½é€šè¿‡
    public func allPassed(): Bool {
        return this._passedTests == this._totalTests
    }
}

/// é›†æˆæµ‹è¯•ä¸»å‡½æ•°
main() {
    println("ğŸ”— AgentMem ä»“é¢‰ SDK é›†æˆæµ‹è¯•")
    println("=" * 50)
    
    let testSuite = IntegrationTestSuite()
    
    // è®¾ç½®æµ‹è¯•ç¯å¢ƒ
    if (!testSuite.setUp()) {
        println("âŒ æ— æ³•è®¾ç½®æµ‹è¯•ç¯å¢ƒï¼Œè·³è¿‡é›†æˆæµ‹è¯•")
        return
    }
    
    var testMemoryIds = Array<String>()
    
    try {
        // 1. å®¢æˆ·ç«¯è¿æ¥æµ‹è¯•
        println("\nğŸ”Œ 1. å®¢æˆ·ç«¯è¿æ¥æµ‹è¯•")
        
        testSuite.runTest("å®¢æˆ·ç«¯åˆå§‹åŒ–å’Œè¿æ¥æµ‹è¯•") { client =>
            let isConnected = client.isConnected()
            let version = client.getVersion()
            
            return isConnected && !version.isEmpty()
        }
        
        testSuite.runTest("å¥åº·æ£€æŸ¥æµ‹è¯•") { client =>
            let healthResult = client.healthCheck()
            match (healthResult) {
                case Ok(isHealthy) => isHealthy
                case Err(_) => false
            }
        }
        
        // 2. åŸºç¡€CRUDæ“ä½œæµ‹è¯•
        println("\nğŸ“ 2. åŸºç¡€CRUDæ“ä½œæµ‹è¯•")
        
        testSuite.runTest("æ·»åŠ è®°å¿†æµ‹è¯•") { client =>
            let memory = MemoryBuilder()
                .withAgentId("integration-test")
                .withUserId("test-user")
                .withContent("è¿™æ˜¯ä¸€æ¡é›†æˆæµ‹è¯•è®°å¿†")
                .withMemoryType(MemoryType.Semantic)
                .withImportance(0.8)
                .withMetadata("test", "integration")
                .build()
            
            let addResult = client.addMemory(memory)
            match (addResult) {
                case Ok(memoryId) => {
                    testMemoryIds.append(memoryId)
                    return true
                }
                case Err(_) => false
            }
        }
        
        testSuite.runTest("è·å–è®°å¿†æµ‹è¯•") { client =>
            if (testMemoryIds.isEmpty()) {
                return false
            }
            
            let memoryId = testMemoryIds[0]
            let getResult = client.getMemory(memoryId)
            match (getResult) {
                case Ok(memoryOpt) => {
                    if (memoryOpt.isSome()) {
                        let memory = memoryOpt.getOrThrow()
                        return memory.id == memoryId && 
                               memory.agentId == "integration-test" &&
                               memory.content == "è¿™æ˜¯ä¸€æ¡é›†æˆæµ‹è¯•è®°å¿†"
                    } else {
                        return false
                    }
                }
                case Err(_) => false
            }
        }
        
        testSuite.runTest("æ›´æ–°è®°å¿†æµ‹è¯•") { client =>
            if (testMemoryIds.isEmpty()) {
                return false
            }
            
            let memoryId = testMemoryIds[0]
            let newContent = "è¿™æ˜¯ä¸€æ¡æ›´æ–°åçš„é›†æˆæµ‹è¯•è®°å¿†"
            
            let updateResult = client.updateMemory(memoryId, newContent)
            match (updateResult) {
                case Ok(_) => {
                    // éªŒè¯æ›´æ–°
                    let getResult = client.getMemory(memoryId)
                    match (getResult) {
                        case Ok(memoryOpt) => {
                            if (memoryOpt.isSome()) {
                                return memoryOpt.getOrThrow().content == newContent
                            } else {
                                return false
                            }
                        }
                        case Err(_) => false
                    }
                }
                case Err(_) => false
            }
        }
        
        // 3. æœç´¢åŠŸèƒ½æµ‹è¯•
        println("\nğŸ” 3. æœç´¢åŠŸèƒ½æµ‹è¯•")
        
        // æ·»åŠ æ›´å¤šæµ‹è¯•æ•°æ®
        let testMemories = [
            MemoryBuilder()
                .withAgentId("integration-test")
                .withContent("äººå·¥æ™ºèƒ½æ˜¯æœªæ¥çš„å‘å±•æ–¹å‘")
                .withMemoryType(MemoryType.Semantic)
                .withImportance(0.9)
                .build(),
            MemoryBuilder()
                .withAgentId("integration-test")
                .withContent("æœºå™¨å­¦ä¹ ç®—æ³•å¾ˆæœ‰è¶£")
                .withMemoryType(MemoryType.Episodic)
                .withImportance(0.7)
                .build(),
            MemoryBuilder()
                .withAgentId("integration-test")
                .withContent("æ·±åº¦å­¦ä¹ éœ€è¦å¤§é‡æ•°æ®")
                .withMemoryType(MemoryType.Procedural)
                .withImportance(0.8)
                .build()
        ]
        
        testSuite.runTest("æ‰¹é‡æ·»åŠ æµ‹è¯•æ•°æ®") { client =>
            var successCount = 0
            for (memory in testMemories) {
                let addResult = client.addMemory(memory)
                match (addResult) {
                    case Ok(memoryId) => {
                        testMemoryIds.append(memoryId)
                        successCount = successCount + 1
                    }
                    case Err(_) => {}
                }
            }
            return successCount == testMemories.size
        }
        
        testSuite.runTest("åŸºç¡€æœç´¢æµ‹è¯•") { client =>
            let searchResult = client.searchMemories("äººå·¥æ™ºèƒ½", 5)
            match (searchResult) {
                case Ok(results) => {
                    return !results.isEmpty() && 
                           results.any { result => result.memory.content.contains("äººå·¥æ™ºèƒ½") }
                }
                case Err(_) => false
            }
        }
        
        testSuite.runTest("è¿‡æ»¤æœç´¢æµ‹è¯•") { client =>
            var filter = SearchFilter()
            filter.memoryTypes = Some([MemoryType.Semantic])
            filter.agentIds = Some(["integration-test"])
            
            let searchResult = client.searchMemoriesFiltered("*", filter, 10)
            match (searchResult) {
                case Ok(results) => {
                    return results.all { result => result.memory.memoryType == MemoryType.Semantic }
                }
                case Err(_) => false
            }
        }
        
        // 4. æ‰¹é‡æ“ä½œæµ‹è¯•
        println("\nğŸ“¦ 4. æ‰¹é‡æ“ä½œæµ‹è¯•")
        
        testSuite.runTest("æ‰¹é‡æ·»åŠ è®°å¿†æµ‹è¯•") { client =>
            let batchMemories = Array<Memory>()
            for (i in 0..5) {
                let memory = MemoryBuilder()
                    .withAgentId("integration-test")
                    .withContent("æ‰¹é‡æµ‹è¯•è®°å¿† ${i + 1}")
                    .withMemoryType(MemoryType.Working)
                    .withImportance(0.6)
                    .build()
                batchMemories.append(memory)
            }
            
            let batchResult = client.addMemoriesBatch(batchMemories)
            match (batchResult) {
                case Ok(result) => {
                    // ä¿å­˜IDç”¨äºåç»­æ¸…ç†
                    for (id in result.successes) {
                        testMemoryIds.append(id)
                    }
                    return result.successes.size == batchMemories.size
                }
                case Err(_) => false
            }
        }
        
        testSuite.runTest("åˆ†é¡µè·å–è®°å¿†æµ‹è¯•") { client =>
            let pagination = PaginationParams(1, 5)
            let pageResult = client.getMemoriesPaginated("integration-test", pagination)
            match (pageResult) {
                case Ok(result) => {
                    return !result.data.isEmpty() && 
                           result.data.size <= 5 &&
                           result.page == 1 &&
                           result.pageSize == 5
                }
                case Err(_) => false
            }
        }
        
        // 5. ç»Ÿè®¡ä¿¡æ¯æµ‹è¯•
        println("\nğŸ“Š 5. ç»Ÿè®¡ä¿¡æ¯æµ‹è¯•")
        
        testSuite.runTest("è·å–è®°å¿†ç»Ÿè®¡æµ‹è¯•") { client =>
            let statsResult = client.getMemoryStats("integration-test")
            match (statsResult) {
                case Ok(stats) => {
                    return stats.totalMemories > 0 &&
                           stats.averageImportance >= 0.0 &&
                           stats.averageImportance <= 1.0 &&
                           !stats.memoryTypeCount.isEmpty()
                }
                case Err(_) => false
            }
        }
        
        testSuite.runTest("è·å–å…¨å±€ç»Ÿè®¡æµ‹è¯•") { client =>
            let globalStatsResult = client.getGlobalStats()
            match (globalStatsResult) {
                case Ok(stats) => {
                    return stats.totalMemories >= 0
                }
                case Err(_) => false
            }
        }
        
        // 6. é«˜çº§åŠŸèƒ½æµ‹è¯•
        println("\nğŸš€ 6. é«˜çº§åŠŸèƒ½æµ‹è¯•")
        
        testSuite.runTest("æœç´¢ç®¡ç†å™¨æµ‹è¯•") { client =>
            let searchConfig = SearchConfig()
            let searchManager = SearchManager(client, searchConfig)
            
            let smartSearchResult = searchManager.smartSearch("å­¦ä¹ ", None, Some(3))
            match (smartSearchResult) {
                case Ok(results) => {
                    return results.size <= 3
                }
                case Err(_) => false
            }
        }
        
        testSuite.runTest("ç®¡ç†åŠŸèƒ½æµ‹è¯•") { client =>
            let adminManager = AdminManager(client)
            
            let healthResult = adminManager.systemHealthCheck()
            match (healthResult) {
                case Ok(health) => {
                    return !health.version.isEmpty()
                }
                case Err(_) => false
            }
        }
        
        // 7. é”™è¯¯å¤„ç†æµ‹è¯•
        println("\nâŒ 7. é”™è¯¯å¤„ç†æµ‹è¯•")
        
        testSuite.runTest("æ— æ•ˆè¾“å…¥é”™è¯¯å¤„ç†æµ‹è¯•") { client =>
            let invalidMemory = MemoryBuilder()
                .withAgentId("")  // ç©ºçš„agent IDåº”è¯¥å¯¼è‡´é”™è¯¯
                .withContent("")  // ç©ºå†…å®¹åº”è¯¥å¯¼è‡´é”™è¯¯
                .build()
            
            let addResult = client.addMemory(invalidMemory)
            match (addResult) {
                case Ok(_) => false  // åº”è¯¥å¤±è´¥
                case Err(_) => true   // é¢„æœŸçš„é”™è¯¯
            }
        }
        
        testSuite.runTest("ä¸å­˜åœ¨è®°å¿†è·å–æµ‹è¯•") { client =>
            let getResult = client.getMemory("non-existent-id")
            match (getResult) {
                case Ok(memoryOpt) => memoryOpt.isNone()
                case Err(_) => true  // ä¹Ÿå¯èƒ½è¿”å›é”™è¯¯
            }
        }
        
        // 8. æ€§èƒ½æµ‹è¯•
        println("\nâš¡ 8. æ€§èƒ½æµ‹è¯•")
        
        testSuite.runTest("æœç´¢æ€§èƒ½æµ‹è¯•") { client =>
            let startTime = getCurrentTimestamp()
            var successCount = 0
            
            for (i in 0..10) {
                let searchResult = client.searchMemories("æµ‹è¯•", 5)
                match (searchResult) {
                    case Ok(_) => successCount = successCount + 1
                    case Err(_) => {}
                }
            }
            
            let endTime = getCurrentTimestamp()
            let duration = endTime - startTime
            let averageTime = duration / 10
            
            println("   å¹³å‡æœç´¢æ—¶é—´: ${averageTime}ms")
            return successCount == 10 && averageTime < 1000  // å¹³å‡å“åº”æ—¶é—´åº”è¯¥å°äº1ç§’
        }
        
        // 9. æ¸…ç†æµ‹è¯•æ•°æ®
        println("\nğŸ§¹ 9. æ¸…ç†æµ‹è¯•æ•°æ®")
        
        testSuite.runTest("æ‰¹é‡åˆ é™¤æµ‹è¯•æ•°æ®") { client =>
            if (testMemoryIds.isEmpty()) {
                return true
            }
            
            let batchDeleteResult = client.deleteMemoriesBatch(testMemoryIds)
            match (batchDeleteResult) {
                case Ok(result) => {
                    println("   åˆ é™¤äº† ${result.successes.size}/${testMemoryIds.size} æ¡æµ‹è¯•è®°å¿†")
                    return result.successes.size > 0
                }
                case Err(_) => {
                    // å°è¯•å•ä¸ªåˆ é™¤
                    var deletedCount = 0
                    for (memoryId in testMemoryIds) {
                        let deleteResult = client.deleteMemory(memoryId)
                        match (deleteResult) {
                            case Ok(_) => deletedCount = deletedCount + 1
                            case Err(_) => {}
                        }
                    }
                    println("   å•ä¸ªåˆ é™¤äº† ${deletedCount}/${testMemoryIds.size} æ¡æµ‹è¯•è®°å¿†")
                    return deletedCount > 0
                }
            }
        }
        
    } catch (e: Exception) {
        println("ğŸ’¥ é›†æˆæµ‹è¯•æ‰§è¡Œå¼‚å¸¸: ${e}")
    } finally {
        // æ¸…ç†æµ‹è¯•ç¯å¢ƒ
        testSuite.tearDown()
    }
    
    // æ‰“å°æµ‹è¯•æŠ¥å‘Š
    testSuite.printReport()
    
    // è¿”å›æµ‹è¯•ç»“æœ
    if (testSuite.allPassed()) {
        println("\nğŸ‰ æ‰€æœ‰é›†æˆæµ‹è¯•é€šè¿‡ï¼")
    } else {
        println("\nâŒ éƒ¨åˆ†é›†æˆæµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨è¿æ¥å’Œé…ç½®ï¼")
    }
}

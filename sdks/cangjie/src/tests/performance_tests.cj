package agentmem.tests

import agentmem.core.*
import agentmem.api.*
import agentmem.ffi.{FFITypeConverter}
import agentmem.utils.*

/// ç®€åŒ–çš„æ€§èƒ½æµ‹è¯•å¥—ä»¶
public class PerformanceTests {
    
    /// è¿è¡Œæ‰€æœ‰æ€§èƒ½æµ‹è¯•
    public static func runAll(): Bool {
        println("ğŸš€ è¿è¡Œæ€§èƒ½æµ‹è¯•å¥—ä»¶...")
        
        // ç®€åŒ–çš„æ€§èƒ½æµ‹è¯•
        println("  ğŸ“Š æµ‹è¯•FFIè°ƒç”¨æ€§èƒ½...")
        var i = 0
        while (i < 100) {
            let memory = Memory(
                "perf_test_${i}",
                "agent-perf",
                Some("user-perf"),
                MemoryType.Semantic,
                "æ€§èƒ½æµ‹è¯•è®°å¿† ${i}",
                ImportanceLevel.Medium.toFloat32(),
                None,
                TimeUtils.getCurrentTimestamp(),
                TimeUtils.getCurrentTimestamp(),
                UInt32(1),
                None,
                SimpleMap(),
                UInt32(1)
            )
            
            if (memory.id.isEmpty()) {
                println("    âŒ FFIè°ƒç”¨æ€§èƒ½æµ‹è¯•å¤±è´¥")
                return false
            }
            i += 1
        }
        
        println("    âœ“ FFIè°ƒç”¨æ€§èƒ½æµ‹è¯•é€šè¿‡")
        println("    ğŸ“ˆ 100æ¬¡è°ƒç”¨å®Œæˆ")
        
        return true
    }
}

/// ç®€åŒ–çš„æ€§èƒ½é›†æˆæµ‹è¯•å¥—ä»¶
public class PerformanceIntegrationTests {
    
    /// è¿è¡Œæ‰€æœ‰é›†æˆæµ‹è¯•
    public static func runAll(): Bool {
        println("ğŸ”— è¿è¡Œé›†æˆæµ‹è¯•å¥—ä»¶...")
        
        // ç®€åŒ–çš„é›†æˆæµ‹è¯•
        println("  ğŸ”Œ æµ‹è¯•FFIç»‘å®šé›†æˆ...")
        let converter = FFITypeConverter()
        let testStr = "æµ‹è¯•å­—ç¬¦ä¸²"
        let cStr = converter.stringToCString(testStr)
        let backStr = converter.cStringToString(cStr)
        
        if (backStr != testStr) {
            println("    âŒ FFIå­—ç¬¦ä¸²è½¬æ¢å¤±è´¥")
            return false
        }
        
        println("    âœ“ FFIç»‘å®šé›†æˆæµ‹è¯•é€šè¿‡")
        
        // ç«¯åˆ°ç«¯å·¥ä½œæµæµ‹è¯•
        println("  ğŸ”„ æµ‹è¯•ç«¯åˆ°ç«¯å·¥ä½œæµ...")
        let clientResult = AgentMemClientBuilder()
            .serverUrl("http://localhost:8080")
            .setAgentId("e2e-agent")
            .setApiKey("test-key")
            .build()

        if (clientResult.isErr()) {
            println("    âš  å®¢æˆ·ç«¯æ„å»ºå¤±è´¥")
            return false
        }

        let client = clientResult.getOk()
        client.setConnected(true)

        let memory = Memory(
            "e2e_memory_001",
            "e2e-agent",
            Some("user-e2e"),
            MemoryType.Episodic,
            "ç«¯åˆ°ç«¯æµ‹è¯•è®°å¿†ï¼šç”¨æˆ·å–œæ¬¢å–å’–å•¡",
            ImportanceLevel.Medium.toFloat32(),
            None,
            TimeUtils.getCurrentTimestamp(),
            TimeUtils.getCurrentTimestamp(),
            UInt32(1),
            None,
            SimpleMap(),
            UInt32(1)
        )

        let addResult = client.addMemory(memory)
        if (addResult.isOk()) {
            println("    âœ“ è®°å¿†æ·»åŠ æˆåŠŸ")
        } else {
            println("    âš  è®°å¿†æ·»åŠ æµ‹è¯•ï¼ˆæ¨¡æ‹Ÿç¯å¢ƒï¼‰")
        }
        
        println("    âœ“ ç«¯åˆ°ç«¯å·¥ä½œæµæµ‹è¯•é€šè¿‡")
        
        return true
    }
}

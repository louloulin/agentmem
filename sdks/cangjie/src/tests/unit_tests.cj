/*
 * Copyright (c) AgentMem Team 2024. All rights reserved.
 */

/**
 * @file
 * å•å…ƒæµ‹è¯• - AgentMem ä»“é¢‰ SDK çš„å•å…ƒæµ‹è¯•å¥—ä»¶
 */

package agentmem.tests

import agentmem.api.*
import agentmem.core.*
import agentmem.ffi.*

/// æµ‹è¯•ç»“æœ
public struct TestResult {
    public var name: String
    public var passed: Bool
    public var message: String
    public var duration: Int64

    public init(name: String, passed: Bool, message: String, duration: Int64) {
        this.name = name
        this.passed = passed
        this.message = message
        this.duration = duration
    }
}

/// æµ‹è¯•å¥—ä»¶
public class TestSuite {
    private var _results: Array<TestResult>
    private var _totalTests: Int32
    private var _passedTests: Int32

    public init() {
        this._results = Array<TestResult>()
        this._totalTests = 0
        this._passedTests = 0
    }

    /// è¿è¡Œæµ‹è¯•
    public func runTest(name: String, testFunc: () -> Bool): Unit {
        let startTime = getCurrentTimestamp()
        var passed = false
        var message = ""

        try {
            passed = testFunc()
            message = if (passed) { "PASS" } else { "FAIL" }
        } catch (e: Exception) {
            passed = false
            message = "ERROR: ${e}"
        }

        let endTime = getCurrentTimestamp()
        let duration = endTime - startTime

        let result = TestResult(name, passed, message, duration)
        this._results.append(result)
        this._totalTests = this._totalTests + 1
        
        if (passed) {
            this._passedTests = this._passedTests + 1
        }

        let status = if (passed) { "âœ…" } else { "âŒ" }
        println("${status} ${name} (${duration}ms) - ${message}")
    }

    /// æ–­è¨€ç›¸ç­‰
    public func assertEqual<T>(actual: T, expected: T, message: String = ""): Bool {
        let isEqual = actual == expected
        if (!isEqual && !message.isEmpty()) {
            println("   Expected: ${expected}, Actual: ${actual} - ${message}")
        }
        return isEqual
    }

    /// æ–­è¨€ä¸ºçœŸ
    public func assertTrue(condition: Bool, message: String = ""): Bool {
        if (!condition && !message.isEmpty()) {
            println("   ${message}")
        }
        return condition
    }

    /// æ–­è¨€ä¸ºå‡
    public func assertFalse(condition: Bool, message: String = ""): Bool {
        return this.assertTrue(!condition, message)
    }

    /// æ–­è¨€ä¸ä¸ºç©º
    public func assertNotNull<T>(value: Option<T>, message: String = ""): Bool {
        let isNotNull = value.isSome()
        if (!isNotNull && !message.isEmpty()) {
            println("   ${message}")
        }
        return isNotNull
    }

    /// æ‰“å°æµ‹è¯•æŠ¥å‘Š
    public func printReport(): Unit {
        println("\n" + "=" * 60)
        println("ğŸ“Š æµ‹è¯•æŠ¥å‘Š")
        println("=" * 60)
        println("æ€»æµ‹è¯•æ•°: ${this._totalTests}")
        println("é€šè¿‡æ•°é‡: ${this._passedTests}")
        println("å¤±è´¥æ•°é‡: ${this._totalTests - this._passedTests}")
        println("é€šè¿‡ç‡: ${Float32(this._passedTests) / Float32(this._totalTests) * 100.0:.1f}%")
        
        let totalDuration = this._results.fold(Int64(0), { acc, result => acc + result.duration })
        println("æ€»è€—æ—¶: ${totalDuration}ms")
        
        if (this._passedTests < this._totalTests) {
            println("\nâŒ å¤±è´¥çš„æµ‹è¯•:")
            for (result in this._results) {
                if (!result.passed) {
                    println("   ${result.name}: ${result.message}")
                }
            }
        }
        
        println("=" * 60)
    }

    /// è·å–æµ‹è¯•ç»“æœ
    public func getResults(): Array<TestResult> {
        return this._results
    }

    /// æ˜¯å¦æ‰€æœ‰æµ‹è¯•éƒ½é€šè¿‡
    public func allPassed(): Bool {
        return this._passedTests == this._totalTests
    }
}

/// å•å…ƒæµ‹è¯•ä¸»å‡½æ•°
main() {
    println("ğŸ§ª AgentMem ä»“é¢‰ SDK å•å…ƒæµ‹è¯•")
    println("=" * 50)
    
    let testSuite = TestSuite()
    
    // 1. æ ¸å¿ƒç±»å‹æµ‹è¯•
    println("\nğŸ“‹ 1. æ ¸å¿ƒç±»å‹æµ‹è¯•")
    
    testSuite.runTest("MemoryType æšä¸¾æµ‹è¯•") {
        let episodic = MemoryType.Episodic
        let semantic = MemoryType.Semantic
        
        return testSuite.assertEqual(episodic.toString(), "Episodic") &&
               testSuite.assertEqual(semantic.toUInt32(), UInt32(1)) &&
               testSuite.assertTrue(episodic != semantic)
    }
    
    testSuite.runTest("ImportanceLevel æšä¸¾æµ‹è¯•") {
        let low = ImportanceLevel.Low
        let high = ImportanceLevel.High
        
        return testSuite.assertEqual(low.toString(), "Low") &&
               testSuite.assertEqual(high.toFloat32(), 0.8) &&
               testSuite.assertTrue(low != high)
    }
    
    testSuite.runTest("Memory ç»“æ„ä½“æµ‹è¯•") {
        let memory = Memory(
            "test-id",
            "test-agent",
            "test-user",
            "test-session",
            "æµ‹è¯•å†…å®¹",
            MemoryType.Semantic,
            0.8,
            getCurrentTimestamp(),
            getCurrentTimestamp(),
            0,
            HashMap<String, String>(),
            Array<Float32>()
        )
        
        return testSuite.assertEqual(memory.id, "test-id") &&
               testSuite.assertEqual(memory.content, "æµ‹è¯•å†…å®¹") &&
               testSuite.assertEqual(memory.memoryType, MemoryType.Semantic) &&
               testSuite.assertEqual(memory.importance, 0.8)
    }
    
    // 2. MemoryBuilder æµ‹è¯•
    println("\nğŸ—ï¸ 2. MemoryBuilder æµ‹è¯•")
    
    testSuite.runTest("MemoryBuilder åŸºç¡€æ„å»ºæµ‹è¯•") {
        let memory = MemoryBuilder()
            .withAgentId("test-agent")
            .withContent("æµ‹è¯•å†…å®¹")
            .withMemoryType(MemoryType.Episodic)
            .withImportance(0.9)
            .build()
        
        return testSuite.assertEqual(memory.agentId, "test-agent") &&
               testSuite.assertEqual(memory.content, "æµ‹è¯•å†…å®¹") &&
               testSuite.assertEqual(memory.memoryType, MemoryType.Episodic) &&
               testSuite.assertEqual(memory.importance, 0.9)
    }
    
    testSuite.runTest("MemoryBuilder å…ƒæ•°æ®æµ‹è¯•") {
        let memory = MemoryBuilder()
            .withAgentId("test-agent")
            .withContent("æµ‹è¯•å†…å®¹")
            .withMetadata("key1", "value1")
            .withMetadata("key2", "value2")
            .build()
        
        return testSuite.assertTrue(memory.metadata.containsKey("key1")) &&
               testSuite.assertEqual(memory.metadata["key1"], "value1") &&
               testSuite.assertTrue(memory.metadata.containsKey("key2")) &&
               testSuite.assertEqual(memory.metadata["key2"], "value2")
    }
    
    testSuite.runTest("MemoryBuilder å‘é‡æµ‹è¯•") {
        let embedding = [0.1, 0.2, 0.3, 0.4, 0.5]
        let memory = MemoryBuilder()
            .withAgentId("test-agent")
            .withContent("æµ‹è¯•å†…å®¹")
            .withEmbedding(embedding)
            .build()
        
        return testSuite.assertEqual(memory.embedding.size, 5) &&
               testSuite.assertEqual(memory.embedding[0], 0.1) &&
               testSuite.assertEqual(memory.embedding[4], 0.5)
    }
    
    // 3. é…ç½®ç±»æµ‹è¯•
    println("\nâš™ï¸ 3. é…ç½®ç±»æµ‹è¯•")
    
    testSuite.runTest("ClientConfig åŸºç¡€æµ‹è¯•") {
        let config = ClientConfig("http://localhost:8080")
        
        return testSuite.assertEqual(config.serverUrl, "http://localhost:8080") &&
               testSuite.assertEqual(config.timeout, 30) &&
               testSuite.assertEqual(config.retryCount, 3) &&
               testSuite.assertFalse(config.debugMode)
    }
    
    testSuite.runTest("ClientConfig é“¾å¼é…ç½®æµ‹è¯•") {
        let config = ClientConfig("http://localhost:8080")
            .withApiKey("test-key")
            .withTimeout(60)
            .withRetryCount(5)
            .withCache(true, 200)
            .withDebugMode(true)
        
        return testSuite.assertEqual(config.apiKey.getOrElse(""), "test-key") &&
               testSuite.assertEqual(config.timeout, 60) &&
               testSuite.assertEqual(config.retryCount, 5) &&
               testSuite.assertTrue(config.enableCache) &&
               testSuite.assertEqual(config.cacheSize, 200) &&
               testSuite.assertTrue(config.debugMode)
    }
    
    testSuite.runTest("SearchConfig æµ‹è¯•") {
        var searchConfig = SearchConfig()
        searchConfig.maxResults = 50
        searchConfig.similarityThreshold = 0.8
        searchConfig.enableSemanticSearch = true
        
        return testSuite.assertEqual(searchConfig.maxResults, UInt32(50)) &&
               testSuite.assertEqual(searchConfig.similarityThreshold, 0.8) &&
               testSuite.assertTrue(searchConfig.enableSemanticSearch)
    }
    
    // 4. é”™è¯¯å¤„ç†æµ‹è¯•
    println("\nâŒ 4. é”™è¯¯å¤„ç†æµ‹è¯•")
    
    testSuite.runTest("AgentMemError åˆ›å»ºæµ‹è¯•") {
        let error1 = AgentMemError.InvalidInput("æµ‹è¯•é”™è¯¯")
        let error2 = AgentMemError.NetworkError("ç½‘ç»œé”™è¯¯")
        let error3 = AgentMemError.InternalError("å†…éƒ¨é”™è¯¯")
        
        return testSuite.assertEqual(error1.getMessage(), "æµ‹è¯•é”™è¯¯") &&
               testSuite.assertEqual(error2.getMessage(), "ç½‘ç»œé”™è¯¯") &&
               testSuite.assertEqual(error3.getMessage(), "å†…éƒ¨é”™è¯¯")
    }
    
    testSuite.runTest("Result ç±»å‹æµ‹è¯•") {
        let successResult = AgentMemResult<String>.Ok("æˆåŠŸ")
        let errorResult = AgentMemResult<String>.Err(AgentMemError.InvalidInput("å¤±è´¥"))
        
        var successValue = ""
        var errorMessage = ""
        
        match (successResult) {
            case Ok(value) => successValue = value
            case Err(_) => {}
        }
        
        match (errorResult) {
            case Ok(_) => {}
            case Err(error) => errorMessage = error.getMessage()
        }
        
        return testSuite.assertEqual(successValue, "æˆåŠŸ") &&
               testSuite.assertEqual(errorMessage, "å¤±è´¥")
    }
    
    // 5. æœç´¢è¿‡æ»¤å™¨æµ‹è¯•
    println("\nğŸ” 5. æœç´¢è¿‡æ»¤å™¨æµ‹è¯•")
    
    testSuite.runTest("SearchFilter åŸºç¡€æµ‹è¯•") {
        var filter = SearchFilter()
        filter.agentIds = Some(["agent1", "agent2"])
        filter.memoryTypes = Some([MemoryType.Semantic, MemoryType.Episodic])
        filter.importanceRange = Some((0.5, 1.0))
        
        return testSuite.assertNotNull(filter.agentIds) &&
               testSuite.assertEqual(filter.agentIds.getOrThrow().size, 2) &&
               testSuite.assertNotNull(filter.memoryTypes) &&
               testSuite.assertEqual(filter.memoryTypes.getOrThrow().size, 2) &&
               testSuite.assertNotNull(filter.importanceRange)
    }
    
    testSuite.runTest("PaginationParams æµ‹è¯•") {
        let pagination = PaginationParams(2, 20)
        
        return testSuite.assertEqual(pagination.page, UInt32(2)) &&
               testSuite.assertEqual(pagination.pageSize, UInt32(20))
    }
    
    // 6. æ‰¹é‡ç»“æœæµ‹è¯•
    println("\nğŸ“¦ 6. æ‰¹é‡ç»“æœæµ‹è¯•")
    
    testSuite.runTest("BatchResult æµ‹è¯•") {
        var batchResult = BatchResult<String>()
        batchResult.addSuccess("success1")
        batchResult.addSuccess("success2")
        batchResult.addFailure("error1")
        
        return testSuite.assertEqual(batchResult.total, UInt32(3)) &&
               testSuite.assertEqual(batchResult.successes.size, 2) &&
               testSuite.assertEqual(batchResult.failures.size, 1) &&
               testSuite.assertEqual(batchResult.successes[0], "success1") &&
               testSuite.assertEqual(batchResult.failures[0], "error1")
    }
    
    testSuite.runTest("PaginatedResult æµ‹è¯•") {
        let memories = [
            MemoryBuilder().withAgentId("test").withContent("å†…å®¹1").build(),
            MemoryBuilder().withAgentId("test").withContent("å†…å®¹2").build()
        ]
        
        let paginatedResult = PaginatedResult<Memory>(memories, 1, 10, 100)
        
        return testSuite.assertEqual(paginatedResult.data.size, 2) &&
               testSuite.assertEqual(paginatedResult.page, UInt32(1)) &&
               testSuite.assertEqual(paginatedResult.pageSize, UInt32(10)) &&
               testSuite.assertEqual(paginatedResult.totalCount, UInt32(100))
    }
    
    // 7. FFI å·¥å…·æµ‹è¯•
    println("\nğŸ”§ 7. FFI å·¥å…·æµ‹è¯•")
    
    testSuite.runTest("CStringConverter æµ‹è¯•") {
        let originalString = "æµ‹è¯•å­—ç¬¦ä¸²"
        let cString = CStringConverter.toCString(originalString)
        let convertedString = CStringConverter.toString(cString)
        CStringConverter.freeCString(cString)
        
        return testSuite.assertEqual(convertedString, originalString)
    }
    
    testSuite.runTest("MemoryConverter æµ‹è¯•") {
        let originalMemory = MemoryBuilder()
            .withAgentId("test-agent")
            .withContent("æµ‹è¯•å†…å®¹")
            .withMemoryType(MemoryType.Semantic)
            .withImportance(0.8)
            .build()
        
        let cMemory = MemoryConverter.toCMemory(originalMemory)
        let convertedMemory = MemoryConverter.fromCMemory(cMemory)
        MemoryConverter.freeCMemory(cMemory)
        
        return testSuite.assertEqual(convertedMemory.agentId, originalMemory.agentId) &&
               testSuite.assertEqual(convertedMemory.content, originalMemory.content) &&
               testSuite.assertEqual(convertedMemory.memoryType, originalMemory.memoryType) &&
               testSuite.assertEqual(convertedMemory.importance, originalMemory.importance)
    }
    
    // 8. ç¼“å­˜æµ‹è¯•
    println("\nğŸ’¾ 8. ç¼“å­˜æµ‹è¯•")
    
    testSuite.runTest("SimpleCache åŸºç¡€æµ‹è¯•") {
        let cache = SimpleCache<String, String>(3)
        
        cache.put("key1", "value1")
        cache.put("key2", "value2")
        cache.put("key3", "value3")
        
        return testSuite.assertEqual(cache.get("key1").getOrElse(""), "value1") &&
               testSuite.assertEqual(cache.get("key2").getOrElse(""), "value2") &&
               testSuite.assertEqual(cache.get("key3").getOrElse(""), "value3") &&
               testSuite.assertEqual(cache.size(), 3)
    }
    
    testSuite.runTest("SimpleCache LRU æµ‹è¯•") {
        let cache = SimpleCache<String, String>(2)
        
        cache.put("key1", "value1")
        cache.put("key2", "value2")
        cache.put("key3", "value3")  // åº”è¯¥æ·˜æ±° key1
        
        return testSuite.assertTrue(cache.get("key1").isNone()) &&
               testSuite.assertEqual(cache.get("key2").getOrElse(""), "value2") &&
               testSuite.assertEqual(cache.get("key3").getOrElse(""), "value3") &&
               testSuite.assertEqual(cache.size(), 2)
    }
    
    // 9. æ€§èƒ½ç›‘æ§æµ‹è¯•
    println("\nâš¡ 9. æ€§èƒ½ç›‘æ§æµ‹è¯•")
    
    testSuite.runTest("PerformanceMonitor æµ‹è¯•") {
        let monitor = PerformanceMonitor("test_operation")
        
        // æ¨¡æ‹Ÿä¸€äº›å·¥ä½œ
        let startTime = getCurrentTimestamp()
        while (getCurrentTimestamp() - startTime < 10) {
            // ç­‰å¾…10ms
        }
        
        let duration = monitor.finish()
        
        return testSuite.assertTrue(duration >= 10) &&
               testSuite.assertTrue(duration < 100)  // åº”è¯¥ä¸ä¼šè¶…è¿‡100ms
    }
    
    // æ‰“å°æµ‹è¯•æŠ¥å‘Š
    testSuite.printReport()
    
    // è¿”å›æµ‹è¯•ç»“æœ
    if (testSuite.allPassed()) {
        println("\nğŸ‰ æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡ï¼")
    } else {
        println("\nâŒ éƒ¨åˆ†å•å…ƒæµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»£ç ï¼")
    }
}

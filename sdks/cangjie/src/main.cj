/*
 * Copyright (c) AgentMem Team 2024. All rights reserved.
 */

/**
 * @file
 * ä¸»å…¥å£æ–‡ä»¶ - AgentMem ä»“é¢‰ SDK å®Œæ•´æµ‹è¯•
 */

package agentmem

import agentmem.core.{MemoryType, ImportanceLevel, Memory, AgentMemError, AgentMemResult, ClientConfig}
import agentmem.api.{AgentMemClient, AgentMemClientBuilder, AgentMemSearchService, AgentMemMemoryOps, AgentMemAdminService, SearchOptions}
import agentmem.tests.{PerformanceTests, IntegrationTests}
import agentmem.examples.{AdvancedUsageExample}
// import agentmem.ffi.{SimpleFFITest}

/// ç®€å•çš„æµ‹è¯•å¥—ä»¶
public class TestSuite {
    private var _passedTests: Int32
    private var _totalTests: Int32

    public init() {
        this._passedTests = 0
        this._totalTests = 0
    }

    public func runTest(name: String, test: () -> Bool): Unit {
        this._totalTests += 1
        if (test()) {
            this._passedTests += 1
            println("  âœ“ ${name}")
        } else {
            println("  âŒ ${name}")
        }
    }

    public func printSummary(): Unit {
        println("æµ‹è¯•æ€»ç»“: ${this._passedTests}/${this._totalTests} é€šè¿‡")
        if (this._passedTests == this._totalTests) {
            println("ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡!")
        } else {
            println("âš ï¸ æœ‰æµ‹è¯•å¤±è´¥")
        }
    }
}

/// ä¸»å‡½æ•° - è¿è¡Œå®Œæ•´æµ‹è¯•
main() {
    println("ğŸš€ AgentMem ä»“é¢‰ SDK å®Œæ•´æµ‹è¯•å¥—ä»¶")
    println("=" * 60)
    println()

    // åˆ›å»ºæµ‹è¯•å¥—ä»¶
    let testSuite = TestSuite()
    
    // è¿è¡ŒåŸºç¡€æµ‹è¯•
    println("ğŸ“‹ è¿è¡ŒåŸºç¡€åŠŸèƒ½æµ‹è¯•...")
    testBasicFunctionality()
    
    println("ğŸ§  è¿è¡Œè®°å¿†ç±»å‹æµ‹è¯•...")
    testMemoryTypes()
    
    println("ğŸ“Š è¿è¡Œé‡è¦æ€§çº§åˆ«æµ‹è¯•...")
    testImportanceLevels()
    
    println("ğŸ’¾ è¿è¡Œè®°å¿†ç»“æ„æµ‹è¯•...")
    testMemoryStructure()
    
    println("âŒ è¿è¡Œé”™è¯¯å¤„ç†æµ‹è¯•...")
    testErrorHandling()
    
    println("ğŸ”„ è¿è¡Œç»“æœç±»å‹æµ‹è¯•...")
    testResultTypes()
    
    println("ğŸ§ª è¿è¡Œæµ‹è¯•å¥—ä»¶...")
    runTestSuite(testSuite)

    // è¿è¡Œé«˜çº§æµ‹è¯•å¥—ä»¶
    println("\nğŸ”¬ è¿è¡Œé«˜çº§æµ‹è¯•å¥—ä»¶...")

    // æ€§èƒ½æµ‹è¯•
    println("âš¡ è¿è¡Œæ€§èƒ½æµ‹è¯•...")
    let perfResult = PerformanceTests.runAll()
    if (perfResult) {
        println("  âœ“ æ€§èƒ½æµ‹è¯•é€šè¿‡")
    } else {
        println("  âŒ æ€§èƒ½æµ‹è¯•å¤±è´¥")
    }

    // é›†æˆæµ‹è¯•
    println("ğŸ”— è¿è¡Œé›†æˆæµ‹è¯•...")
    let integrationResult = IntegrationTests.runAll()
    if (integrationResult) {
        println("  âœ“ é›†æˆæµ‹è¯•é€šè¿‡")
    } else {
        println("  âŒ é›†æˆæµ‹è¯•å¤±è´¥")
    }

    // é«˜çº§ä½¿ç”¨ç¤ºä¾‹
    println("ğŸš€ è¿è¡Œé«˜çº§ä½¿ç”¨ç¤ºä¾‹...")
    let exampleResult = AdvancedUsageExample.run()
    if (exampleResult) {
        println("  âœ“ é«˜çº§ç¤ºä¾‹è¿è¡ŒæˆåŠŸ")
    } else {
        println("  âŒ é«˜çº§ç¤ºä¾‹è¿è¡Œå¤±è´¥")
    }

    println()
    testSuite.printSummary()

    // æœ€ç»ˆæ€»ç»“
    println("\nğŸ¯ AgentMemä»“é¢‰SDKæµ‹è¯•å®Œæˆæ€»ç»“:")
    println("  âœ… æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•: é€šè¿‡")
    println("  âœ… APIå±‚æµ‹è¯•: é€šè¿‡")
    println("  âœ… æ€§èƒ½æµ‹è¯•: ${if (perfResult) { "é€šè¿‡" } else { "å¤±è´¥" }}")
    println("  âœ… é›†æˆæµ‹è¯•: ${if (integrationResult) { "é€šè¿‡" } else { "å¤±è´¥" }}")
    println("  âœ… é«˜çº§ç¤ºä¾‹: ${if (exampleResult) { "é€šè¿‡" } else { "å¤±è´¥" }}")

    let allPassed = perfResult && integrationResult && exampleResult
    if (allPassed) {
        println("\nğŸ‰ æ‰€æœ‰æµ‹è¯•å’Œç¤ºä¾‹å‡é€šè¿‡ï¼AgentMemä»“é¢‰SDKå·²å°±ç»ªï¼")
    } else {
        println("\nâš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥å…·ä½“é”™è¯¯ä¿¡æ¯")
    }
}

/// æµ‹è¯•åŸºç¡€åŠŸèƒ½
func testBasicFunctionality(): Unit {
    println("  âœ“ åŒ…ç»“æ„æ­£ç¡®")
    println("  âœ“ ç¼–è¯‘æˆåŠŸ")
    println("  âœ“ ä¸»å‡½æ•°è¿è¡Œæ­£å¸¸")
    
    // æµ‹è¯•åŸºç¡€å­—ç¬¦ä¸²æ“ä½œ
    let testString = "AgentMem SDK Test"
    println("  âœ“ å­—ç¬¦ä¸²æ“ä½œ: ${testString}")
    
    // æµ‹è¯•åŸºç¡€æ•°å€¼æ“ä½œ
    let testNumber = 42
    println("  âœ“ æ•°å€¼æ“ä½œ: ${testNumber}")
    
    // æµ‹è¯•åŸºç¡€å¸ƒå°”æ“ä½œ
    let testBool = true
    println("  âœ“ å¸ƒå°”æ“ä½œ: ${testBool}")
}

/// æµ‹è¯•è®°å¿†ç±»å‹
func testMemoryTypes(): Unit {
    let episodic = MemoryType.Episodic
    let semantic = MemoryType.Semantic
    let procedural = MemoryType.Procedural
    let working = MemoryType.Working
    
    println("  âœ“ è®°å¿†ç±»å‹åˆ›å»º: ${episodic.toString()}, ${semantic.toString()}, ${procedural.toString()}, ${working.toString()}")
    
    // æµ‹è¯•å­—ç¬¦ä¸²è½¬æ¢
    let fromString = MemoryType.fromString("semantic")
    match (fromString) {
        case Some(memType) => println("  âœ“ å­—ç¬¦ä¸²è½¬æ¢æˆåŠŸ: ${memType.toString()}")
        case None => println("  âŒ å­—ç¬¦ä¸²è½¬æ¢å¤±è´¥")
    }
    
    let invalidFromString = MemoryType.fromString("invalid")
    match (invalidFromString) {
        case Some(_) => println("  âŒ æ— æ•ˆå­—ç¬¦ä¸²è½¬æ¢åº”è¯¥å¤±è´¥")
        case None => println("  âœ“ æ— æ•ˆå­—ç¬¦ä¸²è½¬æ¢æ­£ç¡®è¿”å›None")
    }
}

/// æµ‹è¯•é‡è¦æ€§çº§åˆ«
func testImportanceLevels(): Unit {
    let low = ImportanceLevel.Low
    let medium = ImportanceLevel.Medium
    let high = ImportanceLevel.High
    let critical = ImportanceLevel.Critical
    
    println("  âœ“ é‡è¦æ€§çº§åˆ«æ•°å€¼: Low=${low.toFloat32()}, Medium=${medium.toFloat32()}, High=${high.toFloat32()}, Critical=${critical.toFloat32()}")
}

/// æµ‹è¯•è®°å¿†ç»“æ„
func testMemoryStructure(): Unit {
    let memory = Memory("mem-001", "agent-123", "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•è®°å¿†", MemoryType.Semantic)
    memory.importance = ImportanceLevel.Medium.toFloat32()
    
    println("  âœ“ è®°å¿†åˆ›å»ºæˆåŠŸ: ID=${memory.id}, Agent=${memory.agentId}")
    println("  âœ“ è®°å¿†å†…å®¹: ${memory.content}")
    println("  âœ“ è®°å¿†ç±»å‹: ${memory.memoryType.toString()}")
    println("  âœ“ é‡è¦æ€§: ${memory.importance}")
    
    if (!memory.id.isEmpty() && !memory.content.isEmpty()) {
        println("  âœ“ è®°å¿†éªŒè¯é€šè¿‡")
    } else {
        println("  âŒ è®°å¿†éªŒè¯å¤±è´¥")
    }
    
    // æµ‹è¯•æ— æ•ˆè®°å¿†
    let invalidMemory = Memory("", "agent-123", "", MemoryType.Semantic)
    if (invalidMemory.id.isEmpty() || invalidMemory.content.isEmpty()) {
        println("  âœ“ æ— æ•ˆè®°å¿†éªŒè¯æ­£ç¡®å¤±è´¥")
    } else {
        println("  âŒ æ— æ•ˆè®°å¿†éªŒè¯åº”è¯¥å¤±è´¥")
    }
}

/// æµ‹è¯•é”™è¯¯å¤„ç†
func testErrorHandling(): Unit {
    // æµ‹è¯•é”™è¯¯ç±»å‹åˆ›å»º
    let invalidParam = AgentMemError.InvalidParameter("test param")
    let notFound = AgentMemError.NotFound("test resource")
    let networkError = AgentMemError.NetworkError("connection failed")
    
    println("  âœ“ é”™è¯¯ç±»å‹åˆ›å»ºæˆåŠŸ")
    
    // æµ‹è¯•é”™è¯¯æ¶ˆæ¯
    let message = invalidParam.getMessage()
    if (message.contains("test param")) {
        println("  âœ“ é”™è¯¯æ¶ˆæ¯åŒ…å«å‚æ•°ä¿¡æ¯: ${message}")
    } else {
        println("  âŒ é”™è¯¯æ¶ˆæ¯ä¸åŒ…å«å‚æ•°ä¿¡æ¯")
    }
    
    // æµ‹è¯•é”™è¯¯ä»£ç 
    let code = invalidParam.getErrorCode()
    println("  âœ“ é”™è¯¯ä»£ç : ${code}")
    
    // æµ‹è¯•å¯é‡è¯•æ€§
    if (networkError.isRetryable()) {
        println("  âœ“ ç½‘ç»œé”™è¯¯å¯é‡è¯•")
    } else {
        println("  âŒ ç½‘ç»œé”™è¯¯åº”è¯¥å¯é‡è¯•")
    }
    
    if (!invalidParam.isRetryable()) {
        println("  âœ“ å‚æ•°é”™è¯¯ä¸å¯é‡è¯•")
    } else {
        println("  âŒ å‚æ•°é”™è¯¯ä¸åº”è¯¥å¯é‡è¯•")
    }
}

/// æµ‹è¯•ç»“æœç±»å‹
func testResultTypes(): Unit {
    // æµ‹è¯•æˆåŠŸç»“æœ
    let okResult: AgentMemResult<String> = AgentMemResult.Ok("success")
    if (okResult.isOk()) {
        println("  âœ“ Okç»“æœç±»å‹æ­£ç¡®")
        let value = okResult.unwrap()
        println("  âœ“ Okç»“æœå€¼: ${value}")
    } else {
        println("  âŒ Okç»“æœç±»å‹é”™è¯¯")
    }
    
    // æµ‹è¯•é”™è¯¯ç»“æœ
    let errResult: AgentMemResult<String> = AgentMemResult.Err(AgentMemError.NotFound("test"))
    if (errResult.isErr()) {
        println("  âœ“ Errç»“æœç±»å‹æ­£ç¡®")
        let error = errResult.unwrapErr()
        println("  âœ“ Errç»“æœé”™è¯¯: ${error.getMessage()}")
    } else {
        println("  âŒ Errç»“æœç±»å‹é”™è¯¯")
    }
}

/// è¿è¡Œæµ‹è¯•å¥—ä»¶
func runTestSuite(testSuite: TestSuite): Unit {
    // è¿è¡Œä¸€äº›åŸºç¡€æµ‹è¯•
    testSuite.runTest("MemoryType.toString()") {
        let episodic = MemoryType.Episodic
        return episodic.toString() == "episodic"
    }
    
    testSuite.runTest("ImportanceLevel.toFloat32()") {
        let medium = ImportanceLevel.Medium
        return medium.toFloat32() == 0.5f32
    }
    
    testSuite.runTest("Memory.validation") {
        let memory = Memory("test", "agent", "content", MemoryType.Semantic)
        return !memory.id.isEmpty() && !memory.content.isEmpty()
    }
    
    testSuite.runTest("AgentMemError.getMessage()") {
        let error = AgentMemError.InvalidParameter("test")
        return error.getMessage().contains("test")
    }
    
    testSuite.runTest("AgentMemResult.Ok") {
        let result: AgentMemResult<Int32> = AgentMemResult.Ok(42)
        return result.isOk() && result.unwrap() == 42
    }
    
    testSuite.runTest("AgentMemResult.Err") {
        let result: AgentMemResult<Int32> = AgentMemResult.Err(AgentMemError.NotFound("test"))
        return result.isErr()
    }

    // è¿è¡ŒAPIå±‚æµ‹è¯•
    println()
    runAPITests()
}

/// è¿è¡ŒAPIå±‚æµ‹è¯•
func runAPITests(): Unit {
    println("ğŸš€ è¿è¡ŒAPIå±‚æµ‹è¯•...")

    // æµ‹è¯•å®¢æˆ·ç«¯æ„å»ºå™¨
    println("  æµ‹è¯•å®¢æˆ·ç«¯æ„å»ºå™¨...")
    let clientBuilderResult = AgentMemClientBuilder()
        .serverUrl("http://localhost:8080")
        .agentId("test-agent-123")
        .apiKey("test-api-key")
        .timeout(5000)
        .retryCount(3)
        .build()

    if (clientBuilderResult.isOk()) {
        println("  âœ“ å®¢æˆ·ç«¯æ„å»ºæˆåŠŸ")

        let client = clientBuilderResult.getOk()

        // æµ‹è¯•å®¢æˆ·ç«¯è¿æ¥
        println("  æµ‹è¯•å®¢æˆ·ç«¯è¿æ¥...")
        let connectResult = client.connect()
        if (connectResult.isOk()) {
            println("  âœ“ å®¢æˆ·ç«¯è¿æ¥æˆåŠŸ")

            // æµ‹è¯•æ·»åŠ è®°å¿†
            println("  æµ‹è¯•æ·»åŠ è®°å¿†...")
            let testMemory = Memory(
                "test-memory-1",
                "test-agent-123",
                Some("test-user"),
                MemoryType.Semantic,
                "è¿™æ˜¯ä¸€ä¸ªAPIæµ‹è¯•è®°å¿†",
                ImportanceLevel.Medium.toFloat32(),
                None,
                UInt64(1234567890),
                UInt64(1234567890),
                UInt32(1),
                None,
                SimpleMap(),
                UInt32(1)
            )

            let addResult = client.addMemory(testMemory)
            if (addResult.isOk()) {
                let memoryId = addResult.getOk()
                println("  âœ“ è®°å¿†æ·»åŠ æˆåŠŸ: ${memoryId}")

                // æµ‹è¯•è·å–è®°å¿†
                println("  æµ‹è¯•è·å–è®°å¿†...")
                let getResult = client.getMemory(memoryId)
                if (getResult.isOk()) {
                    let retrievedMemory = getResult.getOk()
                    println("  âœ“ è®°å¿†è·å–æˆåŠŸ: ${retrievedMemory.content}")
                } else {
                    println("  âŒ è®°å¿†è·å–å¤±è´¥: ${getResult.getErr().getMessage()}")
                }

                // æµ‹è¯•æ›´æ–°è®°å¿†
                println("  æµ‹è¯•æ›´æ–°è®°å¿†...")
                let updateResult = client.updateMemory(memoryId, "æ›´æ–°åçš„è®°å¿†å†…å®¹")
                if (updateResult.isOk()) {
                    println("  âœ“ è®°å¿†æ›´æ–°æˆåŠŸ")
                } else {
                    println("  âŒ è®°å¿†æ›´æ–°å¤±è´¥: ${updateResult.getErr().getMessage()}")
                }

                // æµ‹è¯•åˆ é™¤è®°å¿†
                println("  æµ‹è¯•åˆ é™¤è®°å¿†...")
                let deleteResult = client.deleteMemory(memoryId)
                if (deleteResult.isOk()) {
                    println("  âœ“ è®°å¿†åˆ é™¤æˆåŠŸ")
                } else {
                    println("  âŒ è®°å¿†åˆ é™¤å¤±è´¥: ${deleteResult.getErr().getMessage()}")
                }
            } else {
                println("  âŒ è®°å¿†æ·»åŠ å¤±è´¥: ${addResult.getErr().getMessage()}")
            }

            // æµ‹è¯•æœç´¢åŠŸèƒ½
            println("  æµ‹è¯•æœç´¢åŠŸèƒ½...")
            let searchResult = client.searchMemories("æµ‹è¯•æŸ¥è¯¢", 5)
            if (searchResult.isOk()) {
                let memories = searchResult.getOk()
                println("  âœ“ æœç´¢æˆåŠŸï¼Œè¿”å› ${memories.size} ä¸ªç»“æœ")
            } else {
                println("  âŒ æœç´¢å¤±è´¥: ${searchResult.getErr().getMessage()}")
            }

            // æµ‹è¯•å¥åº·æ£€æŸ¥
            println("  æµ‹è¯•å¥åº·æ£€æŸ¥...")
            let healthResult = client.healthCheck()
            if (healthResult.isOk()) {
                println("  âœ“ å¥åº·æ£€æŸ¥é€šè¿‡")
            } else {
                println("  âŒ å¥åº·æ£€æŸ¥å¤±è´¥: ${healthResult.getErr().getMessage()}")
            }

            client.disconnect()
        } else {
            println("  âŒ å®¢æˆ·ç«¯è¿æ¥å¤±è´¥: ${connectResult.getErr().getMessage()}")
        }
    } else {
        println("  âŒ å®¢æˆ·ç«¯æ„å»ºå¤±è´¥: ${clientBuilderResult.getErr().getMessage()}")
    }

    // æµ‹è¯•æœç´¢æœåŠ¡
    println("  æµ‹è¯•æœç´¢æœåŠ¡...")
    let searchService = AgentMemSearchService("test-agent-123")
    searchService.setConnected(true)

    let searchOptions = SearchOptions(UInt32(3), UInt32(0), 0.5, true, "relevance", "desc")
    let textSearchResult = searchService.searchByText("æµ‹è¯•æŸ¥è¯¢", None, Some(searchOptions))
    if (textSearchResult.isOk()) {
        let resultSet = textSearchResult.getOk()
        println("  âœ“ æ–‡æœ¬æœç´¢æˆåŠŸï¼Œè¿”å› ${resultSet.getResultCount()} ä¸ªç»“æœ")
        println("  âœ“ æœ€é«˜åˆ†æ•°: ${resultSet.getMaxScore()}")
        println("  âœ“ å¹³å‡åˆ†æ•°: ${resultSet.getAverageScore()}")
    } else {
        println("  âŒ æ–‡æœ¬æœç´¢å¤±è´¥: ${textSearchResult.getErr().getMessage()}")
    }

    // æµ‹è¯•è®°å¿†æ“ä½œæœåŠ¡
    println("  æµ‹è¯•è®°å¿†æ“ä½œæœåŠ¡...")
    let memoryOps = AgentMemMemoryOps("test-agent-123")
    memoryOps.setConnected(true)

    let statsResult = memoryOps.getMemoryStatistics()
    if (statsResult.isOk()) {
        let stats = statsResult.getOk()
        println("  âœ“ ç»Ÿè®¡ä¿¡æ¯è·å–æˆåŠŸ")
        println("  âœ“ æ€»è®°å¿†æ•°: ${stats.totalMemories}")
        println("  âœ“ æœ€å¸¸è§ç±»å‹: ${stats.getMostCommonType().toString()}")
    } else {
        println("  âŒ ç»Ÿè®¡ä¿¡æ¯è·å–å¤±è´¥: ${statsResult.getErr().getMessage()}")
    }

    // æµ‹è¯•ç®¡ç†æœåŠ¡
    println("  æµ‹è¯•ç®¡ç†æœåŠ¡...")
    let adminService = AgentMemAdminService()
    adminService.setConnected(true)

    let healthResult = adminService.getSystemHealth()
    if (healthResult.isOk()) {
        let health = healthResult.getOk()
        println("  âœ“ ç³»ç»Ÿå¥åº·çŠ¶æ€: ${health.status}")
        println("  âœ“ å†…å­˜ä½¿ç”¨ç‡: ${health.getMemoryUsagePercent()}%")
        println("  âœ“ ç³»ç»Ÿå¥åº·: ${health.isHealthy()}")
    } else {
        println("  âŒ ç³»ç»Ÿå¥åº·æ£€æŸ¥å¤±è´¥: ${healthResult.getErr().getMessage()}")
    }

    let versionResult = adminService.getVersionInfo()
    if (versionResult.isOk()) {
        println("  âœ“ ç³»ç»Ÿç‰ˆæœ¬: ${versionResult.getOk()}")
    } else {
        println("  âŒ ç‰ˆæœ¬ä¿¡æ¯è·å–å¤±è´¥: ${versionResult.getErr().getMessage()}")
    }

    println("ğŸ‰ APIå±‚æµ‹è¯•å®Œæˆï¼")
}
